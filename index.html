<!doctype html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="theme-color" content="#4A5568">
  <meta name="description" content="نظام مبيعات ومخزون احترافي متكامل">
  <meta name="keywords" content="نقطة بيع, مبيعات, مخزون, فواتير, إدارة, محاسبة, متجر">
  <meta property="og:type" content="website">
  <meta property="og:title" content="سوفت بلاكي  - نظام مبيعات ومخزون">
  <meta property="og:description" content="نظام مبيعات ومخزون احترافي متكامل مع تقارير ولوحة تحكم ونقطة بيع.">
  <meta property="og:image" content="favicon.svg">
  <meta property="og:locale" content="ar_SA">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="سوفت بلاكي ">
  <meta name="twitter:description" content="نظام مبيعات ومخزون احترافي متكامل.">
  <meta name="twitter:image" content="favicon.svg">

  <title>نظام المبيعات بلاكي - Pro </title>

  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">

  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="favicon.svg" type="image/svg+xml">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

  <style>
    :root {
      --bg: #F7FAFC;
      --card: #FFFFFF;
      --accent: #2D3748;
      --accent-light: #718096;
      --muted: #A0AEC0;
      --danger: #E53E3E;
      --success: #38A169;
      --warning: #ED8936;
      --info: #3182CE;
      --purple: #805AD5;
      --text: #2D3748;
      --border: #E2E8F0;
      --shadow-sm: 0 1px 2px 0 rgba(0,0,0,0.05);
      --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
      --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --gradient-success: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
      --gradient-danger: linear-gradient(135deg, #fc8181 0%, #e53e3e 100%);
      --gradient-info: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
      --gradient-warning: linear-gradient(135deg, #f6ad55 0%, #ed8936 100%);
    }
    .dark-theme {
      --bg: #1A202C;
      --card: #2D3748;
      --accent: #A0AEC0;
      --accent-light: #E2E8F0;
      --muted: #718096;
      --danger: #FC8181;
      --success: #68D391;
      --warning: #F6AD55;
      --info: #63B3ED;
      --purple: #B794F4;
      --text: #E2E8F0;
      --border: #4A5568;
      --shadow-sm: 0 1px 2px 0 rgba(0,0,0,0.3);
      --shadow: 0 4px 6px -1px rgba(0,0,0,0.4), 0 2px 4px -1px rgba(0,0,0,0.3);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.5), 0 4px 6px -2px rgba(0,0,0,0.3);
      --shadow-xl: 0 20px 25px -5px rgba(0,0,0,0.6), 0 10px 10px -5px rgba(0,0,0,0.4);
    }

    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Cairo', sans-serif;
      background: var(--bg);
      color: var(--text);
      transition: background 0.3s, color 0.3s;
      line-height: 1.6;
    }

    .app {
      display: flex;
      min-height: 100vh
    }

    /* Sidebar */
    .sidebar {
      width: 270px;
      background: linear-gradient(180deg, #1A202C 0%, #2D3748 100%);
      color: #fff;
      padding: 20px;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      box-shadow: 4px 0 15px rgba(0, 0, 0, 0.15);
      position: sticky;
      top: 0;
      height: 100vh;
      overflow-y: auto;
    }

    .brand {
      font-weight: 900;
      font-size: 1.4rem;
      margin-bottom: 25px;
      text-align: center;
      color: var(--accent-light);
      padding: 18px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      border: 2px solid rgba(255, 255, 255, 0.1);
    }

    .nav {
      list-style: none;
      padding: 0;
      margin: 0;
      flex-grow: 1;
      overflow-y: auto;
    }

    .nav li {
      padding: 13px 14px;
      border-radius: 10px;
      cursor: pointer;
      margin-bottom: 7px;
      display: flex;
      align-items: center;
      gap: 12px;
      transition: all 0.2s;
      position: relative;
      font-size: 0.95rem;
    }

    .nav li:hover {
      background: rgba(255, 255, 255, 0.1)
    }

    .nav li.active {
      background: rgba(255, 255, 255, 0.15);
      font-weight: 700;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .nav li.active::before {
      content: '';
      position: absolute;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 4px;
      height: 70%;
      background: linear-gradient(to bottom, var(--success), var(--info));
      border-radius: 2px;
    }

    .nav-icon {
      width: 22px;
      height: 22px;
      color: var(--accent-light);
    }
    
    .nav-icon svg {
        width: 22px;
        height: 22px;
    }

    .user-switcher {
      margin-top: auto;
      padding-top: 15px;
      border-top: 2px solid rgba(255, 255, 255, 0.1);
    }

    .user-switcher .form-group {
      margin: 0;
    }

    .user-switcher select {
      background: #4A5568;
      color: white;
      border: 2px solid #718096;
      padding: 10px;
      font-weight: 600;
      width: 100%;
    }

    /* Toast Notification */
    .notification-toast {
      position: fixed;
      top: 20px;
      left: 20px;
      background: var(--card);
      padding: 16px 20px;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      border-right: 4px solid var(--success);
      z-index: 10000;
      animation: slideInLeft 0.4s ease;
      max-width: 350px;
      display: none;
    }

    .notification-toast.show {
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }

    .notification-toast.error {
      border-right-color: var(--danger);
    }

    @keyframes slideInLeft {
      from {
        transform: translateX(-400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* Barcode / QR Code */
    .barcode-display {
      text-align: center;
      padding: 20px;
      background: white;
      border-radius: 12px;
    }
    .barcode-display svg,
    .barcode-display canvas {
        max-width: 100%;
    }


    /* WhatsApp Button */
    .whatsapp-btn {
      background: #25D366;
      color: white;
    }

    .whatsapp-btn:hover {
      background: #128C7E;
    }

    /* Pulse animation */
    @keyframes pulse {
      0%,
      100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
    }

    .pulse {
      animation: pulse 2s infinite;
    }

    /* Added item animation */
    @keyframes added-burst {
      0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(79,70,229,.0); }
      40% { transform: scale(1.03); box-shadow: 0 10px 24px rgba(79,70,229,.25); }
      100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(79,70,229,.0); }
    }
    .added-burst { animation: added-burst .6s ease; }

    /* Respect user preference: reduce motion */
    @media (prefers-reduced-motion: reduce) {
      * { animation-duration: 0.001ms !important; animation-iteration-count: 1 !important; transition-duration: 0.001ms !important; scroll-behavior: auto !important; }
    }

    /* Main Content */
    main {
      flex: 1;
      padding: 28px;
      overflow-x: hidden;
      background: var(--bg);
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      gap: 15px;
      background: var(--card);
      padding: 18px 24px;
      border-radius: 14px;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.06);
      position: sticky;
      top: 0;
      z-index: 996;
      backdrop-filter: saturate(120%) blur(4px);
      -webkit-backdrop-filter: saturate(120%) blur(4px);
      border: 1px solid var(--border);
    }

    .card {
      background: var(--card);
      padding: 26px;
      border-radius: 14px;
      box-shadow: var(--shadow);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid var(--border);
    }
    .card:hover {
      box-shadow: var(--shadow-lg);
      transform: translateY(-2px);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(270px, 1fr));
      gap: 18px
    }

    h2,
    h3,
    h4 {
      color: var(--text);
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    h2 {
      font-size: 1.9rem;
      margin-bottom: 20px;
    }

    h3 {
      font-size: 1.4rem;
      margin-bottom: 15px;
    }

    h4 {
      font-size: 1.1rem;
      margin-bottom: 12px;
    }

    /* Tables */
    .table-container {
      overflow-x: auto;
      border-radius: 10px;
      border: 1px solid var(--border);
      margin-top: 15px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th,
    td {
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      text-align: right;
      vertical-align: middle;
    }

    th {
      font-weight: 700;
      font-size: 0.85rem;
      color: var(--muted);
      background: var(--bg);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    tbody tr {
      transition: background 0.2s;
    }

    tbody tr:hover {
      background: rgba(74, 85, 104, 0.06);
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 11px 20px;
      border-radius: 10px;
      background: var(--accent);
      color: #fff;
      text-decoration: none;
      cursor: pointer;
      border: none;
      font-family: 'Cairo', sans-serif;
      font-weight: 600;
      transition: all 0.25s;
      font-size: 0.9rem;
      white-space: nowrap;
    }
    
    .btn svg {
        width: 16px;
        height: 16px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(74, 85, 104, 0.35);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn.ghost {
      background: transparent;
      color: var(--accent);
      border: 2px solid var(--accent);
    }

    .btn.ghost:hover {
      background: var(--accent);
      color: white;
    }

    .btn.danger {
      background: var(--danger);
    }

    .btn.danger:hover {
      box-shadow: 0 6px 16px rgba(229, 62, 62, 0.35);
    }

    .btn.success {
      background: var(--success);
    }

    .btn.success:hover {
      box-shadow: 0 6px 16px rgba(56, 161, 105, 0.35);
    }

    .btn.warning {
      background: var(--warning);
      color: white;
    }

    .btn.info {
      background: var(--info);
      color: white;
    }

    .btn.purple {
      background: var(--purple);
      color: white;
    }

    .btn.xs {
      padding: 6px 12px;
      font-size: 0.8rem;
    }

    .btn.sm {
      padding: 9px 16px;
      font-size: 0.85rem;
    }

    .btn.lg {
      padding: 15px 28px;
      font-size: 1.1rem;
    }

    .btn.icon {
      padding: 10px;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* Chips & Badges */
    .chip {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 5px 12px;
      border-radius: 999px;
      background: var(--bg);
      color: var(--accent);
      border: 1px solid var(--border);
      font-size: 0.8rem;
      font-weight: 600;
    }

    .chip.success {
      background: var(--success);
      color: white;
      border-color: var(--success);
    }

    .chip.danger {
      background: var(--danger);
      color: white;
      border-color: var(--danger);
    }

    .chip.warning {
      background: var(--warning);
      color: white;
      border-color: var(--warning);
    }

    .chip.info {
      background: var(--info);
      color: white;
      border-color: var(--info);
    }

    .chip.purple {
      background: var(--purple);
      color: white;
      border-color: var(--purple);
    }

    .muted {
      color: var(--muted);
      font-size: 0.9rem;
    }

    .hr {
      height: 1px;
      background: var(--border);
      margin: 18px 0;
    }

    /* Page Transitions */
    #page-content > div {
      display: none;
      animation: fadeIn 0.4s ease-in-out;
    }

    #page-content > div.active {
      display: block
    }


    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(15px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* POS Specific */
    .pos .layout {
      display: grid;
      grid-template-columns: 1fr 420px;
      gap: 18px;
    }

    .pos .products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 15px;
    }
    .pos .products-container {
      border: 1px solid var(--border);
      padding: 18px;
      border-radius: 14px;
      max-height: 72vh;
      overflow: auto;
      background: var(--bg);
    }

    .prod {
      background: var(--card);
      border: 2px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.25s;
      position: relative;
      overflow: hidden;
      text-align: center;
    }

    .prod::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, var(--success), var(--info));
      opacity: 0;
      transition: opacity 0.3s;
    }

    .prod:hover::before {
      opacity: 0.08;
    }

    .prod:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 24px rgba(74, 85, 104, 0.2);
      border-color: var(--accent);
    }

    .prod-title {
      font-weight: 700;
      margin-bottom: 10px;
      font-size: 0.9rem;
      position: relative;
      z-index: 1;
    }

    .prod-price {
      color: var(--success);
      font-weight: 900;
      font-size: 1.1rem;
      position: relative;
      z-index: 1;
    }

    .prod-stock {
      position: absolute;
      top: 10px;
      left: 10px;
      font-size: 0.75rem;
      z-index: 2;
    }

    .pos .cart-container {
       max-height: 50vh; overflow: auto; padding-right: 10px;
    }
    
    .pos .cart-item {
      display: grid;
      grid-template-columns: 1fr 120px 40px;
      gap: 10px;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px dashed var(--border);
      font-size: 0.9rem;
    }

    .qty-control {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      justify-content: center;
    }

    .qty-control button {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .totals {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 8px 15px;
      background: var(--bg);
      padding: 15px;
      border-radius: 10px;
      margin: 15px 0;
    }
    
    .totals div:nth-child(odd) { font-weight: 600; }
    .totals div:nth-child(even) { text-align: left; font-weight: 700;}

    .totals-row.final {
      grid-column: 1 / -1;
      font-size: 1.35rem;
      font-weight: 900;
      background: var(--accent);
      color: white;
      padding: 12px;
      margin-top: 10px;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
    }
    
    .barcode-scanner input {
      font-size: 1.05rem;
      padding: 14px;
      text-align: center;
      border: 2px dashed var(--accent);
      background: var(--card);
      border-radius: 12px;
      font-weight: 600;
    }
    
    .payment-buttons {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.75);
      backdrop-filter: blur(4px);
      z-index: 999;
      display: none;
      justify-content: center;
      align-items: center;
      padding: 25px;
      animation: fadeIn 0.3s;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: var(--card);
      padding: 35px;
      border-radius: 18px;
      width: 100%;
      max-width: 850px;
      position: relative;
      max-height: 90vh;
      overflow-y: auto;
      animation: scaleIn 0.35s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      box-shadow: 0 25px 70px rgba(0, 0, 0, 0.35);
    }

    @keyframes scaleIn {
      from {
        transform: scale(0.92);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    .modal-close {
      position: absolute;
      top: 18px;
      left: 18px;
      background: var(--danger);
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      font-size: 22px;
      cursor: pointer;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.25s;
      font-weight: 700;
    }

    .modal-close:hover {
      transform: rotate(90deg) scale(1.15);
      box-shadow: 0 4px 12px rgba(229, 62, 62, 0.4);
    }

    /* Forms */
    .form-row {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 14px;
    }

    .col-12 {
      grid-column: span 12;
    }

    .col-6 {
      grid-column: span 6;
    }

    .col-4 {
      grid-column: span 4;
    }

    .col-3 {
      grid-column: span 3;
    }

    .col-8 {
      grid-column: span 8;
    }

    .col-9 {
      grid-column: span 9;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      margin-bottom: 7px;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text);
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 11px 14px;
      border-radius: 10px;
      border: 2px solid var(--border);
      background: var(--bg);
      color: var(--text);
      font-family: 'Cairo', sans-serif;
      transition: all 0.2s;
      font-size: 0.95rem;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      border-color: var(--accent);
      outline: none;
      box-shadow: 0 0 0 4px rgba(74, 85, 104, 0.12);
    }

    .form-group input:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Toast */
    #toast {
      visibility: hidden;
      min-width: 320px;
      background-color: #1A202C;
      color: #fff;
      text-align: center;
      border-radius: 12px;
      padding: 18px 28px;
      position: fixed;
      z-index: 10000;
      left: 50%;
      transform: translateX(-50%);
      bottom: 30px;
      transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      opacity: 0;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
      font-weight: 600;
      font-size: 0.95rem;
    }

    #toast.show {
      visibility: visible;
      opacity: 1;
      bottom: 55px;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 70px 45px;
      border: 2px dashed var(--border);
      border-radius: 18px;
      background: var(--bg);
    }

    .empty-state .icon {
      font-size: 5.5rem;
      color: var(--muted);
      margin-bottom: 24px;
      opacity: 0.5;
    }

    .empty-state h3 {
      color: var(--muted);
      margin-bottom: 12px;
    }

    /* Spinner */
    .spinner {
      border: 5px solid var(--border);
      border-top: 5px solid var(--accent);
      border-radius: 50%;
      width: 55px;
      height: 55px;
      animation: spin 1s linear infinite;
      margin: 50px auto;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }

    /* Stats Cards */
    .stat-card {
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -20%;
      width: 160px;
      height: 160px;
      background: var(--accent);
      opacity: 0.06;
      border-radius: 50%;
    }

    .stat-value {
      font-size: 2.2rem;
      font-weight: 900;
      margin: 12px 0;
      line-height: 1;
    }

    .stat-label {
      font-size: 0.85rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }
    /* Stat card accent variants */
    .stat-card.success-light { border-left: 4px solid var(--success); }
    .stat-card.info-light { border-left: 4px solid var(--info); }
    .stat-card.danger-light { border-left: 4px solid var(--danger); }
    .stat-card.purple-light { border-left: 4px solid var(--accent); }
    .dark-theme .stat-card::before { opacity: .12; }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 6px;
      border-bottom: 2px solid var(--border);
      margin-bottom: 24px;
      overflow-x: auto;
    }

    .tab {
      padding: 14px 24px;
      cursor: pointer;
      border: none;
      background: transparent;
      color: var(--muted);
      font-family: 'Cairo', sans-serif;
      font-weight: 600;
      transition: all 0.2s;
      border-bottom: 3px solid transparent;
      white-space: nowrap;
      font-size: 0.95rem;
    }

    .tab:hover {
      color: var(--accent);
      background: rgba(74, 85, 104, 0.05);
    }

    .tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
      background: rgba(74, 85, 104, 0.08);
    }

    /* Progress Bar */
    .progress {
      height: 10px;
      background: var(--border);
      border-radius: 10px;
      overflow: hidden;
      margin: 10px 0;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(to right, var(--success), var(--info));
      transition: width 0.3s;
      border-radius: 10px;
    }

    /* Utilities */
    .text-center {
      text-align: center;
    }

    .text-right {
      text-align: right;
    }

    .text-left {
      text-align: left;
    }

    .space-between {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .flex-center {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .flex-wrap {
      flex-wrap: wrap;
    }

    .nowrap {
      white-space: nowrap;
    }

    .mb-5 { margin-bottom: 5px; }
    .mb-10 { margin-bottom: 10px; }
    .mb-15 { margin-bottom: 15px; }
    .mb-20 { margin-bottom: 20px; }
    .mb-30 { margin-bottom: 30px; }
    .mt-5 { margin-top: 5px; }
    .mt-10 { margin-top: 10px; }
    .mt-15 { margin-top: 15px; }
    .mt-20 { margin-top: 20px; }
    .mt-30 { margin-top: 30px; }
    .p-10 { padding: 10px; }
    .p-15 { padding: 15px; }
    .p-20 { padding: 20px; }

    .muted-small { color: var(--muted); font-size: 0.8rem; }
    .fw-900 { font-weight: 900; }
    .fw-700 { font-weight: 700; }
    .fw-600 { font-weight: 600; }
    .fs-small { font-size: 0.85rem; }
    .fs-large { font-size: 1.2rem; }

    /* Print Styles */
    #invoice-print-area { display: none; }
    @media print {
      @page { size: A4; margin: 12mm; }
      body * { visibility: hidden; }
      #invoice-print-area, #invoice-print-area * { visibility: visible; }
      #invoice-print-area { display: block !important; position: absolute; left: 0; top: 0; width: 100%; }
      #invoice-print-area h3, #invoice-print-area h4 { margin: 6px 0; }
      #invoice-print-area table { width: 100%; border-collapse: collapse; font-size: 12px; }
      #invoice-print-area th, #invoice-print-area td { border: 1px solid #ccc; padding: 6px; }
      .no-print { display: none !important; }
      .card { box-shadow: none; border: 1px solid #ddd; }
      body { background: white; color: black; }
    }


    /* Responsive */
    @media (max-width: 1200px) {
      .pos .layout {
        grid-template-columns: 1fr 360px;
      }
    }

    @media (max-width: 1024px) {
      .pos .layout {
        grid-template-columns: 1fr;
      }
      .sidebar {
        width: 240px;
      }
    }

    @media (max-width: 768px) {
      .sidebar {
        position: fixed;
        right: -280px;
        z-index: 998;
        transition: right 0.3s;
      }
      .sidebar.active {
        right: 0;
      }
      main {
        padding: 18px;
      }
      .grid {
        grid-template-columns: 1fr;
      }
      .form-row {
        grid-template-columns: 1fr;
      }
      .col-12,
      .col-6,
      .col-4,
      .col-3,
      .col-8,
      .col-9 {
        grid-column: span 12;
      }
      .topbar {
        flex-direction: column;
        align-items: flex-start;
      }
      #menu-toggle {
        display: inline-flex !important;
      }
    }
  /* Skip link */
  .skip-link {
    position: absolute;
    top: -100px;
    right: 10px;
    background: var(--accent);
    color: #fff;
    padding: 8px 12px;
    border-radius: 8px;
    box-shadow: 0 6px 16px rgba(0,0,0,.15);
    text-decoration: none;
    transition: top .2s ease;
    z-index: 9999;
  }
  .skip-link:focus { top: 10px; }
  /* ===== PHASE 1 REDESIGN: Modern theme, states, tables, POS, login ===== */
  :root {
    --bg: #f6f8fb;
    --card: #ffffff;
    --text: #1f2937;
    --muted: #6b7280;
    --border: #e5e7eb;
    --accent: #4F46E5;
    --accent-light: #818CF8;
    --success: #10B981;
    --warning: #F59E0B;
    --danger:  #EF4444;
    --info:    #3B82F6;
    --ring: #C7D2FE;
    --shadow: rgba(17, 24, 39, 0.08);
    --shadow-strong: rgba(17, 24, 39, 0.14);
  }
  .dark-theme {
    --bg: #0f172a;
    --card: #111827;
    --text: #e5e7eb;
    --muted: #9ca3af;
    --border: #1f2937;
    --accent: #6366F1;
    --accent-light: #A5B4FC;
    --success: #34D399;
    --warning: #FBBF24;
    --danger:  #F87171;
    --info:    #60A5FA;
    --ring: rgba(99, 102, 241, 0.35);
    --shadow: rgba(0, 0, 0, 0.35);
    --shadow-strong: rgba(0, 0, 0, 0.5);
  }
  .card {
    border: 1px solid var(--border);
    border-radius: 14px;
    background: var(--card);
    box-shadow: 0 8px 24px var(--shadow);
  }
  .card:hover {
    box-shadow: 0 16px 48px var(--shadow-strong);
    transform: translateY(-1px);
    transition: all .25s ease;
  }
  .btn {
    transition: transform .15s ease, box-shadow .2s ease, background .2s ease, color .2s ease, border-color .2s ease;
    border-radius: 10px;
    box-shadow: 0 6px 16px rgba(79, 70, 229, 0.12);
  }
  .btn:hover { transform: translateY(-1px); box-shadow: 0 10px 22px rgba(79,70,229,.18); }
  .btn:active { transform: translateY(0); box-shadow: 0 4px 10px rgba(0,0,0,.08); }
  .btn.ghost { border: 2px solid var(--accent); color: var(--accent); }
  .btn.ghost:hover { background: var(--accent); color: #fff; }
  .btn.success { background: var(--success); }
  .btn.success:hover { box-shadow: 0 8px 22px rgba(16,185,129,.25); }
  .btn.danger { background: var(--danger); }
  .btn.danger:hover { box-shadow: 0 8px 22px rgba(239,68,68,.25); }
  .btn.info { background: var(--info); }
  .btn.info:hover { box-shadow: 0 8px 22px rgba(59,130,246,.25); }
  .btn.purple { background: var(--accent); }
  .form-group input,
  .form-group select,
  .form-group textarea {
    background: var(--bg);
    border: 2px solid var(--border);
    border-radius: 10px;
    transition: border-color .2s ease, box-shadow .2s ease, background .2s ease;
  }
  .form-group input:focus,
  .form-group select:focus,
  .form-group textarea:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 4px var(--ring);
    background: #fff;
  }
  .topbar { border: 1px solid var(--border); background: var(--card); box-shadow: 0 4px 14px var(--shadow); }
  .table-container { border: 1px solid var(--border); border-radius: 10px; overflow: auto; max-height: 70vh; }
  .table-container table thead th { position: sticky; top: 0; z-index: 1; background: var(--bg); border-bottom: 1px solid var(--border); }
  .table-container table tbody tr:nth-child(even) { background: rgba(17,24,39,.02); }
  .table-container table tbody tr:hover { background: rgba(79,70,229,.08); }
  .chip { border-radius: 999px; border: 1px solid var(--border); background: rgba(17,24,39,.03); }
  .chip.success { background: var(--success); border-color: var(--success); color: #fff; }
  .chip.danger  { background: var(--danger);  border-color: var(--danger);  color: #fff; }
  .chip.warning { background: var(--warning); border-color: var(--warning); color: #fff; }
  .chip.info    { background: var(--info);    border-color: var(--info);    color: #fff; }
  .chip.purple  { background: var(--accent);  border-color: var(--accent);  color: #fff; }
  .pager { padding: 10px 12px; border-top: 1px solid var(--border); background: var(--card); }
  .pager .btn { padding: 8px 14px; }
  .pager .btn[disabled] { opacity: .5; cursor: not-allowed; box-shadow: none; transform: none; }
  .pager .muted { color: var(--muted); }
  .pos .products-container { background: var(--bg); border: 1px solid var(--border); border-radius: 14px; box-shadow: 0 6px 18px var(--shadow); }
  .prod { border: 1px solid var(--border); transition: transform .2s ease, box-shadow .25s ease, border-color .2s ease; }
  .prod .prod-title { font-weight: 800; letter-spacing: .2px; }
  .prod .prod-price { color: var(--success); font-weight: 900; font-size: 1.05rem; }
  .prod:hover { transform: translateY(-4px); border-color: var(--accent); box-shadow: 0 12px 32px var(--shadow-strong); }
  .prod .prod-stock { top: 8px; left: 8px; padding: 2px 8px; font-weight: 700; }
  .pos .totals { border: 1px dashed var(--border); border-radius: 12px; background: rgba(17,24,39,.03); }
  .pos .totals .final { background: linear-gradient(135deg, var(--accent), var(--accent-light)); color: #fff; border-radius: 10px; }
  .pos .pos-cart { position: sticky; top: 10px; align-self: start; }
  .payment-buttons .btn { padding: 14px; font-size: 1rem; }
  #pos-categories { gap: 8px; display: flex; flex-wrap: wrap; }
  #pos-categories .btn { border-radius: 999px; padding: 6px 14px; }
  #pos-categories .btn.active, #pos-categories .btn:hover { background: var(--accent); color: #fff; border-color: var(--accent); }
  #login-overlay .modal-content { border: 1px solid var(--border); border-radius: 16px; box-shadow: 0 20px 50px var(--shadow-strong); }
  #login-overlay h3 { display: flex; align-items: center; gap: 8px; }
  #login-overlay .btn.success { width: 100%; }
  #login-overlay .form-group input { background: #fff; }
  .tabs { border-bottom: 2px solid var(--border); }
  .tab { border-bottom: 3px solid transparent; color: var(--muted); transition: color .2s ease, background .2s ease, border-color .2s ease; }
  .tab:hover { color: var(--accent); background: rgba(79,70,229,.06); }
  .tab.active { color: var(--accent); border-bottom-color: var(--accent); background: rgba(79,70,229,.09); }
  .empty-state { border: 2px dashed var(--border); border-radius: 16px; background: rgba(17,24,39,.02); }
  .empty-state .icon { opacity: .65; }
  .notification-toast { border-right: 4px solid var(--accent); box-shadow: 0 12px 36px var(--shadow-strong); }
  .notification-toast.error { border-right-color: var(--danger); }
  .notification-toast .muted { color: var(--muted); }
  #welcome-user { font-weight: 800; }
  .sidebar { box-shadow: 4px 0 22px rgba(0,0,0,.25); }
  /* Search header count */
  .result-count { color: var(--muted); font-size: .85rem; margin-inline-start: 10px; }

  /* ===== POS Professional Layout Refinements ===== */
  .pos .layout { gap: 22px; }
  .barcode-scanner input {
    border: 2px dashed var(--accent);
    background: #fff;
    font-size: 1.1rem;
    padding: 16px;
    border-radius: 14px;
    box-shadow: 0 6px 16px var(--shadow);
    transition: border-color .2s ease, box-shadow .2s ease;
  }
  .barcode-scanner input:focus {
    border-color: var(--accent-light);
    box-shadow: 0 0 0 4px var(--ring);
  }
  /* POS cards/images */
  .products-grid { grid-auto-rows: 1fr; }
  .prod .prod-image img { width: 100%; height: 100%; object-fit: cover; display: block; }
  .prod .prod-title { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .prod .prod-price { font-variant-numeric: tabular-nums; }
  .pos .products-grid {
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 18px;
    padding: 18px 14px;
    border-radius: 14px;
    background: var(--card);
    backdrop-filter: saturate(120%) blur(2px);
  }
  @media (max-width: 640px) {
    .pos .products-grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); }
  }
  .prod .prod-title { margin: 6px 0 6px; font-size: .95rem; }
  .prod .prod-price { font-size: 1.1rem; }
  .prod .prod-stock { font-size: .72rem; }
  .prod .prod-stock.chip.info { background: linear-gradient(135deg, var(--info), #60a5fa); }
  .prod .prod-stock.chip.danger { background: linear-gradient(135deg, var(--danger), #fb7185); }
  .prod .prod-stock.chip { box-shadow: 0 4px 12px var(--shadow); }
  .prod.low-stock { border-color: var(--danger); box-shadow: 0 6px 18px rgba(239,68,68,.15); }
  .dark-theme .prod.low-stock { border-color: var(--danger); box-shadow: 0 6px 18px rgba(248,113,113,.2); }

  .pos .cart-container {
    max-height: 58vh;
    overflow: auto;
    padding-right: 6px;
  }
  /* Custom scrollbars */
  .pos .cart-container::-webkit-scrollbar,
  .table-container::-webkit-scrollbar,
  .products-container::-webkit-scrollbar { width: 8px; height: 8px; }
  .pos .cart-container::-webkit-scrollbar-thumb,
  .table-container::-webkit-scrollbar-thumb,
  .products-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 8px; }
  .dark-theme .pos .cart-container::-webkit-scrollbar-thumb,
  .dark-theme .table-container::-webkit-scrollbar-thumb,
  .dark-theme .products-container::-webkit-scrollbar-thumb { background: #334155; }

  .pos .cart-item {
    grid-template-columns: 1fr 150px 38px;
    gap: 12px;
  }
  .pos .cart-item:hover { background: rgba(17,24,39,.04); }
  .qty-control button {
    width: 32px; height: 32px; border-radius: 10px;
  }
  .qty-control span { min-width: 28px; text-align: center; font-weight: 700; }
  .pos .cart-item .btn.icon { border-radius: 10px; }

  /* Payment buttons responsive */
  .payment-buttons { grid-template-columns: 1fr 1fr; gap: 12px; }
  @media (max-width: 1024px) {
    .payment-buttons { grid-template-columns: 1fr; }
    .payment-buttons .btn { width: 100%; }
  }

  /* Totals footer stick inside cart */
  .pos .pos-cart { display: flex; flex-direction: column; }
  .pos .pos-cart .totals { margin-top: auto; }

  /* Category sidebar pills */
  #pos-categories button { justify-content: flex-start; }
  #pos-categories button.active, #pos-categories button:hover { background: var(--accent); color: #fff; border-color: var(--accent); }

  /* Glass cards enhancement */
  .card { backdrop-filter: saturate(120%) blur(1.5px); }

  /* Headings gradient for POS */
  .pos-page h2 { background: linear-gradient(90deg, var(--accent), var(--accent-light)); -webkit-background-clip: text; background-clip: text; color: transparent; }

  /* Dark theme tweaks for readability */
  .dark-theme .prod { background: #0b1220; border-color: #1f2a44; }
  .dark-theme .card { background: #0b1220; border-color: #1f2a44; }
  .dark-theme .table-container table thead th { background: #0b1220; }
  
  /* A11y: Focus styles */
  .btn:focus-visible,
  .tab:focus-visible,
  .nav li:focus-visible,
  .form-group input:focus-visible,
  .form-group select:focus-visible,
  .form-group textarea:focus-visible {
    outline: none;
    box-shadow: 0 0 0 4px var(--ring);
    border-color: var(--accent);
  }

  /* Mobile Sidebar Overlay (no JS changes) */
  .sidebar-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.4);
    backdrop-filter: blur(2px);
    z-index: 997;
  }
  @media (max-width: 768px) {
    .sidebar.active + .sidebar-overlay { display: block; }
  }
  </style>

</head>

<body>
  <a href="#page-content" class="skip-link">تخطي إلى المحتوى</a>

  <div id="notification-toast" class="notification-toast" role="status" aria-live="polite" aria-atomic="true">
    <span id="notif-icon" style="font-size:1.5rem;">✅</span>
    <div style="flex:1;">
      <div id="notif-title" style="font-weight:700; margin-bottom:4px;"></div>
      <div id="notif-message" style="font-size:0.9rem; color:var(--muted);"></div>
    </div>
    <button onclick="hideNotification()" style="background:none; border:none; cursor:pointer; font-size:1.2rem; color:var(--muted);">×</button>
  </div>

  <div id="toast" role="status" aria-live="polite" aria-atomic="true"></div>
  <div id="main-modal" class="modal-overlay">
    <div class="modal-content"></div>
  </div>

  <div class="app">
    <aside class="sidebar" id="sidebar" role="navigation" aria-label="التنقل الرئيسي">
      <div class="brand">⚡ سوفت بلاكي </div>
      <ul class="nav" id="mainNav"></ul>
      <div class="user-switcher">
        <div class="form-group">
          <label style="color: var(--accent-light); font-size: 0.75rem;">المستخدم الحالي</label>
          <select id="user-select" onchange="App.switchUser(this.value)"></select>
        </div>
      </div>
      <nav class="nav">
        <ul id="mainNav"></ul>
      </nav>
    </aside>
    <div class="sidebar-overlay" onclick="toggleSidebar()" aria-hidden="true"></div>

    <main role="main">
      <div class="topbar">
        <div style="display:flex; align-items:center; gap:15px;">
          <button class="btn icon ghost" id="menu-toggle" onclick="toggleSidebar()" style="display:none;" aria-label="فتح/إغلاق القائمة">☰</button>
          <div>
            <span class="muted fs-small">مرحبا،</span>
            <strong id="welcome-user" style="font-size:1.1rem;"></strong>
          </div>
        </div>
        <div style="display:flex; gap:10px; flex-wrap: wrap;">
          <button class="btn sm" onclick="UI.toggleTheme()" aria-label="تبديل الوضع" title="الوضع الليلي/النهاري">🌓</button>
          <button class="btn sm success" onclick="App.navigateTo('pos')" aria-label="فتح نقطة البيع" title="نقطة البيع">🛒</button>
          <button class="btn sm ghost" onclick="toggleQuickStats()" aria-label="عرض الإحصائيات السريعة" title="Ctrl+Shift+S">📊</button>
          <button class="btn sm info" onclick="App.navigateTo('vouchers')" aria-label="السندات والقبض" title="سندات القبض والدفع">📋</button>
          <button class="btn sm warning" onclick="openModal('cash-drawer')" aria-label="فتح الصندوق" title="الصندوق">💵</button>
          <button class="btn sm purple" onclick="toggleShortcuts()" aria-label="الاختصارات" title="اضغط ?">⌨️</button>
          <button class="btn sm" onclick="exportAllData()" aria-label="تصدير البيانات" title="Ctrl+Shift+E">⬇️</button>
          <button class="btn sm" onclick="importData()" aria-label="استيراد البيانات" title="Ctrl+Shift+I">⬆️</button>
          <button class="btn sm danger" onclick="logout()" aria-label="تسجيل الخروج">🚪</button>
        </div>
      </div>

      <div id="page-content">
          </div>
    </main>
  </div>
  
  <div id="invoice-print-area" style="display:none;"></div>

  <!-- Keyboard Shortcuts Helper -->
  <div id="shortcuts-overlay" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:10000; padding:40px;">
    <div style="max-width:800px; margin:0 auto; background:var(--card); border-radius:16px; padding:30px; max-height:90vh; overflow-y:auto;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2 style="margin:0;">⌨️ اختصارات لوحة المفاتيح</h2>
        <button onclick="toggleShortcuts()" style="background:none; border:none; font-size:24px; cursor:pointer;">✕</button>
      </div>
      <div class="form-row" style="gap:20px;">
        <div class="col-6">
          <h4>عام</h4>
          <div style="display:flex; flex-direction:column; gap:10px;">
            <div style="display:flex; justify-content:space-between; padding:10px; background:var(--bg); border-radius:8px;">
              <span>عرض الاختصارات</span>
              <kbd style="background:var(--card); padding:4px 8px; border-radius:4px; border:1px solid var(--border);">?</kbd>
            </div>
            <div style="display:flex; justify-content:space-between; padding:10px; background:var(--bg); border-radius:8px;">
              <span>البحث السريع</span>
              <kbd>Ctrl+K</kbd>
            </div>
            <div style="display:flex; justify-content:space-between; padding:10px; background:var(--bg); border-radius:8px;">
              <span>الإحصائيات السريعة</span>
              <kbd>Ctrl+Shift+S</kbd>
            </div>
          </div>
        </div>
        <div class="col-6">
          <h4>نقطة البيع</h4>
          <div style="display:flex; flex-direction:column; gap:10px;">
            <div style="display:flex; justify-content:space-between; padding:10px; background:var(--bg); border-radius:8px;">
              <span>دفع نقداً</span>
              <kbd>Enter</kbd>
            </div>
            <div style="display:flex; justify-content:space-between; padding:10px; background:var(--bg); border-radius:8px;">
              <span>إلغاء</span>
              <kbd>Esc</kbd>
            </div>
            <div style="display:flex; justify-content:space-between; padding:10px; background:var(--bg); border-radius:8px;">
              <span>تعليق</span>
              <kbd>Ctrl+H</kbd>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Stats Overlay -->
  <div id="quick-stats-overlay" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:10000; padding:40px;">
    <div style="max-width:1200px; margin:0 auto; background:var(--card); border-radius:16px; padding:30px; max-height:90vh; overflow-y:auto;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2 style="margin:0;">📊 إحصائيات سريعة</h2>
        <button onclick="toggleQuickStats()" style="background:none; border:none; font-size:24px; cursor:pointer;">✕</button>
      </div>
      <div id="quick-stats-content"></div>
    </div>
  </div>

  <!-- Login Overlay -->
  <div id="login-overlay" class="modal-overlay" style="display:none; background: rgba(0,0,0,0.6);">
    <div class="modal-content" style="max-width:420px;">
      <h3>تسجيل الدخول</h3>
      <div class="hr"></div>
      <div class="form-group">
        <label>المستخدم</label>
        <select id="login-user"></select>
      </div>
      <div class="form-group">
        <label>كلمة المرور</label>
        <input type="password" id="login-pass" placeholder="••••••••">
      </div>
      <div class="text-right"><button class="btn success" id="btn-login">دخول</button></div>
      <div id="login-error" class="muted" style="color:var(--danger); margin-top:8px; display:none;">بيانات الدخول غير صحيحة</div>
    </div>
  </div>

  <script>
    // ========== ICONS ==========
    const ICONS = {
      dashboard: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>`,
      pos: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>`,
      sales: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>`,
      returns: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>`,
      purchases: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path></svg>`,
      items: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>`,
      stock: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.89 1.45l8 4A2 2 0 0 1 22 7.24v9.53a2 2 0 0 1-1.11 1.79l-8 4a2 2 0 0 1-1.79 0l-8-4a2 2 0 0 1-1.1-1.8V7.24a2 2 0 0 1 1.11-1.79l8-4a2 2 0 0 1 1.78 0z"></path><polyline points="2.32 6.16 12 11 21.68 6.16"></polyline><line x1="12" y1="22.76" x2="12" y2="11"></line></svg>`,
      customers: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>`,
      suppliers: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="3" width="15" height="13"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle></svg>`,
      expenses: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>`,
      reports: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>`,
      activity: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>`,
      settings: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33 1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>`,
      plus: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>`,
      minus: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg>`,
      trash: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>`,
      edit: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>`,
      view: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>`,
      download: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>`,
      upload: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>`,
      print: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>`,
      chart: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="20" x2="12" y2="10"></line><line x1="18" y1="20" x2="18" y2="4"></line><line x1="6" y1="20" x2="6" y2="16"></line></svg>`,
      x: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`,
      info_circle: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>`,
      check_circle: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-8.58"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>`,
      alert_triangle: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>`,
    };

    // ======= PRINT: Receipts & Supplier Payments =======
    function printReceipt(rec){
        try{
            const area = document.getElementById('invoice-print-area');
            const settings = DataStore.load('settings', {});
            const header = settings.companyName || 'اسم المنشأة';
            const title = 'إيصال قبض #' + (rec.id||'');
            const allocHtml = Array.isArray(rec.allocations) && rec.allocations.length
              ? `<div class="hr" style="border-top:1px solid #ccc; margin:6px 0;"></div>
                 <div style="font-weight:700; margin-bottom:4px;">تفاصيل التخصيص</div>
                 <table style="width:100%; font-size:12px; border-collapse:collapse;">
                   <thead><tr><th style="text-align:right">رقم فاتورة</th><th style="text-align:left">المبلغ المخصص</th></tr></thead>
                   <tbody>
                     ${rec.allocations.map(a=>`<tr><td>#${a.invoiceId}</td><td style="text-align:left">${fmt(a.allocated||0)}</td></tr>`).join('')}
                   </tbody>
                 </table>`
              : '';
            area.innerHTML = `
              <div style="direction:rtl; font-family:'Cairo',sans-serif; max-width:320px;">
                <h3 style="text-align:center;">${header}</h3>
                <div style="text-align:center; font-size:14px; margin-top:-6px;">${title}</div>
                <div class="hr" style="border-top:1px solid #ccc; margin:6px 0;"></div>
                <div><strong>عميل:</strong> ${rec.customer}</div>
                <div><strong>تاريخ:</strong> ${rec.dateISO} ${rec.time||''}</div>
                <div><strong>طريقة الدفع:</strong> ${rec.paymentMethod==='card'?'بطاقة':'نقد'}</div>
                <div><strong>المبلغ:</strong> ${fmt(rec.amount)}</div>
                ${typeof rec.prevBalance!=='undefined' ? `<div><strong>الرصيد السابق:</strong> ${fmt(rec.prevBalance)}</div>` : ''}
                ${typeof rec.newBalance!=='undefined' ? `<div><strong>الرصيد الحالي:</strong> ${fmt(rec.newBalance)}</div>` : ''}
                ${rec.note? `<div><strong>ملاحظة:</strong> ${rec.note}</div>`:''}
                ${allocHtml}
                <div style="display:flex; justify-content:space-between; margin-top:10px; font-size:12px;">
                  <div>توقيع المستلم: __________</div>
                  <div>توقيع المحاسب: __________</div>
                </div>
                <div style="text-align:center; font-size:12px; margin-top:8px;">${settings.invoiceFooter||'شكراً لكم'}</div>
              </div>`;
            setTimeout(()=> window.print(), 50);
        }catch(e){ console.error(e); showNotification('خطأ','تعذر طباعة الإيصال.','error'); }
    }

    function printSupplierPayment(v){
        try{
            const area = document.getElementById('invoice-print-area');
            const settings = DataStore.load('settings', {});
            const header = settings.companyName || 'اسم المنشأة';
            const title = 'سند صرف #' + (v.id||'');
            const allocHtml = Array.isArray(v.allocations) && v.allocations.length
              ? `<div class="hr" style="border-top:1px solid #ccc; margin:6px 0;"></div>
                 <div style="font-weight:700; margin-bottom:4px;">تفاصيل التخصيص</div>
                 <table style="width:100%; font-size:12px; border-collapse:collapse;">
                   <thead><tr><th style="text-align:right">رقم فاتورة</th><th style="text-align:left">المبلغ المخصص</th></tr></thead>
                   <tbody>
                     ${v.allocations.map(a=>`<tr><td>#${a.invoiceId}</td><td style="text-align:left">${fmt(a.allocated||0)}</td></tr>`).join('')}
                   </tbody>
                 </table>`
              : '';
            area.innerHTML = `
              <div style="direction:rtl; font-family:'Cairo',sans-serif; max-width:320px;">
                <h3 style="text-align:center;">${header}</h3>
                <div style="text-align:center; font-size:14px; margin-top:-6px;">${title}</div>
                <div class="hr" style="border-top:1px solid #ccc; margin:6px 0;"></div>
                <div><strong>مورد:</strong> ${v.supplier}</div>
                <div><strong>تاريخ:</strong> ${v.dateISO} ${v.time||''}</div>
                <div><strong>طريقة الدفع:</strong> ${v.paymentMethod==='card'?'بطاقة':'نقد'}</div>
                <div><strong>المبلغ:</strong> ${fmt(v.amount)}</div>
                ${typeof v.prevBalance!=='undefined' ? `<div><strong>الرصيد السابق:</strong> ${fmt(v.prevBalance)}</div>` : ''}
                ${typeof v.newBalance!=='undefined' ? `<div><strong>الرصيد الحالي:</strong> ${fmt(v.newBalance)}</div>` : ''}
                ${v.note? `<div><strong>ملاحظة:</strong> ${v.note}</div>`:''}
                ${allocHtml}
                <div style="display:flex; justify-content:space-between; margin-top:10px; font-size:12px;">
                  <div>توقيع المستلم: __________</div>
                  <div>توقيع المحاسب: __________</div>
                </div>
                <div style="text-align:center; font-size:12px; margin-top:8px;">${settings.invoiceFooter||'مع التحية'}</div>
              </div>`;
            setTimeout(()=> window.print(), 50);
        }catch(e){ console.error(e); showNotification('خطأ','تعذر طباعة السند.','error'); }
    }

    // ========== NAVIGATION & DATA STRUCTURES ==========
    const PAGES = {
      dashboard: {
        label: "لوحة التحكم",
        icon: ICONS.dashboard,
        content: `
          <div class="dashboard-page" role="region" aria-labelledby="dashboard-title">
            <div class="space-between mb-20">
              <h2 id="dashboard-title" style="margin:0;"><div class="nav-icon">${ICONS.dashboard}</div> لوحة التحكم</h2>
              <div style="display:flex; gap:10px;">
                <button class="btn sm ghost" onclick="location.reload()" title="تحديث">🔄 تحديث</button>
                <button class="btn sm info" onclick="toggleQuickStats()" title="إحصائيات مفصلة">📈 تفاصيل</button>
              </div>
            </div>
            <div class="grid mb-30">
              <div class="card stat-card success-light" style="--accent:#38A169;">
                <div class="stat-label">مبيعات اليوم</div>
                <div class="stat-value" id="stat-sales-today">0.00 ر.س</div>
                <span class="muted-small">إجمالي الفواتير: <strong id="stat-invoices-today">0</strong></span>
              </div>
              <div class="card stat-card info-light" style="--accent:#3182CE;">
                <div class="stat-label">المخزون الحالي</div>
                <div class="stat-value" id="stat-stock-value">0.00 ر.س</div>
                <span class="muted-small">عدد الأصناف: <strong id="stat-products-count">0</strong></span>
              </div>
              <div class="card stat-card danger-light" style="--accent:#E53E3E;">
                <div class="stat-label">المصروفات الشهرية</div>
                <div class="stat-value" id="stat-expenses-month">0.00 ر.س</div>
                <span class="muted-small">آخر مصروف: <strong id="stat-last-expense">لا يوجد</strong></span>
              </div>
              <div class="card stat-card purple-light" style="--accent:#805AD5;">
                <div class="stat-label">العملاء الجدد (شهر)</div>
                <div class="stat-value" id="stat-new-customers">0</div>
                <span class="muted-small">إجمالي العملاء: <strong id="stat-total-customers">0</strong></span>
              </div>
            </div>

            <div class="space-between mb-15">
              <h3><div class="nav-icon">${ICONS.chart}</div> ملخص الأداء والتحليلات</h3>
              <button class="btn sm ghost" onclick="App.navigateTo('reports')">عرض جميع التقارير</button>
            </div>
            
            <div class="grid" style="grid-template-columns: 2fr 1fr; gap:20px; margin-bottom:20px;">
              <div class="card">
                <h4>📈 مبيعات الأشهر الستة الأخيرة</h4>
                <canvas id="salesChart" role="img" aria-label="مخطط يوضح إجمالي المبيعات للأشهر الستة الأخيرة"></canvas>
              </div>
              <div class="card">
                <h4>🟠 حالة المخزون</h4>
                <canvas id="stockChart" role="img" aria-label="مخطط دائري يوضح مستويات المخزون"></canvas>
              </div>
            </div>
            
            <!-- Top Performance Cards -->
            <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:15px; margin-bottom:20px;">
              <div class="card">
                <h4>🏆 أفضل 5 منتجات</h4>
                <div id="top-products-list" style="font-size:14px;"></div>
              </div>
              <div class="card">
                <h4>⭐ أفضل 5 عملاء</h4>
                <div id="top-customers-list" style="font-size:14px;"></div>
              </div>
              <div class="card">
                <h4>⚠️ تنبيهات المخزون</h4>
                <div id="stock-alerts-list" style="font-size:14px;"></div>
              </div>
            </div>
            
            <div class="hr"></div>

            <div class="space-between mb-15">
              <h3><div class="nav-icon">${ICONS.activity}</div> آخر الأنشطة</h3>
              <button class="btn sm ghost" onclick="App.navigateTo('activity')">عرض الكل</button>
            </div>
            
            <div class="card p-15" id="recent-activity-list">
              <p class="muted-small text-center">جاري تحميل سجل النشاط...</p>
            </div>
          </div>
        `,
        init: initializeDashboard
      },
      pos: {
        label: "نقطة البيع",
        icon: ICONS.pos,
        content: `
          <div class="pos-page" role="region" aria-labelledby="pos-title">
            <h2 id="pos-title"><div class="nav-icon">${ICONS.pos}</div> نقطة البيع</h2>
            <div class="layout" style="display:grid; grid-template-columns: 240px 1fr 420px; gap:22px;">
              <!-- Categories Sidebar -->
              <aside class="card" style="padding:16px;">
                <h4 style="margin-bottom:10px;">الفئات</h4>
                <div id="pos-categories" style="display:flex; flex-direction:column; gap:8px;"></div>
              </aside>

              <!-- Products Pane -->
              <section>
                <div class="card" role="search" aria-label="بحث المنتجات" style="margin-bottom:12px;">
                  <div class="form-row" style="display:grid; grid-template-columns: 1fr 280px 200px; gap:10px; align-items:center;">
                    <div class="form-group barcode-scanner" style="margin:0;">
                      <input type="text" id="barcode-input" placeholder="مسح الباركود أو إدخال رمز المنتج" aria-label="حقل مسح الباركود" autofocus>
                    </div>
                    <div class="form-group" style="margin:0;">
                      <input type="text" id="pos-search" placeholder="بحث عن منتج بالاسم أو الرمز" aria-label="بحث عن منتج" />
                    </div>
                    <div class="form-group" style="margin:0;">
                      <select id="pos-sort" style="width:100%">
                        <option value="recent">ترتيب: الأحدث</option>
                        <option value="price_asc">السعر: من الأقل للأعلى</option>
                        <option value="price_desc">السعر: من الأعلى للأقل</option>
                        <option value="stock_desc">المخزون: الأعلى أولاً</option>
                        <option value="name_asc">الاسم: أ-ي</option>
                        <option value="name_desc">الاسم: ي-أ</option>
                      </select>
                    </div>
                  </div>
                </div>
                <div class="products-container" id="pos-products-list">
                  <div class="products-grid"></div>
                </div>
              </section>

              <!-- Cart Pane -->
              <aside class="pos-cart card">
                <h3>سلة المبيعات</h3>
                <div class="form-group">
                    <label>العميل</label>
                    <select id="cart-customer-select">
                        <option value="cash">عميل نقدي</option>
                    </select>
                </div>
                <div class="cart-container" id="pos-cart-items" role="region" aria-live="polite" aria-label="عناصر السلة">
                  <div class="empty-state p-20" style="padding: 20px 0;">
                    <span class="icon" style="font-size: 3rem;">🛒</span>
                    <h4 style="margin-bottom: 5px;">السلة فارغة</h4>
                    <p class="muted-small">ابدأ بإضافة المنتجات بالمسح أو الضغط عليها</p>
                  </div>
                </div>
                <div class="totals" id="pos-totals">
                  <div>الإجمالي الفرعي:</div>
                  <div id="subtotal-amount" aria-live="polite">0.00 ر.س</div>
                  <div>الخصم:</div>
                  <div id="discount-amount" aria-live="polite">0.00 ر.س</div>
                  <div>ضريبة القيمة المضافة (15%):</div>
                  <div id="tax-amount" aria-live="polite">0.00 ر.س</div>
                  <div class="totals-row final">
                    <span>الإجمالي النهائي:</span>
                    <span id="final-total-amount" aria-live="polite">0.00 ر.س</span>
                  </div>
                </div>
                <div class="payment-buttons">
                    <button class="btn lg success" id="btn-process-cash" disabled>${ICONS.print} دفع نقداً</button>
                    <button class="btn lg info" id="btn-process-card" disabled>دفع بالبطاقة</button>
                    <button class="btn lg warning" id="btn-process-credit" disabled>بيع آجل</button>
                    <button class="btn ghost danger" id="btn-cancel-sale">إلغاء</button>
                    <button class="btn ghost" id="btn-hold-sale">تعليق</button>
                </div>
              </aside>
            </div>
          </div>
        `,
        init: initializePOS
      },
      sales: {
        label: "المبيعات",
        icon: ICONS.sales,
        content: `
          <div class="sales-page" role="region" aria-labelledby="sales-title">
            <h2 id="sales-title"><div class="nav-icon">${ICONS.sales}</div> إدارة فواتير المبيعات</h2>
            <div class="card">
              <div class="space-between mb-20">
                <input type="text" placeholder="بحث بالرقم أو العميل..." style="width: 300px; padding: 10px; border-radius: 8px; border: 1px solid var(--border);" aria-label="بحث في الفواتير">
                <div style="display:flex; gap:8px;">
                  <button class="btn ghost" onclick="exportSalesToExcel()">${ICONS.download} تصدير Excel</button>
                  <button class="btn success" onclick="openModal('new-sale')">${ICONS.plus} فاتورة جديدة</button>
                </div>
              </div>
              <div class="table-container">
                <table id="sales-table" role="table" aria-label="جدول فواتير المبيعات">
                  <thead>
                    <tr>
                      <th scope="col">رقم الفاتورة</th>
                      <th scope="col">العميل</th>
                      <th scope="col">تاريخ</th>
                      <th scope="col">الحالة</th>
                      <th scope="col">الإجمالي</th>
                      <th scope="col">الإجراءات</th>
                    </tr>
                  </thead>
                  <tbody>
                    </tbody>
                </table>
              </div>
            </div>
          </div>
        `,
        init: initializeSales
      },
      returns: {
        label: "المرتجعات",
        icon: ICONS.returns,
        content: `
          <div class="returns-page">
            <h2><div class="nav-icon">${ICONS.returns}</div> مرتجعات المبيعات والمشتريات</h2>
            <div class="card">
              <div class="tabs">
                <button class="tab active" onclick="switchReturnTab('sales-returns', this)">مرتجعات المبيعات</button>
                <button class="tab" onclick="switchReturnTab('purchase-returns', this)">مرتجعات المشتريات</button>
              </div>
              
              <div id="sales-returns" class="tab-content active">
                <div class="space-between mb-20">
                  <input type="text" placeholder="بحث برقم فاتورة المبيعات..." style="width: 300px; padding: 10px; border-radius: 8px; border: 1px solid var(--border);">
                  <button class="btn warning" onclick="openModal('new-sale-return')">${ICONS.plus} تسجيل مرتجع بيع</button>
                </div>
                <div class="table-container">
                  <table id="sales-returns-table">
                    <thead>
                      <tr>
                        <th>رقم الإرجاع</th>
                        <th>فاتورة الأصل</th>
                        <th>العميل</th>
                        <th>تاريخ</th>
                        <th>المبلغ المرتجع</th>
                        <th>الإجراءات</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>

              <div id="purchase-returns" class="tab-content" style="display: none;">
                </div>
            </div>
          </div>
        `,
        init: initializeReturns
      },
      purchases: {
        label: "المشتريات",
        icon: ICONS.purchases,
        content: `
          <div class="purchases-page">
            <h2><div class="nav-icon">${ICONS.purchases}</div> إدارة فواتير المشتريات</h2>
            <div class="card">
              <div class="space-between mb-20">
                <input type="text" placeholder="بحث بالرقم أو المورد..." style="width: 300px; padding: 10px; border-radius: 8px; border: 1px solid var(--border);">
                <div style="display:flex; gap:8px;">
                  <button class="btn purple" onclick="openModal('new-purchase')">${ICONS.plus} فاتورة شراء</button>
                  <button class="btn danger" onclick="openModal('make-payment')">➖ دفع</button>
                </div>
              </div>
              <div class="table-container">
                <table id="purchases-table">
                  <thead>
                    <tr>
                      <th>رقم الفاتورة</th>
                      <th>المورد</th>
                      <th>تاريخ</th>
                      <th>الحالة</th>
                      <th>الإجمالي</th>
                      <th>الإجراءات</th>
                    </tr>
                  </thead>
                  <tbody>
                    </tbody>
                </table>
              </div>
            </div>
          </div>
        `,
        init: initializePurchases
      },
      items: {
        label: "المنتجات",
        icon: ICONS.items,
        content: `
          <div class="items-page">
            <h2><div class="nav-icon">${ICONS.items}</div> إدارة الأصناف والمنتجات</h2>
            <div class="card">
              <div class="space-between mb-20">
                <input type="text" id="item-search" placeholder="بحث بالاسم أو الرمز..." style="width: 300px; padding: 10px; border-radius: 8px; border: 1px solid var(--border);">
                <div style="display: flex; gap: 10px;">
                    <button class="btn info" onclick="openModal('import-items')">${ICONS.upload} استيراد</button>
                    <button class="btn" onclick="openModal('export-items')">${ICONS.download} تصدير</button>
                    <button class="btn success" onclick="openModal('new-item')">${ICONS.plus} إضافة صنف جديد</button>
                </div>
              </div>
              
              <div class="table-container">
                <table id="items-table">
                  <thead>
                    <tr>
                      <th>الرمز (SKU)</th>
                      <th>اسم الصنف</th>
                      <th>الوحدة</th>
                      <th>سعر البيع</th>
                      <th>الكمية الحالية</th>
                      <th>الإجراءات</th>
                    </tr>
                  </thead>
                  <tbody>
                    </tbody>
                </table>
              </div>
            </div>
          </div>
        `,
        init: initializeItems
      },
      stock: {
        label: "المخزون",
        icon: ICONS.stock,
        content: `
          <div class="stock-page">
            <h2><div class="nav-icon">${ICONS.stock}</div> حركة المخزون والجرد</h2>
            <div class="card">
              <div class="tabs">
                <button class="tab active" onclick="switchStockTab('stock-levels', this)">مستويات المخزون</button>
                <button class="tab" onclick="switchStockTab('stock-adjustment', this)">تسويات الجرد</button>
              </div>
              
              <div id="stock-levels" class="tab-content active">
                <div class="space-between mb-20">
                  <input type="text" placeholder="بحث باسم الصنف..." style="width: 300px; padding: 10px; border-radius: 8px; border: 1px solid var(--border);">
                  <button class="btn" onclick="openModal('print-barcodes')">${ICONS.print} طباعة باركود</button>
                </div>
                <div class="table-container">
                  <table id="stock-levels-table">
                    <thead>
                      <tr>
                        <th>الرمز (SKU)</th>
                        <th>اسم الصنف</th>
                        <th>الكمية الحالية</th>
                        <th>قيمة المخزون</th>
                        <th>حد إعادة الطلب</th>
                        <th>الحالة</th>
                        <th>الإجراءات</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>

              <div id="stock-adjustment" class="tab-content" style="display: none;">
                <div class="space-between mb-20">
                    <input type="text" placeholder="بحث باسم الصنف..." style="width: 300px; padding: 10px; border-radius: 8px; border: 1px solid var(--border);">
                    <button class="btn warning" onclick="openModal('new-adjustment')">${ICONS.plus} تسوية جديدة</button>
                </div>
                <div class="table-container">
                    <table id="adjustment-history-table">
                        <thead>
                            <tr>
                                <th>رقم التسوية</th>
                                <th>التاريخ</th>
                                <th>النوع</th>
                                <th>الكمية الإجمالية</th>
                                <th>الملاحظات</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
              </div>
            </div>
          </div>
        `,
        init: initializeStock
      },
      customers: {
        label: "العملاء",
        icon: ICONS.customers,
        content: `
          <div class="customers-page">
            <h2><div class="nav-icon">${ICONS.customers}</div> إدارة بيانات العملاء</h2>
            <div class="card">
              <div class="space-between mb-20">
                <input type="text" placeholder="بحث بالاسم أو الهاتف..." style="width: 300px; padding: 10px; border-radius: 8px; border: 1px solid var(--border);">
                <div style="display:flex; gap:8px;">
                  <button class="btn info" onclick="openModal('new-customer')">${ICONS.plus} إضافة عميل</button>
                  <button class="btn success" onclick="openModal('receive-payment')">➕ قبض</button>
                </div>
              </div>
              <div class="table-container">
                <table id="customers-table">
                  <thead>
                    <tr>
                      <th>الاسم</th>
                      <th>الهاتف</th>
                      <th>الرصيد (دين/دائن)</th>
                      <th>إجمالي المبيعات</th>
                      <th>تاريخ التسجيل</th>
                      <th>الإجراءات</th>
                    </tr>
                  </thead>
                  <tbody>
                    </tbody>
                </table>
              </div>
            </div>
          </div>
        `,
        init: initializeCustomers
      },
      suppliers: {
        label: "الموردين",
        icon: ICONS.suppliers,
        content: `
          <div class="suppliers-page">
            <h2><div class="nav-icon">${ICONS.suppliers}</div> إدارة بيانات الموردين</h2>
            <div class="card">
              <div class="space-between mb-20">
                <input type="text" placeholder="بحث بالاسم أو الهاتف..." style="width: 300px; padding: 10px; border-radius: 8px; border: 1px solid var(--border);">
                <button class="btn purple" onclick="openModal('new-supplier')">${ICONS.plus} إضافة مورد</button>
              </div>
              <div class="table-container">
                <table id="suppliers-table">
                  <thead>
                    <tr>
                      <th>الاسم</th>
                      <th>الهاتف</th>
                      <th>الرصيد (دين/دائن)</th>
                      <th>إجمالي المشتريات</th>
                      <th>الإجراءات</th>
                    </tr>
                  </thead>
                  <tbody>
                    </tbody>
                </table>
              </div>
            </div>
          </div>
        `,
        init: initializeSuppliers
      },
      expenses: {
        label: "المصروفات",
        icon: ICONS.expenses,
        content: `
          <div class="expenses-page">
            <h2><div class="nav-icon">${ICONS.expenses}</div> تسجيل وتتبع المصروفات</h2>
            <div class="card">
              <div class="space-between mb-20">
                <input type="text" placeholder="بحث بالوصف أو التاريخ..." style="width: 300px; padding: 10px; border-radius: 8px; border: 1px solid var(--border);">
                <button class="btn danger" onclick="openModal('new-expense')">${ICONS.plus} تسجيل مصروف</button>
              </div>
              <div class="table-container">
                <table id="expenses-table">
                  <thead>
                    <tr>
                      <th>التاريخ</th>
                      <th>الوصف</th>
                      <th>الفئة</th>
                      <th>المبلغ</th>
                      <th>المستند</th>
                      <th>الإجراءات</th>
                    </tr>
                  </thead>
                  <tbody>
                    </tbody>
                </table>
              </div>
            </div>
          </div>
        `,
        init: initializeExpenses
      },
      reports: {
        label: "التقارير",
        icon: ICONS.reports,
        content: `
          <div class="reports-page">
            <h2><div class="nav-icon">${ICONS.reports}</div> التقارير والتحليلات</h2>

            <div class="card mb-20">
              <div class="form-row" style="align-items:end;">
                <div class="col-4 form-group">
                  <label>من تاريخ</label>
                  <input type="date" id="rpt-from">
                </div>
                <div class="col-4 form-group">
                  <label>إلى تاريخ</label>
                  <input type="date" id="rpt-to">
                </div>
                <div class="col-4 form-group">
                  <label>تجميع حسب</label>
                  <select id="rpt-group">
                    <option value="day">اليوم</option>
                    <option value="month">الشهر</option>
                  </select>
                </div>
                <div class="col-4 form-group">
                  <label>نوع التقرير</label>
                  <select id="rpt-type">
                    <option value="summary">ملخص (مبيعات/مرتجعات/مصروفات)</option>
                    <option value="sales">المبيعات</option>
                    <option value="returns">المرتجعات</option>
                    <option value="purchases">المشتريات</option>
                    <option value="expenses">المصروفات</option>
                    <option value="profit">الربح والخسارة</option>
                    <option value="inventory">المخزون (قيمة حالية)</option>
                    <option value="payments">طرق الدفع (نقد/بطاقة/أخرى)</option>
                    <option value="credit-sales">بيع أجل</option>
                    <option value="receivables">ذمم العملاء</option>
                    <option value="credit-purchases">مشتريات أجل</option>
                    <option value="payables">ذمم الموردين</option>
                    <option value="transactions">تفاصيل المعاملات</option>
                  </select>
                </div>
                <div class="col-4 form-group">
                  <label>&nbsp;</label>
                  <div class="flex-wrap" style="gap:8px;">
                    <button class="btn info" id="rpt-apply">${ICONS.chart} تطبيق</button>
                    <button class="btn ghost" onclick="exportReportsToExcel()">${ICONS.download} تصدير</button>
                    <button class="btn" onclick="printReports()">${ICONS.print} طباعة</button>
                  </div>
                </div>
              </div>
            </div>

            <div class="grid mb-20">
              <div class="card stat-card info-light"><div class="stat-label">إجمالي المبيعات</div><div class="stat-value" id="rpt-total-sales">0</div></div>
              <div class="card stat-card danger-light"><div class="stat-label">المرتجعات</div><div class="stat-value" id="rpt-total-returns">0</div></div>
              <div class="card stat-card warning-light"><div class="stat-label">المصروفات</div><div class="stat-value" id="rpt-total-expenses">0</div></div>
              <div class="card stat-card success-light"><div class="stat-label">صافي الربح</div><div class="stat-value" id="rpt-net-profit">0</div></div>
            </div>

            <div class="grid" style="grid-template-columns: 1fr 1fr;">
              <div class="card">
                <h4>المبيعات حسب الفترة</h4>
                <canvas id="rptSalesChart" role="img" aria-label="مخطط المبيعات حسب الفترة"></canvas>
              </div>
              <div class="card">
                <h4 id="rpt-table-title">تفصيل حسب النوع</h4>
                <div class="table-container">
                  <table id="rpt-table">
                    <thead><tr><th>الفترة</th><th>المبيعات</th><th>المرتجعات</th><th>المصروفات</th><th>الصافي</th></tr></thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        `,
        init: initializeReports
      },
      vouchers: {
        label: "السندات",
        icon: ICONS.download,
        content: `
          <div class="vouchers-page">
            <h2><div class="nav-icon">${ICONS.download}</div> السندات - القبض والدفع</h2>
            <div class="space-between mb-10">
              <div class="tabs">
                <button class="tab active" onclick="switchVoucherTab('receive', this)">قبض من عميل</button>
                <button class="tab" onclick="switchVoucherTab('pay', this)">دفع لمورد</button>
              </div>
              <button class="btn info ghost" onclick="App.navigateTo('vouchersHistory')">📋 عرض السجل</button>
            </div>
            
            <div id="receive-tab" class="card tab-content active">
              <h3>تسجيل قبض من عميل</h3>
              <form id="rp-form">
                <div class="form-row">
                  <div class="col-6 form-group"><label>العميل</label><select id="rp-customer" required></select><div class="muted-small" id="rp-balance"></div></div>
                  <div class="col-3 form-group"><label>المبلغ</label><input type="number" step="0.01" id="rp-amount" required></div>
                  <div class="col-3 form-group"><label>التاريخ</label><input type="date" id="rp-date" value="${new Date().toISOString().slice(0,10)}"></div>
                  <div class="col-6 form-group"><label>طريقة الدفع</label><select id="rp-method"><option value="cash">نقد</option><option value="card">بطاقة</option></select></div>
                  <div class="col-12">
                    <div class="card">
                      <div class="space-between mb-10"><strong>فواتير أجل غير مدفوعة</strong><span class="muted-small">توزيع تلقائي حسب الأقدم</span></div>
                      <div class="table-container"><table id="rp-invoices"><thead><tr><th>رقم</th><th>تاريخ</th><th>الإجمالي</th><th>المدفوع</th><th>المتبقي</th><th>تخصيص</th></tr></thead><tbody></tbody></table></div>
                    </div>
                  </div>
                  <div class="col-12 form-group"><label>ملاحظة</label><input type="text" id="rp-note"></div>
                </div>
                <div class="text-right mt-10"><button type="submit" class="btn success">حفظ وطباعة</button></div>
              </form>
            </div>
            
            <div id="pay-tab" class="card tab-content" style="display:none;">
              <h3>تسجيل دفع لمورد</h3>
              <form id="mp-form">
                <div class="form-row">
                  <div class="col-6 form-group"><label>المورد</label><select id="mp-supplier" required></select><div class="muted-small" id="mp-balance"></div></div>
                  <div class="col-3 form-group"><label>المبلغ</label><input type="number" step="0.01" id="mp-amount" required></div>
                  <div class="col-3 form-group"><label>التاريخ</label><input type="date" id="mp-date" value="${new Date().toISOString().slice(0,10)}"></div>
                  <div class="col-6 form-group"><label>طريقة الدفع</label><select id="mp-method"><option value="cash">نقد</option><option value="card">بطاقة</option></select></div>
                  <div class="col-12">
                    <div class="card">
                      <div class="space-between mb-10"><strong>فواتير مشتريات أجل غير مدفوعة</strong><span class="muted-small">توزيع تلقائي حسب الأقدم</span></div>
                      <div class="table-container"><table id="mp-invoices"><thead><tr><th>رقم</th><th>تاريخ</th><th>الإجمالي</th><th>المدفوع</th><th>المتبقي</th><th>تخصيص</th></tr></thead><tbody></tbody></table></div>
                    </div>
                  </div>
                  <div class="col-12 form-group"><label>ملاحظة</label><input type="text" id="mp-note"></div>
                </div>
                <div class="text-right mt-10"><button type="submit" class="btn danger">حفظ وطباعة</button></div>
              </form>
            </div>
          </div>
        `,
        init: initializeVouchersPage
      },
      vouchersHistory: {
        label: "سجل السندات",
        icon: ICONS.activity,
        content: `
          <div class="vouchers-history-page">
            <h2><div class="nav-icon">${ICONS.activity}</div> سجل القبض والدفع</h2>
            <div class="card">
              <div class="tabs">
                <button class="tab active" onclick="switchHistoryTab('receipts', this)">سجل القبض</button>
                <button class="tab" onclick="switchHistoryTab('payments', this)">سجل الدفع</button>
                <button class="tab" onclick="switchHistoryTab('report', this)">التقرير الملخص</button>
              </div>
              
              <div id="receipts-history-tab" class="tab-content active" style="margin-top:15px;">
                <div class="space-between mb-10">
                  <input type="text" id="search-receipts" placeholder="بحث بالعميل أو الرقم..." style="width:300px; padding:8px; border-radius:6px; border:1px solid var(--border);">
                  <div style="display:flex; gap:10px;">
                    <input type="date" id="filter-receipts-from" style="padding:8px;">
                    <input type="date" id="filter-receipts-to" style="padding:8px;">
                    <button class="btn ghost" onclick="clearReceiptsFilter()">مسح الفلتر</button>
                  </div>
                </div>
                <div class="table-container">
                  <table id="receipts-history-table">
                    <thead><tr><th>الرقم</th><th>التاريخ</th><th>العميل</th><th>المبلغ</th><th>طريقة الدفع</th><th>التخصيصات</th><th>إجراءات</th></tr></thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
              
              <div id="payments-history-tab" class="tab-content" style="display:none; margin-top:15px;">
                <div class="space-between mb-10">
                  <input type="text" id="search-payments" placeholder="بحث بالمورد أو الرقم..." style="width:300px; padding:8px; border-radius:6px; border:1px solid var(--border);">
                  <div style="display:flex; gap:10px;">
                    <input type="date" id="filter-payments-from" style="padding:8px;">
                    <input type="date" id="filter-payments-to" style="padding:8px;">
                    <button class="btn ghost" onclick="clearPaymentsFilter()">مسح الفلتر</button>
                  </div>
                </div>
                <div class="table-container">
                  <table id="payments-history-table">
                    <thead><tr><th>الرقم</th><th>التاريخ</th><th>المورد</th><th>المبلغ</th><th>طريقة الدفع</th><th>التخصيصات</th><th>إجراءات</th></tr></thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
              
              <div id="report-history-tab" class="tab-content" style="display:none; margin-top:15px;">
                <div class="form-row mb-20">
                  <div class="col-4 form-group">
                    <label>من تاريخ</label>
                    <input type="date" id="report-from" value="${new Date(new Date().setDate(1)).toISOString().slice(0,10)}">
                  </div>
                  <div class="col-4 form-group">
                    <label>إلى تاريخ</label>
                    <input type="date" id="report-to" value="${new Date().toISOString().slice(0,10)}">
                  </div>
                  <div class="col-4 form-group">
                    <label>&nbsp;</label>
                    <button class="btn info" onclick="generateVouchersReport()" style="width:100%;">إنشاء التقرير</button>
                  </div>
                </div>
                <div id="vouchers-report-area"></div>
              </div>
            </div>
          </div>
        `,
        init: initializeVouchersHistory
      },
      activity: {
        label: "سجل النشاط",
        icon: ICONS.activity,
        content: `
          <div class="activity-page">
            <h2><div class="nav-icon">${ICONS.activity}</div> سجل إجراءات المستخدمين</h2>
            <div class="card">
              <div class="space-between mb-20">
                <input type="text" placeholder="بحث بالاسم أو الإجراء..." style="width: 300px; padding: 10px; border-radius: 8px; border: 1px solid var(--border);">
                <button class="btn danger ghost" onclick="clearActivityLog()">مسح السجل</button>
              </div>
              <div class="table-container">
                <table id="activity-log-table">
                  <thead>
                    <tr>
                      <th>التاريخ والوقت</th>
                      <th>المستخدم</th>
                      <th>الإجراء</th>
                      <th>الصفحة</th>
                    </tr>
                  </thead>
                  <tbody>
                    </tbody>
                </table>
              </div>
              <div class="text-center mt-20">
                <button class="btn sm ghost" onclick="loadMoreActivity()">تحميل المزيد</button>
              </div>
            </div>
          </div>
        `,
        init: initializeActivity
      },
      settings: {
        label: "الإعدادات",
        icon: ICONS.settings,
        content: `
          <div class="settings-page">
            <h2><div class="nav-icon">${ICONS.settings}</div> إعدادات النظام</h2>
            <div class="tabs">
                <button class="tab active" onclick="switchSettingTab('general', this)">عام</button>
                <button class="tab" onclick="switchSettingTab('users', this)">المستخدمون والصلاحيات</button>
                <button class="tab" onclick="switchSettingTab('print', this)">طباعة الفواتير</button>
                <button class="tab" onclick="switchSettingTab('backup', this)">النسخ الاحتياطي</button>
            </div>
            
            <div id="general" class="card tab-content active">
                <h3>إعدادات عامة</h3>
                <div class="form-row">
                    <div class="col-6 form-group">
                        <label>اسم الشركة/المتجر</label>
                        <input type="text" id="setting-company-name" value="سوفت بلاكي Ultimate">
                    </div>
                    <div class="col-6 form-group">
                        <label>العملة الافتراضية</label>
                        <select id="setting-currency">
                            <option value="SAR" selected>ريال سعودي (ر.س)</option>
                            <option value="USD">دولار أمريكي ($)</option>
                        </select>
                    </div>
                    <div class="col-6 form-group">
                        <label>نسبة الضريبة (VAT)</label>
                        <input type="number" step="0.01" id="setting-tax-rate" placeholder="0.15" />
                    </div>
                    <div class="col-6 form-group">
                        <label>خصم ثابت (بالعملة)</label>
                        <input type="number" step="0.01" id="setting-discount-fixed" placeholder="10" />
                    </div>
                    <div class="col-12 form-group">
                        <label>عنوان المتجر</label>
                        <textarea id="setting-address" rows="3">شارع العليا، الرياض، المملكة العربية السعودية</textarea>
                    </div>
                    <div class="col-6 form-group">
                        <label>هاتف المتجر</label>
                        <input type="text" id="setting-phone" placeholder="مثال: 0500000000">
                    </div>
                    <div class="col-6 form-group">
                        <label>الرقم الضريبي (VAT)</label>
                        <input type="text" id="setting-vat" placeholder="مثال: 1234567890">
                    </div>
                    <div class="col-12 form-group">
                        <label>رابط الشعار (Logo URL)</label>
                        <input type="text" id="setting-logo" placeholder="https://example.com/logo.png">
                    </div>
                </div>
                <div class="text-right mt-10"><button class="btn success" id="btn-save-settings">حفظ الإعدادات</button></div>
            </div>
            
            <div id="users" class="card tab-content" style="display: none;">
                <h3>إدارة المستخدمين والصلاحيات</h3>
                <button class="btn success mb-15" onclick="openModal('new-user')">${ICONS.plus} إضافة مستخدم جديد</button>
                <div class="table-container">
                    <table id="users-table">
                        <thead>
                            <tr>
                                <th>الاسم</th>
                                <th>اسم المستخدم</th>
                                <th>الدور/الصلاحية</th>
                                <th>الحالة</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="print" class="card tab-content" style="display: none;">
                <h3>إعدادات طباعة الفواتير</h3>
                <div class="form-group">
                    <label>نوع الطباعة الافتراضي</label>
                    <select id="setting-print-type">
                        <option value="thermal">طابعة حرارية 80mm</option>
                        <option value="a4">ورق A4</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>تذييل الفاتورة (رسالة الشكر)</label>
                    <input id="setting-invoice-footer" type="text" value="شكراً لزيارتكم، نتطلع لرؤيتكم مجدداً!">
                </div>
                <div class="text-right mt-15"><button id="btn-save-print-settings" class="btn success">حفظ إعدادات الطباعة</button></div>
            </div>

            <div id="backup" class="card tab-content" style="display: none;">
                <h3>النسخ الاحتياطي واستعادة البيانات</h3>
                <p class="muted mb-15">قم بإنشاء نسخة احتياطية من قاعدة البيانات بشكل دوري.</p>
                <div class="space-between mb-15">
                    <strong>آخر نسخة احتياطية:</strong>
                    <span>2024-10-20 08:00 AM</span>
                </div>
                <div class="flex-wrap" style="gap: 15px;">
                    <button class="btn success" onclick="startBackup()">إنشاء نسخة احتياطية الآن</button>
                    <button class="btn warning" onclick="openModal('restore-backup')">استعادة نسخة</button>
                    <button class="btn ghost" onclick="downloadBackup()">تحميل النسخ السابقة ${ICONS.download}</button>
                </div>
            </div>
          </div>
        `,
        init: initializeSettings
      }
    };

    // Placeholder Data
    const dummyUsers = [
        { id: 'admin', name: 'أحمد المدير', role: 'مسؤول النظام', password: '1234', selected: true },
        { id: 'cashier', name: 'سارة الكاشير', role: 'نقطة البيع', password: '1234' },
        { id: 'stock', name: 'خالد المخزون', role: 'مدير المخزون', password: '1234' },
    ];
    
    const dummyProducts = [
        { id: 101, sku: 'PROD001', name: 'قهوة سريعة التحضير', price: 25.50, stock: 150, reorder: 50, category: 'مشروبات' },
        { id: 102, sku: 'PROD002', name: 'جهاز مسح باركود', price: 199.99, stock: 20, reorder: 10, category: 'أدوات' },
        { id: 103, sku: 'PROD003', name: 'دفتر فواتير (100 ورقة)', price: 12.00, stock: 5, reorder: 20, category: 'أدوات' }, // Low stock item
        { id: 104, sku: 'PROD004', name: 'مشروب طاقة (بالجملة)', price: 3.50, stock: 500, reorder: 100, category: 'مشروبات' },
        { id: 105, sku: 'PROD005', name: 'آلة حاسبة احترافية', price: 85.00, stock: 45, reorder: 15, category: 'أدوات' },
    ];

    // ========== DATA STORE (LocalStorage) ==========
    const DataStore = {
        key(k){ return `ultimate_${k}`; },
        load(k, def){ try { const v = localStorage.getItem(this.key(k)); return v ? JSON.parse(v) : (def ?? null);} catch { return def ?? null; }},
        save(k, v){ localStorage.setItem(this.key(k), JSON.stringify(v)); },
        ensure(){
            if(!this.load('products')) this.save('products', dummyProducts);
            if(!this.load('users')) this.save('users', dummyUsers);
            if(!this.load('customers')) this.save('customers', []);
            if(!this.load('suppliers')) this.save('suppliers', []);
            if(!this.load('sales')) this.save('sales', []);
            if(!this.load('returns')) this.save('returns', []);
            if(!this.load('purchases')) this.save('purchases', []);
            if(!this.load('expenses')) this.save('expenses', []);
            if(!this.load('cart')) this.save('cart', []);
            if(!this.load('holds')) this.save('holds', []);
            if(!this.load('currentUserId')) this.save('currentUserId', (dummyUsers.find(u=>u.selected)||dummyUsers[0]).id);
            if(!this.load('activity')) this.save('activity', []);
            if(!this.load('adjustments')) this.save('adjustments', []);
            if(!this.load('settings')) this.save('settings', { taxRate: 0.15, discountFixed: 10 });
        },
        // Generic helpers
        getList(k){ return this.load(k, []); },
        setList(k, list){ this.save(k, list); },
        add(k, obj){ const list = this.getList(k); list.push(obj); this.setList(k, list); return obj; },
        update(k, id, updater){ const list = this.getList(k); const i=list.findIndex(x=> String(x.id)===String(id)); if(i>-1){ list[i] = { ...list[i], ...updater(list[i]) }; this.setList(k, list); return list[i]; } return null; },
        remove(k, id){ const list = this.getList(k); const nl = list.filter(x=> String(x.id)!==String(id)); this.setList(k, nl); },
        nextId(k, start=1){ const list = this.getList(k); const max = list.reduce((m,x)=> Math.max(m, Number(x.id)||0), 0); return (max||0)+1; },
        // Domain helpers
        getProducts(){ return this.getList('products'); },
        getUsers(){ return this.getList('users'); },
        getCurrentUser(){ const id = this.load('currentUserId'); return this.getUsers().find(u=>u.id===id) || this.getUsers()[0]; },
        setCurrentUser(id){ this.save('currentUserId', id); },
        getCart(){ return this.getList('cart'); },
        setCart(items){ this.setList('cart', items); },
    };

    DataStore.ensure();
    // AUTH UI INIT
    function initializeAuthUI(){
        try{
            const auth = DataStore.load('auth', { loggedIn: false, userId: null });
            const overlay = document.getElementById('login-overlay');
            const users = DataStore.getUsers();
            const sel = document.getElementById('login-user');
            if(sel){ sel.innerHTML=''; users.forEach(u=>{ const opt=document.createElement('option'); opt.value=u.id; opt.textContent=`${u.name} (${u.role})`; sel.appendChild(opt); }); }
            const btn = document.getElementById('btn-login');
            if(btn){ btn.onclick = ()=>{
                const userId = document.getElementById('login-user')?.value;
                const pass = document.getElementById('login-pass')?.value||'';
                const u = users.find(x=> String(x.id)===String(userId));
                if(u && (u.password||'')===pass){
                    DataStore.save('auth', { loggedIn: true, userId: u.id });
                    DataStore.setCurrentUser(u.id);
                    currentUser = u;
                    overlay.style.display='none';
                    showNotification('مرحباً', `تم تسجيل الدخول كمستخدم ${u.name}.`, 'success');
                    // refresh welcome text
                    const w = document.getElementById('welcome-user'); if(w) w.textContent = u.name;
                    // navigate to dashboard after login
                    if(typeof App!=='undefined' && App.navigateTo){ App.navigateTo('dashboard'); }
                } else {
                    const err = document.getElementById('login-error'); if(err) err.style.display='block';
                }
            };
            const passInp = document.getElementById('login-pass');
            if(passInp){ passInp.onkeydown = (e)=>{ if(e.key==='Enter'){ btn?.click(); } }; }
            }
            if(!auth.loggedIn){
                overlay.style.display='flex';
            } else {
                overlay.style.display='none';
                // restore current user
                const u = users.find(x=> String(x.id)===String(auth.userId));
                if(u){ DataStore.setCurrentUser(u.id); currentUser = u; const w = document.getElementById('welcome-user'); if(w) w.textContent = u.name; }
                // navigate to dashboard on restore
                if(typeof App!=='undefined' && App.navigateTo){ App.navigateTo('dashboard'); }
            }
        }catch(e){ console.warn('Auth UI init failed', e); }
    }

    function logout(){
        DataStore.save('auth', { loggedIn: false, userId: null });
        try { localStorage.removeItem(DataStore.key('currentUserId')); } catch {}
        try { DataStore.setCart([]); currentCart = []; } catch {}
        const w = document.getElementById('welcome-user'); if (w) w.textContent = '';
        const overlay = document.getElementById('login-overlay'); if (overlay) overlay.style.display = 'flex';
        showToast('تم تسجيل الخروج');
        setTimeout(()=> window.location.reload(), 300);
    }

    let currentCart = DataStore.getCart();
    let lastAddedProductId = null;
    let currentUser = DataStore.getCurrentUser();
    initializeAuthUI();

    // ========== PERMISSIONS ==========
    const Permissions = {
        // roles: مسؤول النظام (admin), نقطة البيع (cashier), مدير المخزون/مشرف (stock/supervisor)
        role(){ return (currentUser?.role||'').toLowerCase(); },
        can(action){
            const r = this.role();
            if(r.includes('مسؤول') || r.includes('admin')) return true; // full access
            if(action==='sell') return true; // everyone can sell
            if(action==='delete') return r.includes('admin');
            if(action==='edit') return r.includes('مشرف') || r.includes('stock') || r.includes('مدير');
            if(action==='export' || action==='import') return r.includes('admin') || r.includes('مشرف');
            return false;
        }
    };

    // ========== UTILITY FUNCTIONS ==========
    
    /**
     * Shows a dynamic notification toast at the top-left corner.
     * @param {string} title 
     * @param {string} message 
     * @param {'success'|'error'|'info'|'warning'} type 
     */
    function showNotification(title, message, type = 'success') {
        const toast = document.getElementById('notification-toast');
        const icon = document.getElementById('notif-icon');
        const titleEl = document.getElementById('notif-title');
        const messageEl = document.getElementById('notif-message');

        // Reset classes
        toast.className = 'notification-toast'; 

        // Set content and type
        titleEl.textContent = title;
        messageEl.textContent = message;
        
        switch(type) {
            case 'error':
                toast.classList.add('error');
                icon.innerHTML = '❌';
                break;
            case 'receive-payment':
                (function(){
                    const todayISO = new Date().toISOString().slice(0,10);
                    contentHtml += `
                      <h3>${ICONS.income||'➕'} تسجيل قبض من عميل</h3>
                      <div class="hr"></div>
                      <form onsubmit="(function(ev){ev.preventDefault();
                        try{
                          var cust = document.getElementById('rcv-customer').value||'عميل';
                          var amt = Number(document.getElementById('rcv-amount').value||0);
                          var pm = document.getElementById('rcv-method').value||'cash';
                          var dt = document.getElementById('rcv-date').value||'${todayISO}';
                          var note = document.getElementById('rcv-note').value||'';
                          var arr=[]; try{ arr=JSON.parse(localStorage.getItem('receipts')||'[]')||[]; }catch(e){}
                          // allocations to customer invoices
                          var allocRows = Array.from(document.querySelectorAll('#rcv-invoices tbody input[data-invoice]')||[]);
                          var salesList = (window.DataStore && DataStore.getList)? DataStore.getList('sales') : [];
                          var allocations = [];
                          allocRows.forEach(function(inp){ var invId = inp.getAttribute('data-invoice'); var al = Number(inp.value||0); if(al>0){ allocations.push({invoiceId: invId, allocated: al}); var inv = salesList.find(function(s){ return String(s.id)===String(invId); }); if(inv){ inv.paid = Number(inv.paid||0)+al; inv.remaining = Math.max(0, Number(inv.total||0)-Number(inv.paid||0)); inv.status = inv.remaining===0 ? 'مدفوعة' : 'مدفوعة جزئياً'; } } });
                          if(DataStore.setList) DataStore.setList('sales', salesList);
                          // update customer balance
                          var customers = (window.DataStore && DataStore.getList)? DataStore.getList('customers') : [];
                          var idx = customers.findIndex(function(c){ return String(c.name||'').trim()===String(cust).trim(); });
                          var prevBal = 0; if(idx>-1){ prevBal = Number(customers[idx].balance||0); customers[idx].balance = Math.max(0, prevBal - amt); DataStore.setList && DataStore.setList('customers', customers); }
                          var rec = {id: Date.now(), time: new Date().toLocaleTimeString('ar-SA'), customer:cust, amount:amt, paymentMethod:pm, dateISO:dt, note:note, prevBalance: prevBal, newBalance: (idx>-1? customers[idx].balance : undefined), allocations: allocations };
                          arr.push(rec);
                          localStorage.setItem('receipts', JSON.stringify(arr));
                          if(window.showNotification) showNotification('تم الحفظ','تم تسجيل عملية قبض.','success');
                          var html = ''+
                            '<h3>إيصال قبض</h3><div class=\'hr\'></div>'+
                            '<div class=\'grid\'>'+
                            '<div class=\'card\'><div class=\'stat-label\'>العميل</div><div class=\'stat-value\'>'+cust+'</div></div>'+
                            '<div class=\'card\'><div class=\'stat-label\'>المبلغ</div><div class=\'stat-value\'>'+fmt(amt)+'</div></div>'+
                            '<div class=\'card\'><div class=\'stat-label\'>طريقة الدفع</div><div class=\'stat-value\'>'+(pm==='card'?'بطاقة':'نقد')+'</div></div>'+
                            '<div class=\'card\'><div class=\'stat-label\'>التاريخ</div><div class=\'stat-value\'>'+dt+'</div></div>'+
                            (typeof rec.prevBalance!=='undefined' ? '<div class=\'card\'><div class=\'stat-label\'>الرصيد السابق</div><div class=\'stat-value\'>'+fmt(rec.prevBalance)+'</div></div>' : '')+
                            (typeof rec.newBalance!=='undefined' ? '<div class=\'card\'><div class=\'stat-label\'>الرصيد الحالي</div><div class=\'stat-value\'>'+fmt(rec.newBalance)+'</div></div>' : '')+
                            '</div>'+
                            (note? '<div class=\'mt-10\'><strong>ملاحظة:</strong> '+note+'</div>' : '')+
                            '<div class=\'text-right mt-15 no-print\'><button class=\'btn\' onclick=\'printReceipt('+JSON.stringify(rec).replace(/"/g,"&quot;")+')\'>طباعة الإيصال</button> <button class=\'btn ghost\' onclick=\'closeModal()\'>إغلاق</button></div>';
                          var mc = document.querySelector('#main-modal .modal-content'); if(mc){ mc.innerHTML = '<button class=\\'modal-close\\' onclick=\\'closeModal()\\'>✖</button>'+html; }
                        }catch(e){ console.error(e); if(window.showNotification) showNotification('خطأ','تعذر تسجيل عملية القبض.','error'); }
                      })(event)">
                        <div class=\"form-row\">\n\
                          <div class=\"col-6 form-group\"><label>العميل</label>\n\
                            <select id=\"rcv-customer\" required></select>\n\
                            <div class=\"muted-small\" id=\"rcv-balance\"></div>\n\
                          </div>
                          <div class="col-3 form-group"><label>المبلغ</label><input type="number" step="0.01" id="rcv-amount" required></div>
                          <div class="col-3 form-group"><label>التاريخ</label><input type="date" id="rcv-date" value="${todayISO}"></div>
                          <div class="col-6 form-group"><label>طريقة الدفع</label>
                            <select id="rcv-method"><option value="cash">نقد</option><option value="card">بطاقة</option></select>
                          </div>
                          <div class="col-12">
                            <div class="card">
                              <div class="space-between mb-10"><strong>فواتير أجل غير مدفوعة</strong><span class="muted-small">سيتم توزيع الدفعة تلقائيًا حسب الأقدم</span></div>
                              <div class="table-container">
                                <table id="rcv-invoices">
                                  <thead><tr><th>رقم</th><th>تاريخ</th><th>الإجمالي</th><th>المدفوع</th><th>المتبقي</th><th>تخصيص</th></tr></thead>
                                  <tbody></tbody>
                                </table>
                              </div>
                            </div>
                          </div>
                          <div class="col-12 form-group"><label>ملاحظة</label><input type="text" id="rcv-note"></div>
                        </div>
                        <div class="text-right mt-10"><button type="submit" class="btn success">حفظ</button></div>
                      </form>
                    `;
                })();
                break;
            case 'make-payment':
                (function(){
                    const todayISO = new Date().toISOString().slice(0,10);
                    contentHtml += `
                      <h3>${ICONS.expense||'➖'} تسجيل دفع لمورد</h3>
                      <div class="hr"></div>
                      <form onsubmit="(function(ev){ev.preventDefault();
                        try{
                          var sup = document.getElementById('pay-supplier').value||'مورد';
                          var amt = Number(document.getElementById('pay-amount').value||0);
                          var pm = document.getElementById('pay-method').value||'cash';
                          var dt = document.getElementById('pay-date').value||'${todayISO}';
                          var note = document.getElementById('pay-note').value||'';
                          var arr=[]; try{ arr=JSON.parse(localStorage.getItem('supplier_payments')||'[]')||[]; }catch(e){}
                          // allocations to supplier invoices
                          var payAllocRows = Array.from(document.querySelectorAll('#pay-invoices tbody input[data-invoice]')||[]);
                          var purchasesList = (window.DataStore && DataStore.getList)? DataStore.getList('purchases') : [];
                          var allocations = [];
                          payAllocRows.forEach(function(inp){ var invId = inp.getAttribute('data-invoice'); var al = Number(inp.value||0); if(al>0){ allocations.push({invoiceId: invId, allocated: al}); var inv = purchasesList.find(function(p){ return String(p.id)===String(invId); }); if(inv){ inv.paid = Number(inv.paid||0)+al; inv.remaining = Math.max(0, Number(inv.total||inv.amount||0)-Number(inv.paid||0)); inv.status = inv.remaining===0 ? 'مدفوعة' : 'مدفوعة جزئياً'; } } });
                          if(DataStore.setList) DataStore.setList('purchases', purchasesList);
                          // update supplier balance
                          var suppliers = (window.DataStore && DataStore.getList)? DataStore.getList('suppliers') : [];
                          var idx = suppliers.findIndex(function(s){ return String(s.name||'').trim()===String(sup).trim(); });
                          var prevBal = 0; if(idx>-1){ prevBal = Number(suppliers[idx].balance||0); suppliers[idx].balance = Math.max(0, prevBal - amt); DataStore.setList && DataStore.setList('suppliers', suppliers); }
                          var v = {id: Date.now(), time: new Date().toLocaleTimeString('ar-SA'), supplier:sup, amount:amt, paymentMethod:pm, dateISO:dt, note:note, prevBalance: prevBal, newBalance: (idx>-1? suppliers[idx].balance : undefined), allocations: allocations };
                          arr.push(v);
                          localStorage.setItem('supplier_payments', JSON.stringify(arr));
                          if(window.showNotification) showNotification('تم الحفظ','تم تسجيل عملية دفع.','success');
                          var html = ''+
                            '<h3>سند صرف</h3><div class=\'hr\'></div>'+
                            '<div class=\'grid\'>'+
                            '<div class=\'card\'><div class=\'stat-label\'>المورد</div><div class=\'stat-value\'>'+sup+'</div></div>'+
                            '<div class=\'card\'><div class=\'stat-label\'>المبلغ</div><div class=\'stat-value\'>'+fmt(amt)+'</div></div>'+
                            '<div class=\'card\'><div class=\'stat-label\'>طريقة الدفع</div><div class=\'stat-value\'>'+(pm==='card'?'بطاقة':'نقد')+'</div></div>'+
                            '<div class=\'card\'><div class=\'stat-label\'>التاريخ</div><div class=\'stat-value\'>'+dt+'</div></div>'+
                            (typeof v.prevBalance!=='undefined' ? '<div class=\'card\'><div class=\'stat-label\'>الرصيد السابق</div><div class=\'stat-value\'>'+fmt(v.prevBalance)+'</div></div>' : '')+
                            (typeof v.newBalance!=='undefined' ? '<div class=\'card\'><div class=\'stat-label\'>الرصيد الحالي</div><div class=\'stat-value\'>'+fmt(v.newBalance)+'</div></div>' : '')+
                            '</div>'+
                            (note? '<div class=\'mt-10\'><strong>ملاحظة:</strong> '+note+'</div>' : '')+
                            '<div class=\'text-right mt-15 no-print\'><button class=\'btn\' onclick=\'printSupplierPayment('+JSON.stringify(v).replace(/"/g,"&quot;")+')\'>طباعة السند</button> <button class=\'btn ghost\' onclick=\'closeModal()\'>إغلاق</button></div>';
                          var mc = document.querySelector('#main-modal .modal-content'); if(mc){ mc.innerHTML = '<button class=\\'modal-close\\' onclick=\\'closeModal()\\'>✖</button>'+html; }
                        }catch(e){ console.error(e); if(window.showNotification) showNotification('خطأ','تعذر تسجيل عملية الدفع.','error'); }
                      })(event)">
                        <div class=\"form-row\">\n\
                          <div class=\"col-6 form-group\"><label>المورد</label>\n\
                            <select id=\"pay-supplier\" required></select>\n\
                            <div class=\"muted-small\" id=\"pay-balance\"></div>\n\
                          </div>
                          <div class="col-3 form-group"><label>المبلغ</label><input type="number" step="0.01" id="pay-amount" required></div>
                          <div class="col-3 form-group"><label>التاريخ</label><input type="date" id="pay-date" value="${todayISO}"></div>
                          <div class="col-6 form-group"><label>طريقة الدفع</label>
                            <select id="pay-method"><option value="cash">نقد</option><option value="card">بطاقة</option></select>
                          </div>
                          <div class="col-12">
                            <div class="card">
                              <div class="space-between mb-10"><strong>فواتير مشتريات أجل غير مدفوعة</strong><span class="muted-small">سيتم توزيع الدفع تلقائيًا حسب الأقدم</span></div>
                              <div class="table-container">
                                <table id="pay-invoices">
                                  <thead><tr><th>رقم</th><th>تاريخ</th><th>الإجمالي</th><th>المدفوع</th><th>المتبقي</th><th>تخصيص</th></tr></thead>
                                  <tbody></tbody>
                                </table>
                              </div>
                            </div>
                          </div>
                          <div class="col-12 form-group"><label>ملاحظة</label><input type="text" id="pay-note"></div>
                        </div>
                        <div class="text-right mt-10"><button type="submit" class="btn danger">حفظ</button></div>
                      </form>
                    `;
                })();
                break;
            case 'quick-stats':
                // Quick Stats modal: show KPIs snapshot
                try{
                  const sales = DataStore.getList('sales');
                  const todayStr = new Date().toLocaleDateString('ar-SA');
                  const salesToday = sales.filter(s=> s.date===todayStr).reduce((s,x)=> s+Number(x.total||0),0);
                  const month = new Date().toISOString().slice(0,7);
                  const salesMonth = sales.filter(s=> (s.date||'').startsWith(month)).reduce((s,x)=> s+Number(x.total||0),0);
                  const expenses = DataStore.getList('expenses').filter(e=> (e.date||'').startsWith(month)).reduce((s,x)=> s+Number(x.amount||0),0);
                  contentHtml += `
                    <h3>${ICONS.chart} إحصائيات سريعة</h3>
                    <div class="hr"></div>
                    <div class="grid">
                      <div class="card stat-card info-light"><div class="stat-label">مبيعات اليوم</div><div class="stat-value">${fmt(salesToday)}</div></div>
                      <div class="card stat-card success-light"><div class="stat-label">مبيعات الشهر</div><div class="stat-value">${fmt(salesMonth)}</div></div>
                      <div class="card stat-card warning-light"><div class="stat-label">مصروفات الشهر</div><div class="stat-value">${fmt(expenses)}</div></div>
                    </div>`;
                }catch{ contentHtml += `<p class="muted">لا تتوفر بيانات كافية.</p>`; }
                break;
            case 'cash-drawer':
            try {
              const todayISO = new Date().toISOString().slice(0,10);
              const sales = DataStore.getList('sales').filter(s=> (s.dateISO||'').slice(0,10)===todayISO || s.date===new Date().toLocaleDateString('ar-SA'));
              const expenses = DataStore.getList('expenses').filter(e=> (e.dateISO||'').slice(0,10)===todayISO || e.date===new Date().toLocaleDateString('ar-SA'));
              const returnsList = DataStore.getList('returns').filter(r=> (r.dateISO||'').slice(0,10)===todayISO || r.date===new Date().toLocaleDateString('ar-SA'));
              const isCard = (pm='')=> /card|visa|mada|credit|بطاق|مدى|فيزا|ماستر/i.test(String(pm||''));
              const isCash = (pm='')=> /cash|نقد/i.test(String(pm||''));
              const sum = (arr, f)=> arr.reduce((a,x)=> a + Number((typeof f==='function'? f(x): x[f])||0), 0);
              const cashSales = sum(sales.filter(s=> isCash(s.paymentMethod)), x=> x.total);
              const cardSales = sum(sales.filter(s=> isCard(s.paymentMethod)), x=> x.total);
              const otherSales = Math.max(0, sum(sales, x=> x.total) - cashSales - cardSales);
              const totalReturns = sum(returnsList, x=> x.amount);
              const totalExpenses = sum(expenses, x=> x.amount);
              const cashNet = cashSales - totalExpenses - totalReturns;
              contentHtml += `
                <h3>${ICONS.cash||'💵'} صفحة الصندوق - اليوم</h3>
                <div class="hr"></div>
                <div class="grid">
                  <div class="card stat-card success-light"><div class="stat-label">مبيعات نقد</div><div class="stat-value">${fmt(cashSales)}</div></div>
                  <div class="card stat-card info-light"><div class="stat-label">مبيعات بطاقة</div><div class="stat-value">${fmt(cardSales)}</div></div>
                  <div class="card stat-card"><div class="stat-label">مبيعات أخرى</div><div class="stat-value">${fmt(otherSales)}</div></div>
                  <div class="card stat-card danger-light"><div class="stat-label">المرتجعات</div><div class="stat-value">${fmt(totalReturns)}</div></div>
                  <div class="card stat-card warning-light"><div class="stat-label">المصروفات</div><div class="stat-value">${fmt(totalExpenses)}</div></div>
                  <div class="card stat-card success"><div class="stat-label">صافي النقدية (قبل الحركات)</div><div class="stat-value">${fmt(cashNet)}</div></div>
                </div>
                <div class="hr"></div>
                <div class="form-row">
                  <div class="col-4 form-group">
                    <label>رصيد افتتاحي</label>
                    <input type="number" step="0.01" id="cash-open" value="0" oninput="(function(){var op=Number(document.getElementById('cash-open').value||0);var dep=Number(document.getElementById('cash-deposit').value||0);var wd=Number(document.getElementById('cash-withdraw').value||0);var base=${cashNet};document.getElementById('cash-net-final').textContent = fmt(base+op+dep-wd);})()">
                  </div>
                  <div class="col-4 form-group">
                    <label>إيداع</label>
                    <input type="number" step="0.01" id="cash-deposit" value="0" oninput="(function(){var op=Number(document.getElementById('cash-open').value||0);var dep=Number(document.getElementById('cash-deposit').value||0);var wd=Number(document.getElementById('cash-withdraw').value||0);var base=${cashNet};document.getElementById('cash-net-final').textContent = fmt(base+op+dep-wd);})()">
                  </div>
                  <div class="col-4 form-group">
                    <label>سحب</label>
                    <input type="number" step="0.01" id="cash-withdraw" value="0" oninput="(function(){var op=Number(document.getElementById('cash-open').value||0);var dep=Number(document.getElementById('cash-deposit').value||0);var wd=Number(document.getElementById('cash-withdraw').value||0);var base=${cashNet};document.getElementById('cash-net-final').textContent = fmt(base+op+dep-wd);})()">
                  </div>
                </div>
                <div class="text-right fw-700">صافي النقدية النهائي: <span id="cash-net-final">${fmt(cashNet)}</span></div>
                <div class="mt-10 text-right no-print" style="display:flex; gap:8px; justify-content:flex-end;">
                  <button class="btn" onclick="printReports()">${ICONS.print} طباعة ملخص</button>
                  <button class=\"btn success\" onclick=\"(function(){
                    try{
                      var op=Number(document.getElementById('cash-open').value||0);
                      var dep=Number(document.getElementById('cash-deposit').value||0);
                      var wd=Number(document.getElementById('cash-withdraw').value||0);
                      var base=${cashNet};
                      var finalVal = base+op+dep-wd;
                      var noteEl = document.getElementById('cash-note');
                      var note = noteEl? noteEl.value : '';
                      var arr = [];
                      try{ arr = JSON.parse(localStorage.getItem('cash_sessions')||'[]')||[]; }catch(e){}
                      arr.push({date:'${todayISO}', base:base, open:op, deposit:dep, withdraw:wd, final:finalVal, note:note, ts: Date.now()});
                      localStorage.setItem('cash_sessions', JSON.stringify(arr));
                      if(window.showNotification) showNotification('تم الحفظ','تم حفظ جلسة الصندوق لليوم.','success');
                      var list = document.getElementById('cash-sessions-list');
                      if(list){ list.innerHTML = arr.filter(function(s){ return s.date==='${todayISO}'; }).map(function(s){ return '<li>(' + new Date(s.ts).toLocaleTimeString('ar-SA') + ') افتتاحي: ' + fmt(s.open) + '، إيداع: ' + fmt(s.deposit) + '، سحب: ' + fmt(s.withdraw) + '، نهائي: ' + fmt(s.final) + (s.note ? ' - ملاحظة: ' + s.note : '') + '</li>'; }).join(''); }
                    }catch(e){ console.error(e); if(window.showNotification) showNotification('خطأ','تعذر حفظ جلسة الصندوق.','error'); }
                  })()\">💾 حفظ جلسة</button>
                </div>
                <div class="form-group"><label>ملاحظة</label><input type="text" id="cash-note" placeholder="اختياري"></div>
                <div class="hr"></div>
                <div>
                  <div class="fw-700 mb-5">جلسات اليوم المحفوظة</div>
                  <ul id=\"cash-sessions-list\" class=\"muted-small\" style=\"margin:0; padding-inline-start:18px;\">
                    ${(()=>{ try{ const arr = JSON.parse(localStorage.getItem('cash_sessions')||'[]')||[]; return arr.filter(function(s){ return s.date===todayISO; }).map(function(s){ return '<li>(' + new Date(s.ts).toLocaleTimeString('ar-SA') + ') افتتاحي: ' + fmt(s.open) + '، إيداع: ' + fmt(s.deposit) + '، سحب: ' + fmt(s.withdraw) + '، نهائي: ' + fmt(s.final) + (s.note ? ' - ملاحظة: ' + s.note : '') + '</li>'; }).join(''); }catch(e){ return ''; } })()}
                  </ul>
                </div>
                <div class="mt-15 muted-small">ملاحظة: يتم احتساب صافي النقدية = مبيعات نقد - المصروفات - المرتجعات (بدون رصيد افتتاحي).</div>
              `;
            } catch (e) {
              contentHtml += `<p class="muted">تعذر تحميل بيانات الصندوق.</p>`;
            }
            break;
            case 'warning':
                toast.style.borderRightColor = 'var(--warning)';
                icon.innerHTML = '⚠️';
                break;
            case 'info':
                toast.style.borderRightColor = 'var(--info)';
                icon.innerHTML = 'ℹ️';
                break;
            default: // success
                toast.style.borderRightColor = 'var(--success)';
                icon.innerHTML = '✅';
                break;
        }

        // Show the toast
        toast.classList.add('show');

        // Auto-hide after 5 seconds
        setTimeout(() => {
            setTimeout(hideNotification, 3000);
        }, 5000);
    }

    function hideNotification() {
        document.getElementById('notification-toast').classList.remove('show');
    }

    // Currency format helper
    function fmt(n){
        const num = Number(n)||0;
        const settings = DataStore.load('settings', { currency: 'SAR' });
        const sym = settings.currency==='USD' ? '$' : 'ر.س';
        return `${num.toFixed(2)} ${sym}`;
    }

    // ========== PAGER HELPER ==========
    function renderPager(container, total, page, pageSize, onChangePage, onChangeSize){
        if(!container) return;
        const pages = Math.max(1, Math.ceil(total / pageSize));
        const prevDisabled = page<=1 ? 'disabled' : '';
        const nextDisabled = page>=pages ? 'disabled' : '';
        container.innerHTML = `
            <div class="space-between mt-10">
                <div class="muted">الصفحة ${page} من ${pages} • إجمالي السجلات: ${total}</div>
                <div style="display:flex; gap:8px; align-items:center;">
                    <label class="muted">لكل صفحة</label>
                    <select class="btn" data-act="size">
                        <option value="10" ${pageSize===10?'selected':''}>10</option>
                        <option value="20" ${pageSize===20?'selected':''}>20</option>
                        <option value="50" ${pageSize===50?'selected':''}>50</option>
                        <option value="100" ${pageSize===100?'selected':''}>100</option>
                    </select>
                    <button class="btn sm" ${prevDisabled} data-act="prev">السابق</button>
                    <button class="btn sm" ${nextDisabled} data-act="next">التالي</button>
                </div>
            </div>
        `;
        const prevBtn = container.querySelector('button[data-act="prev"]');
        const nextBtn = container.querySelector('button[data-act="next"]');
        const sizeSel = container.querySelector('select[data-act="size"]');
        if(prevBtn) prevBtn.onclick = ()=> onChangePage(Math.max(1, page-1));
        if(nextBtn) nextBtn.onclick = ()=> onChangePage(Math.min(pages, page+1));
        if(sizeSel) sizeSel.onchange = ()=>{ const sz = parseInt(sizeSel.value,10)||20; onChangeSize && onChangeSize(sz); };
    }

    /**
     * Shows a brief toast message at the bottom center.
     * @param {string} message 
     */
    function showToast(message) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => {
            toast.classList.remove('show');
            // Allow time for CSS transition before hiding completely
            setTimeout(() => {
                 toast.style.visibility = 'hidden'; 
            }, 500);
        }, 3000);
        toast.style.visibility = 'visible';
    }


    /**
     * Toggles the sidebar visibility (for mobile devices).
     */
    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('active');
        // Optional: add backdrop for better mobile UX
    }

    /**
     * Toggles the active tab content within a page.
     * @param {string} contentId - ID of the content div to show.
     * @param {HTMLElement} clickedButton - The tab button clicked.
     */
    function switchTab(contentId, clickedButton) {
        let container = clickedButton.closest('.card');
        if (!container) {
            container = clickedButton.closest('.settings-page')
                      || clickedButton.closest('.stock-page')
                      || clickedButton.closest('.returns-page')
                      || clickedButton.closest('main')
                      || document;
        }

        // Deactivate all tabs
        container.querySelectorAll('.tab').forEach(btn => btn.classList.remove('active'));
        // Hide all tab contents
        container.querySelectorAll('.tab-content').forEach(content => {
            content.style.display = 'none';
            content.classList.remove('active');
        });
        
        // Activate clicked tab and show corresponding content
        clickedButton.classList.add('active');
        const target = container.querySelector(`#${CSS.escape(contentId)}`) || document.getElementById(contentId);
        if (target) {
            target.style.display = 'block';
            target.classList.add('active');
        }
    }
    
    // Specific tab handlers (just wrappers around switchTab for context)
    function switchReturnTab(contentId, clickedButton) {
        switchTab(contentId, clickedButton);
        // Additional logic specific to returns page can go here
    }
    
    function switchStockTab(contentId, clickedButton) {
        switchTab(contentId, clickedButton);
        // Additional logic specific to stock page can go here
    }

    function switchSettingTab(contentId, clickedButton) {
        switchTab(contentId, clickedButton);
        // Additional logic specific to settings page can go here
    }

    function generateReport(type) {
        showToast('جاري توليد التقرير...');
        setTimeout(() => {
            showNotification('تم توليد التقرير', `تم توليد تقرير: ${type}.`, 'success');
        }, 800);
    }

    function startBackup() {
        showToast('جاري إنشاء النسخة الاحتياطية...');
        setTimeout(() => {
            showNotification('اكتملت النسخة الاحتياطية', 'تم إنشاء النسخة بنجاح.', 'success');
        }, 1200);
    }

    function downloadBackup() {
        const keys = ['products','users','customers','suppliers','sales','returns','purchases','expenses','cart','currentUserId','activity','adjustments'];
        const data = {};
        keys.forEach(k=> data[k] = DataStore.load(k));
        const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `backup-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`;
        document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        showNotification('تم التحميل', 'تم تنزيل نسخة احتياطية.', 'success');
        logActivity('تنزيل نسخة احتياطية', 'Settings');
    }

    function confirmDeleteInvoice(id) {
        if (confirm(`هل تريد حذف الفاتورة #${id}؟`)) {
            showNotification('تم الحذف', `تم حذف الفاتورة #${id}.`, 'success');
        }
    }

    function openProductBarcodeOptions(productId){
        const defaults = { name: true, price: true, barcode: true };
        let stored = {};
        try{ stored = JSON.parse(localStorage.getItem('product_barcode_options')||'{}')||{}; }catch(e){ stored = {}; }
        const opts = { ...defaults, ...stored };
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width:360px;">
                <h3>إعدادات طباعة باركود المنتج</h3>
                <div class="hr"></div>
                <div class="form-group" style="display:flex; align-items:center; gap:8px;">
                    <input type="checkbox" id="barcode-opt-name" ${opts.name ? 'checked' : ''}>
                    <label for="barcode-opt-name">إظهار الاسم</label>
                </div>
                <div class="form-group" style="display:flex; align-items:center; gap:8px;">
                    <input type="checkbox" id="barcode-opt-price" ${opts.price ? 'checked' : ''}>
                    <label for="barcode-opt-price">إظهار السعر</label>
                </div>
                <div class="form-group" style="display:flex; align-items:center; gap:8px;">
                    <input type="checkbox" id="barcode-opt-barcode" ${opts.barcode ? 'checked' : ''}>
                    <label for="barcode-opt-barcode">إظهار الباركود</label>
                </div>
                <div class="text-right mt-20" style="display:flex; gap:8px; justify-content:flex-end;">
                    <button type="button" class="btn ghost" id="barcode-cancel">إلغاء</button>
                    <button type="button" class="btn success" id="barcode-print">طباعة</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        modal.classList.add('active');
        const nameEl = modal.querySelector('#barcode-opt-name');
        const priceEl = modal.querySelector('#barcode-opt-price');
        const barcodeEl = modal.querySelector('#barcode-opt-barcode');
        const closeModal = ()=> modal.remove();
        modal.querySelector('#barcode-cancel').onclick = closeModal;
        modal.onclick = (e)=>{ if(e.target===modal) closeModal(); };
        modal.querySelector('#barcode-print').onclick = ()=>{
            const selection = {
                name: !!nameEl.checked,
                price: !!priceEl.checked,
                barcode: !!barcodeEl.checked
            };
            if(!selection.name && !selection.price && !selection.barcode){
                showNotification('تنبيه','اختر عنصراً واحداً على الأقل للطباعة.','warning');
                return;
            }
            localStorage.setItem('product_barcode_options', JSON.stringify(selection));
            printProductBarcode(productId, selection);
            closeModal();
        };
    }

    function printProductBarcode(productId, userOptions){
        try{
            const products = DataStore.getProducts();
            const product = products.find(p=> Number(p.id) === Number(productId));
            if(!product){ showNotification('خطأ','تعذر العثور على المنتج.','error'); return; }
            const settings = DataStore.load('settings', { companyName: 'متجري' });
            const barcodeValue = product.sku || String(product.id);
            let stored = {};
            try{ stored = JSON.parse(localStorage.getItem('product_barcode_options')||'{}')||{}; }catch(e){ stored={}; }
            const defaults = { name: true, price: true, barcode: true };
            const options = { ...defaults, ...stored, ...(userOptions||{}) };
            if(!options.name && !options.price && !options.barcode){ options.barcode = true; }
            const area = document.getElementById('invoice-print-area');
            if(!area) return;
            const priceText = product.price ? `${fmt(product.price)} ر.س` : '-';
            const cardWidth = '60mm';
            let nameBlock = '';
            if(options.name){
                nameBlock = `<div style="text-align:center; font-weight:700; font-size:16px; color:#111827; margin-bottom:10px;">${product.name||''}</div>`;
            }
            let priceBlock = '';
            if(options.price){
                priceBlock = `<div style="text-align:center; margin-bottom:14px;"><span style="display:inline-block; background:#111827; color:#fff; padding:6px 14px; border-radius:18px; font-size:13px;">السعر: ${priceText}</span></div>`;
            }
            let barcodeBlock = '';
            if(options.barcode){
                barcodeBlock = `
                    <div class="barcode-display" style="text-align:center; padding:12px; border:1px dashed #d1d5db; border-radius:12px; background:#f9fafb;">
                        <svg id="print-prod-bc"></svg>
                    </div>
                    <div style="text-align:center; font-size:11px; letter-spacing:3px; color:#4b5563; margin-top:8px;">${barcodeValue}</div>
                `;
            }
            area.innerHTML = `
                <div style="direction:rtl; font-family:'Cairo',sans-serif; width:${cardWidth}; margin:0 auto; background:#fff; padding:16px 14px; border:2px solid #111827; border-radius:18px; box-shadow:0 10px 24px rgba(17,24,39,0.18);">
                    ${nameBlock}
                    ${priceBlock}
                    ${barcodeBlock}
                </div>
            `;
            if(options.barcode){
                try{ if(window.JsBarcode){ JsBarcode('#print-prod-bc', barcodeValue, { format:'CODE128', displayValue:true, font:'Cairo', fontSize:14, text: product.name || barcodeValue }); } }
                catch(e){ console.error('Barcode render error', e); }
            }
            setTimeout(()=> {
                window.print();
                setTimeout(()=>{ area.innerHTML=''; }, 400);
            }, 250);
        }catch(err){ console.error(err); showNotification('خطأ','تعذر طباعة باركود المنتج.','error'); }
    }

    // ========== MODAL FUNCTIONS (Simplified) ==========
    
    /**
     * Opens a modal window with the specified content.
     * @param {string} modalName - Name of the modal to open.
     * @param {object} data - Optional data to pass to the modal.
     */
    function openModal(modalName, data = {}) {
        const modalOverlay = document.getElementById('main-modal');
        const modalContent = modalOverlay.querySelector('.modal-content');

        // Close button always present
        let contentHtml = `<button class="modal-close" onclick="closeModal()">✖</button>`;

        switch(modalName) {
            case 'new-item':
                contentHtml += `
                    <h3>${ICONS.plus} إضافة صنف جديد</h3>
                    <div class="hr"></div>
                    <form id="new-item-form">
                        <div class="form-row">
                            <div class="col-6 form-group">
                                <label>اسم الصنف *</label>
                                <input type="text" required>
                            </div>
                            <div class="col-6 form-group">
                                <label>رمز الباركود / SKU *</label>
                                <input type="text" required>
                            </div>
                            <div class="col-6 form-group">
                                <label>التصنيف</label>
                                <input type="text" placeholder="مثال: مشروبات / حلويات">
                            </div>
                            <div class="col-4 form-group">
                                <label>سعر الشراء (التكلفة)</label>
                                <input type="number" step="0.01" value="0.00" required>
                            </div>
                            <div class="col-4 form-group">
                                <label>سعر البيع</label>
                                <input type="number" step="0.01" value="0.00" required>
                            </div>
                            <div class="col-4 form-group">
                                <label>الكمية الأولية</label>
                                <input type="number" value="0" required>
                            </div>
                            <div class="col-12 form-group">
                                <label>ملاحظات</label>
                                <textarea rows="2"></textarea>
                            </div>
                        </div>
                        <div class="text-right mt-20">
                            <button type="submit" class="btn success lg">حفظ المنتج</button>
                        </div>
                    </form>
                `;
                break;
            case 'new-customer':
                 contentHtml += `<h3>${ICONS.plus} إضافة عميل جديد</h3><div class="hr"></div>
                    <form id="form-new-customer">
                        <div class="form-group"><label>الاسم الكامل *</label><input type="text" required></div>
                        <div class="form-group"><label>رقم الهاتف *</label><input type="tel" required></div>
                        <div class="form-group"><label>البريد الإلكتروني</label><input type="email"></div>
                        <div class="text-right mt-20"><button type="submit" class="btn info lg">حفظ العميل</button></div>
                    </form>
                 `;
                 break;
            case 'cash-drawer':
                try {
                  const todayISO = new Date().toISOString().slice(0,10);
                  const sales = DataStore.getList('sales').filter(s=> (s.dateISO||'').slice(0,10)===todayISO || s.date===new Date().toLocaleDateString('ar-SA'));
                  const expenses = DataStore.getList('expenses').filter(e=> (e.dateISO||'').slice(0,10)===todayISO || e.date===new Date().toLocaleDateString('ar-SA'));
                  const returnsList = DataStore.getList('returns').filter(r=> (r.dateISO||'').slice(0,10)===todayISO || r.date===new Date().toLocaleDateString('ar-SA'));
                  const isCard = (pm='')=> /card|visa|mada|credit|بطاق|مدى|فيزا|ماستر/i.test(String(pm||''));
                  const isCash = (pm='')=> /cash|نقد/i.test(String(pm||''));
                  const sum = (arr, f)=> arr.reduce((a,x)=> a + Number((typeof f==='function'? f(x): x[f])||0), 0);
                  const cashSales = sum(sales.filter(s=> isCash(s.paymentMethod)), x=> x.total);
                  const cardSales = sum(sales.filter(s=> isCard(s.paymentMethod)), x=> x.total);
                  const otherSales = Math.max(0, sum(sales, x=> x.total) - cashSales - cardSales);
                  const totalReturns = sum(returnsList, x=> x.amount);
                  const totalExpenses = sum(expenses, x=> x.amount);
                  const cashNet = cashSales - totalExpenses - totalReturns;
                  contentHtml += `
                    <h3>${ICONS.cash||'💵'} صفحة الصندوق - اليوم</h3>
                    <div class="hr"></div>
                    <div class="grid">
                      <div class="card stat-card success-light"><div class="stat-label">مبيعات نقد</div><div class="stat-value">${fmt(cashSales)}</div></div>
                      <div class="card stat-card info-light"><div class="stat-label">مبيعات بطاقة</div><div class="stat-value">${fmt(cardSales)}</div></div>
                      <div class="card stat-card"><div class="stat-label">مبيعات أخرى</div><div class="stat-value">${fmt(otherSales)}</div></div>
                      <div class="card stat-card danger-light"><div class="stat-label">المرتجعات</div><div class="stat-value">${fmt(totalReturns)}</div></div>
                      <div class="card stat-card warning-light"><div class="stat-label">المصروفات</div><div class="stat-value">${fmt(totalExpenses)}</div></div>
                      <div class="card stat-card success"><div class="stat-label">صافي النقدية (قبل الحركات)</div><div class="stat-value">${fmt(cashNet)}</div></div>
                    </div>
                    <div class="hr"></div>
                    <div class="form-row">
                      <div class="col-4 form-group">
                        <label>رصيد افتتاحي</label>
                        <input type="number" step="0.01" id="cash-open" value="0" oninput="(function(){var op=Number(document.getElementById('cash-open').value||0);var dep=Number(document.getElementById('cash-deposit').value||0);var wd=Number(document.getElementById('cash-withdraw').value||0);var base=${cashNet};document.getElementById('cash-net-final').textContent = fmt(base+op+dep-wd);})()">
                      </div>
                      <div class="col-4 form-group">
                        <label>إيداع</label>
                        <input type="number" step="0.01" id="cash-deposit" value="0" oninput="(function(){var op=Number(document.getElementById('cash-open').value||0);var dep=Number(document.getElementById('cash-deposit').value||0);var wd=Number(document.getElementById('cash-withdraw').value||0);var base=${cashNet};document.getElementById('cash-net-final').textContent = fmt(base+op+dep-wd);})()">
                      </div>
                      <div class="col-4 form-group">
                        <label>سحب</label>
                        <input type="number" step="0.01" id="cash-withdraw" value="0" oninput="(function(){var op=Number(document.getElementById('cash-open').value||0);var dep=Number(document.getElementById('cash-deposit').value||0);var wd=Number(document.getElementById('cash-withdraw').value||0);var base=${cashNet};document.getElementById('cash-net-final').textContent = fmt(base+op+dep-wd);})()">
                      </div>
                    </div>
                    <div class="text-right fw-700">صافي النقدية النهائي: <span id="cash-net-final">${fmt(cashNet)}</span></div>
                    <div class="mt-10 text-right no-print" style="display:flex; gap:8px; justify-content:flex-end;">
                      <button class="btn" onclick="printReports()">${ICONS.print} طباعة ملخص</button>
                      <button class=\"btn success\" onclick=\"(function(){
                        try{
                          var op=Number(document.getElementById('cash-open').value||0);
                          var dep=Number(document.getElementById('cash-deposit').value||0);
                          var wd=Number(document.getElementById('cash-withdraw').value||0);
                          var base=${cashNet};
                          var finalVal = base+op+dep-wd;
                          var noteEl = document.getElementById('cash-note');
                          var note = noteEl? noteEl.value : '';
                          var arr = [];
                          try{ arr = JSON.parse(localStorage.getItem('cash_sessions')||'[]')||[]; }catch(e){}
                          arr.push({date:'${todayISO}', base:base, open:op, deposit:dep, withdraw:wd, final:finalVal, note:note, ts: Date.now()});
                          localStorage.setItem('cash_sessions', JSON.stringify(arr));
                          if(window.showNotification) showNotification('تم الحفظ','تم حفظ جلسة الصندوق لليوم.','success');
                          var list = document.getElementById('cash-sessions-list');
                          if(list){ list.innerHTML = arr.filter(function(s){ return s.date==='${todayISO}'; }).map(function(s){ return '<li>(' + new Date(s.ts).toLocaleTimeString('ar-SA') + ') افتتاحي: ' + fmt(s.open) + '، إيداع: ' + fmt(s.deposit) + '، سحب: ' + fmt(s.withdraw) + '، نهائي: ' + fmt(s.final) + (s.note ? ' - ملاحظة: ' + s.note : '') + '</li>'; }).join(''); }
                        }catch(e){ console.error(e); if(window.showNotification) showNotification('خطأ','تعذر حفظ جلسة الصندوق.','error'); }
                      })()\">💾 حفظ جلسة</button>
                    </div>
                    <div class="form-group"><label>ملاحظة</label><input type="text" id="cash-note" placeholder="اختياري"></div>
                    <div class="hr"></div>
                    <div>
                      <div class="fw-700 mb-5">جلسات اليوم المحفوظة</div>
                      <ul id=\"cash-sessions-list\" class=\"muted-small\" style=\"margin:0; padding-inline-start:18px;\">
                        ${(()=>{ try{ const arr = JSON.parse(localStorage.getItem('cash_sessions')||'[]')||[]; return arr.filter(function(s){ return s.date===todayISO; }).map(function(s){ return '<li>(' + new Date(s.ts).toLocaleTimeString('ar-SA') + ') افتتاحي: ' + fmt(s.open) + '، إيداع: ' + fmt(s.deposit) + '، سحب: ' + fmt(s.withdraw) + '، نهائي: ' + fmt(s.final) + (s.note ? ' - ملاحظة: ' + s.note : '') + '</li>'; }).join(''); }catch(e){ return ''; } })()}
                      </ul>
                    </div>
                    <div class="mt-15 muted-small">ملاحظة: يتم احتساب صافي النقدية = مبيعات نقد - المصروفات - المرتجعات (بدون رصيد افتتاحي).</div>
                  `;
                } catch (e) {
                  contentHtml += `<p class="muted">تعذر تحميل بيانات الصندوق.</p>`;
                }
                break;
            case 'receive-payment':
                (function(){
                    const todayISO = new Date().toISOString().slice(0,10);
                    contentHtml += `
                      <h3>${ICONS.income||'➕'} تسجيل قبض من عميل</h3>
                      <div class="hr"></div>
                      <form onsubmit="(function(ev){ev.preventDefault();
                        try{
                          var cust = document.getElementById('rcv-customer').value||'عميل';
                          var amt = Number(document.getElementById('rcv-amount').value||0);
                          var pm = document.getElementById('rcv-method').value||'cash';
                          var dt = document.getElementById('rcv-date').value||'${todayISO}';
                          var note = document.getElementById('rcv-note').value||'';
                          var arr=[]; try{ arr=JSON.parse(localStorage.getItem('receipts')||'[]')||[]; }catch(e){}
                          arr.push({id: Date.now(), customer:cust, amount:amt, paymentMethod:pm, dateISO:dt, note:note});
                          localStorage.setItem('receipts', JSON.stringify(arr));
                          if(window.showNotification) showNotification('تم الحفظ','تم تسجيل عملية قبض.','success');
                          closeModal();
                        }catch(e){ console.error(e); if(window.showNotification) showNotification('خطأ','تعذر تسجيل عملية القبض.','error'); }
                      })(event)">
                        <div class="form-row">
                          <div class="col-6 form-group"><label>العميل</label><input type="text" id="rcv-customer" placeholder="اسم العميل" required></div>
                          <div class="col-3 form-group"><label>المبلغ</label><input type="number" step="0.01" id="rcv-amount" required></div>
                          <div class="col-3 form-group"><label>التاريخ</label><input type="date" id="rcv-date" value="${todayISO}"></div>
                          <div class="col-6 form-group"><label>طريقة الدفع</label>
                            <select id="rcv-method"><option value="cash">نقد</option><option value="card">بطاقة</option></select>
                          </div>
                          <div class="col-12 form-group"><label>ملاحظة</label><input type="text" id="rcv-note"></div>
                        </div>
                        <div class="text-right mt-10"><button type="submit" class="btn success">حفظ</button></div>
                      </form>
                    `;
                })();
                break;
            case 'make-payment':
                (function(){
                    const todayISO = new Date().toISOString().slice(0,10);
                    contentHtml += `
                      <h3>${ICONS.expense||'➖'} تسجيل دفع لمورد</h3>
                      <div class="hr"></div>
                      <form onsubmit="(function(ev){ev.preventDefault();
                        try{
                          var sup = document.getElementById('pay-supplier').value||'مورد';
                          var amt = Number(document.getElementById('pay-amount').value||0);
                          var pm = document.getElementById('pay-method').value||'cash';
                          var dt = document.getElementById('pay-date').value||'${todayISO}';
                          var note = document.getElementById('pay-note').value||'';
                          var arr=[]; try{ arr=JSON.parse(localStorage.getItem('supplier_payments')||'[]')||[]; }catch(e){}
                          arr.push({id: Date.now(), supplier:sup, amount:amt, paymentMethod:pm, dateISO:dt, note:note});
                          localStorage.setItem('supplier_payments', JSON.stringify(arr));
                          if(window.showNotification) showNotification('تم الحفظ','تم تسجيل عملية دفع.','success');
                          closeModal();
                        }catch(e){ console.error(e); if(window.showNotification) showNotification('خطأ','تعذر تسجيل عملية الدفع.','error'); }
                      })(event)">
                        <div class="form-row">
                          <div class="col-6 form-group"><label>المورد</label><input type="text" id="pay-supplier" placeholder="اسم المورد" required></div>
                          <div class="col-3 form-group"><label>المبلغ</label><input type="number" step="0.01" id="pay-amount" required></div>
                          <div class="col-3 form-group"><label>التاريخ</label><input type="date" id="pay-date" value="${todayISO}"></div>
                          <div class="col-6 form-group"><label>طريقة الدفع</label>
                            <select id="pay-method"><option value="cash">نقد</option><option value="card">بطاقة</option></select>
                          </div>
                          <div class="col-12 form-group"><label>ملاحظة</label><input type="text" id="pay-note"></div>
                        </div>
                        <div class="text-right mt-10"><button type="submit" class="btn danger">حفظ</button></div>
                      </form>
                    `;
                })();
                break;
            case 'show-invoice':
                const invoiceId = data.id || 'N/A';
                const saleData = (typeof DataStore!== 'undefined') ? DataStore.getList('sales').find(s=> String(s.id)===String(invoiceId)) : null;
                const customers = (typeof DataStore!== 'undefined') ? DataStore.getList('customers') : [];
                const saleCustomer = saleData ? (saleData.customerId && saleData.customerId!=='cash' ? (customers.find(c=> String(c.id)===String(saleData.customerId))?.name || saleData.customer || 'عميل') : (saleData.customer || 'عميل نقدي')) : (data.customer || 'عميل نقدي');
                const saleDate = (saleData && saleData.date) || data.date || new Date().toLocaleDateString('ar-SA');
                const itemsRows = (saleData && saleData.items && saleData.items.length)
                    ? saleData.items.map(it=>`<tr><td>${it.name}</td><td>${it.qty}</td><td>${fmt(Number(it.price))}</td><td>${fmt(Number(it.price)*Number(it.qty))}</td></tr>`).join('')
                    : `<tr><td colspan="4" class="text-center muted">لا توجد بنود</td></tr>`;
                const totalFinal = (saleData && saleData.total) ? fmt(Number(saleData.total)) : fmt(Number(data.total||0));
                contentHtml += `
                    <h3>${ICONS.view} عرض الفاتورة #${invoiceId}</h3>
                    <div class="hr"></div>
                    <div id="invoice-details-content">
                        <div class="space-between mb-10">
                            <strong>العميل:</strong> <span>${saleCustomer}</span>
                        </div>
                        <div class="space-between mb-10">
                            <strong>التاريخ:</strong> <span>${saleDate}</span>
                        </div>
                        <div class="table-container mb-20">
                            <table class="fs-small">
                                <thead>
                                    <tr>
                                        <th>المنتج</th><th>الكمية</th><th>السعر</th><th>الإجمالي</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${itemsRows}
                                </tbody>
                            </table>
                        </div>
                        <div class="text-right fw-700">الإجمالي النهائي: ${totalFinal}</div>
                    </div>
                    <div class="text-right mt-20 no-print">
                        <button class="btn success" onclick="printInvoice('${invoiceId}')">${ICONS.print} طباعة حرارية</button>
                        <button class="btn ghost" onclick="printInvoiceA4('${invoiceId}')">${ICONS.print} طباعة A4</button>
                        <button class="btn danger" onclick="deleteSale(${invoiceId})">${ICONS.trash} حذف</button>
                    </div>
                `;
                break;
            case 'new-sale':
                contentHtml += `
                    <h3>${ICONS.plus} فاتورة مبيعات جديدة</h3>
                    <div class="hr"></div>
                    <form id="form-new-sale">
                        <div class="form-row">
                            <div class="col-6 form-group">
                                <label>العميل</label>
                                <input type="text" placeholder="اسم العميل أو نقدي" value="عميل نقدي">
                            </div>
                            <div class="col-6 form-group">
                                <label>تاريخ الفاتورة</label>
                                <input type="date" value="${new Date().toISOString().slice(0,10)}">
                            </div>
                            <div class="col-12 form-group">
                                <label>ملاحظات</label>
                                <textarea rows="2" placeholder="ملاحظات اختيارية"></textarea>
                            </div>
                        </div>
                        <div class="empty-state">
                            <span class="icon">🧾</span>
                            <h4>إضافة بنود الفاتورة من شاشة نقطة البيع</h4>
                            <p class="muted-small">استخدم شاشة نقطة البيع لإضافة المنتجات ثم عد لإتمام البيانات.</p>
                            <div class="mt-15"><button type="button" class="btn success" onclick="closeModal(); App.navigateTo('pos')">الانتقال إلى نقطة البيع</button></div>
                        </div>
                        <div class="text-right mt-20">
                            <button type="submit" class="btn success">حفظ الفاتورة</button>
                        </div>
                    </form>
                `;
                break;
            case 'new-sale-return':
                contentHtml += `
                    <h3>${ICONS.plus} تسجيل مرتجع بيع</h3>
                    <div class="hr"></div>
                    <form id="form-sale-return">
                        <div class="form-row">
                            <div class="col-6 form-group">
                                <label>رقم الفاتورة</label>
                                <input type="text" placeholder="#0000" required>
                            </div>
                            <div class="col-6 form-group">
                                <label>التاريخ</label>
                                <input type="date" value="${new Date().toISOString().slice(0,10)}">
                            </div>
                            <div class="col-12 form-group">
                                <label>السبب</label>
                                <textarea rows="2" required></textarea>
                            </div>
                        </div>
                        <div class="text-right mt-20"><button type="submit" class="btn warning">تسجيل المرتجع</button></div>
                    </form>
                `;
                break;
            case 'new-purchase':
                contentHtml += `
                    <h3>${ICONS.plus} فاتورة شراء</h3>
                    <div class="hr"></div>
                    <form id="form-new-purchase">
                        <div class="form-row">
                            <div class="col-6 form-group">
                                <label>المورد</label>
                                <input type="text" id="np-supplier" placeholder="اسم المورد" required>
                            </div>
                            <div class="col-6 form-group">
                                <label>التاريخ</label>
                                <input type="date" id="np-date" value="${new Date().toISOString().slice(0,10)}">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>بنود الفاتورة</label>
                            <div class="table-container">
                                <table id="np-items-table">
                                    <thead>
                                        <tr>
                                            <th>SKU</th>
                                            <th>الاسم</th>
                                            <th>الكمية</th>
                                            <th>سعر الوحدة</th>
                                            <th>الإجمالي</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                            <div class="mt-10"><button type="button" class="btn sm" id="np-add-line">إضافة بند</button></div>
                        </div>
                        <div class="totals">
                            <div>الإجمالي:</div>
                            <div id="np-total">0.00</div>
                        </div>
                        <div class="text-right mt-20"><button type="submit" class="btn purple">حفظ فاتورة الشراء</button></div>
                    </form>
                `;
                break;
            case 'import-items':
                contentHtml += `
                    <h3>${ICONS.upload} استيراد أصناف من ملف</h3>
                    <div class="hr"></div>
                    <div class="form-group"><label>ملف Excel</label><input id="import-file" type="file" accept=".xlsx,.xls"></div>
                    <div class="text-right mt-20">
                        <button class="btn info" onclick="showToast('بدء الاستيراد'); showNotification('استيراد الأصناف', 'سيتم معالجة الملف ودمج الأصناف.', 'info');">بدء الاستيراد</button>
                    </div>
                `;
                break;
            case 'export-items':
                contentHtml += `
                    <h3>${ICONS.download} تصدير الأصناف</h3>
                    <div class="hr"></div>
                    <div class="form-row">
                        <div class="col-6 form-group"><label>الصيغة</label><select id="export-format"><option value="xlsx">Excel (.xlsx)</option><option value="csv">CSV</option></select></div>
                        <div class="col-6 form-group"><label>نطاق البيانات</label><select id="export-range"><option value="all">كل الأصناف</option><option value="low-stock">الأصناف قليلة المخزون</option></select></div>
                    </div>
                    <div class="text-right mt-20">
                        <button class="btn" onclick="showNotification('تصدير البيانات', 'تم تجهيز الملف للتنزيل.', 'success');">تنزيل</button>
                    </div>
                `;
                break;
            case 'print-barcodes':
                contentHtml += `
                    <h3>${ICONS.print} طباعة باركود</h3>
                    <div class="hr"></div>
                    <div class="form-row">
                        <div class="col-8 form-group"><label>الرمز</label><input id="barcode-text" type="text" placeholder="أدخل SKU أو باركود" value="SKU001"></div>
                        <div class="col-4 form-group"><label>الكمية</label><input id="barcode-count" type="number" value="1" min="1"></div>
                    </div>
                    <div id="barcode-wrap" class="barcode-display"></div>
                    <div class="text-right mt-20 no-print"><button class="btn success" onclick="window.print()">طباعة</button></div>
                `;
                break;
                case 'new-adjustment':
                    contentHtml += `
                    <h3>${ICONS.plus} تسوية مخزون</h3>
                    <div class="hr"></div>
                    <form id="form-adjustment">
                        <div class="form-row">
                            <div class="col-6 form-group"><label>الصنف</label><input type="text" placeholder="اسم الصنف أو الرمز" required></div>
                            <div class="col-3 form-group"><label>التغيير</label><input type="number" value="1"></div>
                            <div class="col-3 form-group"><label>النوع</label><select><option value="increase">زيادة</option><option value="decrease">نقص</option></select></div>
                            <div class="col-12 form-group"><label>السبب</label><textarea rows="2"></textarea></div>
                        </div>
                        <div class="text-right mt-20"><button type="submit" class="btn warning">تسجيل التسوية</button></div>
                    </form>
                `;
                break;
            case 'new-supplier':
                contentHtml += `
                    <h3>${ICONS.plus} إضافة مورد</h3>
                    <div class="hr"></div>
                    <form id="form-supplier">
                        <div class="form-row">
                            <div class="col-6 form-group"><label>الاسم التجاري</label><input type="text" required></div>
                            <div class="col-6 form-group"><label>رقم الهاتف</label><input type="tel"></div>
                            <div class="col-12 form-group"><label>العنوان</label><input type="text"></div>
                        </div>
                        <div class="text-right mt-20"><button type="submit" class="btn purple">حفظ المورد</button></div>
                    </form>
                `;
                break;
            case 'new-expense':
                contentHtml += `
                    <h3>${ICONS.plus} تسجيل مصروف</h3>
                    <div class="hr"></div>
                    <form id="form-expense">
                        <div class="form-row">
                            <div class="col-6 form-group"><label>الوصف</label><input type="text" required></div>
                            <div class="col-3 form-group"><label>المبلغ</label><input type="number" step="0.01" value="0" required></div>
                            <div class="col-3 form-group"><label>التاريخ</label><input type="date" value="${new Date().toISOString().slice(0,10)}"></div>
                            <div class="col-12 form-group"><label>التصنيف</label><select><option>إيجار</option><option>رواتب</option><option>فواتير</option><option>أخرى</option></select></div>
                        </div>
                        <div class="text-right mt-20"><button type="submit" class="btn danger">حفظ المصروف</button></div>
                    </form>
                `;
                break;
            case 'new-user':
                contentHtml += `
                    <h3>${ICONS.plus} إضافة مستخدم جديد</h3>
                    <div class="hr"></div>
                    <form id="form-user">
                        <div class="form-row">
                            <div class="col-6 form-group"><label>الاسم</label><input type="text" required></div>
                            <div class="col-6 form-group"><label>الدور</label><select><option>مدير</option><option>أمين صندوق</option><option>مشرف</option></select></div>
                            <div class="col-6 form-group"><label>اسم المستخدم</label><input type="text" required></div>
                            <div class="col-6 form-group"><label>كلمة المرور</label><input type="password" required></div>
                        </div>
                        <div class="text-right mt-20"><button type="submit" class="btn success">حفظ المستخدم</button></div>
                    </form>
                `;
                break;
            case 'restore-backup':
                contentHtml += `
                    <h3>${ICONS.upload} استعادة نسخة احتياطية</h3>
                    <div class="hr"></div>
                    <div class="form-group"><label>ملف النسخة</label><input id="restore-file" type="file" accept=".zip,.json"></div>
                    <div class="text-right mt-20"><button class="btn warning" onclick="showNotification('استعادة النسخة', 'سيتم استعادة البيانات من النسخة المحددة.', 'info')">بدء الاستعادة</button></div>
                `;
                break;
            case 'edit-item':
                contentHtml += `
                    <h3>${ICONS.edit} تعديل صنف</h3>
                    <div class="hr"></div>
                    <form id="form-edit-item">
                        <div class="form-row">
                            <div class="col-6 form-group"><label>اسم الصنف</label><input type="text" value="${(data && data.name) || ''}"></div>
                            <div class="col-6 form-group"><label>الرمز/SKU</label><input type="text" value="${(data && data.sku) || ''}"></div>
                            <div class="col-6 form-group"><label>التصنيف</label><input type="text" value="${(data && data.category) || ''}"></div>
                            <div class="col-4 form-group"><label>سعر الشراء</label><input type="number" step="0.01" value="${(data && data.cost) || 0}"></div>
                            <div class="col-4 form-group"><label>سعر البيع</label><input type="number" step="0.01" value="${(data && data.price) || 0}"></div>
                            <div class="col-4 form-group"><label>الكمية</label><input type="number" value="${(data && data.stock) || 0}"></div>
                        </div>
                        <div class="text-right mt-20"><button type="submit" class="btn info">حفظ التعديلات</button></div>
                    </form>
                `;
                break;
            default:
                contentHtml += `<h3>${modalName}</h3><p>لا يوجد محتوى محدد لهذه النافذة.</p>`;
                break;
        }

        modalContent.innerHTML = contentHtml;
        // Bind modal actions
        try {
            switch(modalName){
                case 'new-customer': {
                    const form = modalContent.querySelector('#form-new-customer');
                    if(form){
                        form.onsubmit = (e)=>{
                            e.preventDefault();
                            const [nameEl, phoneEl, emailEl] = form.querySelectorAll('input');
                            const customers = DataStore.getList('customers');
                            const id = DataStore.nextId('customers');
                            const customer = { id, name: (nameEl.value||'').trim(), phone: (phoneEl.value||'').trim(), email: (emailEl.value||'').trim(), createdAt: new Date().toISOString().slice(0,10), balance: 0, totalSales: 0 };
                            customers.push(customer);
                            DataStore.setList('customers', customers);
                            showNotification('تم الحفظ', 'تمت إضافة العميل.', 'success');
                            logActivity(`إضافة عميل ${customer.name}`, 'Customers');
                            closeModal();
                            if(document.getElementById('page-customers')?.classList.contains('active')) initializeCustomers();
                        };
                    }
                    break;
                }
                case 'new-purchase': {
                    const form = modalContent.querySelector('#form-new-purchase');
                    if(form){
                        const tbody = form.querySelector('#np-items-table tbody');
                        const totalEl = form.querySelector('#np-total');
                        const addLine = () => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td><input type="text" class="np-sku" placeholder="SKU"></td>
                                <td><input type="text" class="np-name" placeholder="اسم المنتج"></td>
                                <td><input type="number" class="np-qty" value="1" min="1" style="width:90px"></td>
                                <td><input type="number" class="np-price" value="0" step="0.01" style="width:110px"></td>
                                <td class="np-line-total">0.00</td>
                                <td><button type="button" class="btn xs danger np-remove">${ICONS.trash}</button></td>
                            `;
                            tbody.appendChild(tr);
                            bindRow(tr);
                            recalc();
                        };
                        const recalc = () => {
                            let sum = 0;
                            tbody.querySelectorAll('tr').forEach(tr => {
                                const qty = Number(tr.querySelector('.np-qty').value||0);
                                const price = Number(tr.querySelector('.np-price').value||0);
                                const line = qty*price;
                                tr.querySelector('.np-line-total').textContent = line.toFixed(2);
                                sum += line;
                            });
                            totalEl.textContent = sum.toFixed(2);
                        };
                        const bindRow = (tr) => {
                            tr.querySelectorAll('.np-qty,.np-price').forEach(inp => inp.oninput = recalc);
                            tr.querySelector('.np-remove').onclick = () => { tr.remove(); recalc(); };
                        };
                        form.querySelector('#np-add-line').onclick = addLine;
                        // start with one row
                        addLine();

                        form.onsubmit = (e)=>{
                            e.preventDefault();
                            const supplier = form.querySelector('#np-supplier').value||'';
                            const date = form.querySelector('#np-date').value||new Date().toISOString().slice(0,10);
                            const items = [];
                            tbody.querySelectorAll('tr').forEach(tr => {
                                const sku = (tr.querySelector('.np-sku').value||'').trim();
                                const name = (tr.querySelector('.np-name').value||'').trim();
                                const qty = Number(tr.querySelector('.np-qty').value||0);
                                const price = Number(tr.querySelector('.np-price').value||0);
                                if(qty>0){ items.push({ sku, name, qty, price }); }
                            });
                            const total = Number(totalEl.textContent||'0');
                            // save purchase
                            const purchases = DataStore.getList('purchases');
                            const id = DataStore.nextId('purchases');
                            purchases.push({ id, supplier, date, status: 'مسجلة', total, items });
                            DataStore.setList('purchases', purchases);
                            // update stock
                            const products = DataStore.getProducts();
                            items.forEach(it => {
                                let idx = -1;
                                if(it.sku) idx = products.findIndex(p=> String(p.sku)===String(it.sku));
                                if(idx<0 && it.name) idx = products.findIndex(p=> String(p.name)===String(it.name));
                                if(idx>-1){
                                    products[idx].stock = Math.max(0, Number(products[idx].stock||0) + Number(it.qty||0));
                                    if(!products[idx].price || products[idx].price===0){ products[idx].price = Number(it.price||products[idx].price||0); }
                                } else {
                                    const newId = DataStore.nextId('products', 100);
                                    products.push({ id: newId, sku: it.sku||`SKU${newId}`, name: it.name||`منتج ${newId}`, price: Number(it.price||0), stock: Number(it.qty||0), reorder: 0, category: '' });
                                }
                            });
                            DataStore.setList('products', products);
                            showNotification('تم الحفظ', `تمت إضافة فاتورة شراء #${id}.`, 'success');
                            logActivity(`فاتورة شراء لمورد ${supplier}`, 'Purchases');
                            closeModal();
                            if(document.getElementById('page-purchases')?.classList.contains('active')) initializePurchases();
                            if(document.getElementById('page-stock')?.classList.contains('active')) initializeStock();
                            if(document.getElementById('page-items')?.classList.contains('active')) initializeItems();
                        };
                    }
                    break;
                }
                case 'new-item': {
                    const form = modalContent.querySelector('#new-item-form');
                    if(form){
                        form.onsubmit = (e)=>{
                            e.preventDefault();
                            const nameEl = form.querySelector('input[required]');
                            const skuEl = form.querySelectorAll('input[required]')[1];
                            const categoryEl = form.querySelector('input[placeholder^="مثال:"]');
                            const costEl = form.querySelector('input[step="0.01"]');
                            const priceEl = form.querySelectorAll('input[step="0.01"]')[1];
                            const qtyEl = form.querySelector('input[type="number"][value="0"]');
                            const notesEl = form.querySelector('textarea');
                            const products = DataStore.getProducts();
                            const id = DataStore.nextId('products', 100);
                            products.push({ id, sku: (skuEl.value||'').trim() || `SKU${id}`, name: (nameEl.value||'').trim()||`منتج ${id}`, category: (categoryEl?.value||'').trim(), price: Number(priceEl.value||0), stock: Number(qtyEl.value||0), reorder: 0, cost: Number(costEl.value||0), notes: (notesEl && notesEl.value)||'' });
                            DataStore.setList('products', products);
                            showNotification('تم الحفظ', 'تمت إضافة الصنف بنجاح.', 'success');
                            logActivity(`إضافة صنف ${skuEl.value||`SKU${id}`}`, 'Items');
                            closeModal();
                            if(document.getElementById('page-items')?.classList.contains('active')) initializeItems();
                        };
                    }
                    break;
                }
                case 'edit-item': {
                    const form = modalContent.querySelector('#form-edit-item');
                    if(form){
                        form.onsubmit = (e)=>{
                            e.preventDefault();
                            const inputs = form.querySelectorAll('input');
                            const [nameEl, skuEl, categoryEl, costEl, priceEl, qtyEl] = inputs;
                            const products = DataStore.getProducts();
                            const idx = products.findIndex(p=> String(p.id)===String(data.id));
                            if(idx>-1){
                                products[idx] = { ...products[idx], name: nameEl.value||products[idx].name, sku: skuEl.value||products[idx].sku, category: categoryEl.value||products[idx].category||'', price: Number(priceEl.value||products[idx].price), stock: Number(qtyEl.value||products[idx].stock), cost: Number(costEl.value||products[idx].cost||0) };
                                DataStore.setList('products', products);
                                showNotification('تم التحديث', 'تم حفظ تعديلات الصنف.', 'success');
                                logActivity(`تعديل صنف ${products[idx].sku}`, 'Items');
                                closeModal();
                                if(document.getElementById('page-items')?.classList.contains('active')) initializeItems();
                            } else {
                                showNotification('خطأ', 'تعذر العثور على الصنف المطلوب.', 'error');
                            }
                        };
                    }
                    break;
                }
                case 'import-items': {
                    const fileEl = modalContent.querySelector('#import-file');
                    if(fileEl){
                        fileEl.onchange = async ()=>{
                            const file = fileEl.files[0]; if(!file) return;
                            const buf = await file.arrayBuffer();
                            const wb = XLSX.read(buf, { type: 'array' });
                            const ws = wb.Sheets[wb.SheetNames[0]];
                            const rows = XLSX.utils.sheet_to_json(ws, { defval: '' });
                            const products = DataStore.getProducts();
                            rows.forEach(r=>{
                                const id = DataStore.nextId('products', 100);
                                products.push({ id, sku: String(r.sku||r.SKU||`SKU${id}`), name: String(r.name||r.الاسم||`منتج ${id}`), category: String(r.category||r.التصنيف||''), price: Number(r.price||r.سعر||0), stock: Number(r.stock||r.كمية||0), reorder: Number(r.reorder||r.حد_إعادة||0) });
                            });
                            DataStore.setList('products', products);
                            showNotification('نجاح', `تم استيراد ${rows.length} صنف.`, 'success');
                            logActivity(`استيراد ${rows.length} صنف`, 'Items');
                            if(document.getElementById('page-items')?.classList.contains('active')) initializeItems();
                        };
                    }
                    break;
                }
                case 'export-items': {
                    const btn = modalContent.querySelector('.btn');
                    if(btn){
                        btn.onclick = ()=>{
                            const fmt = modalContent.querySelector('#export-format')?.value || 'xlsx';
                            const range = modalContent.querySelector('#export-range')?.value || 'all';
                            let rows = DataStore.getProducts();
                            if(range==='low-stock') rows = rows.filter(p=> p.stock < (p.reorder||0));
                            const data = rows.map(p=> ({ id:p.id, sku:p.sku, name:p.name, category:p.category||'', price:p.price, stock:p.stock, reorder:p.reorder||0 }));
                            const ws = XLSX.utils.json_to_sheet(data);
                            const wb = XLSX.utils.book_new();
                            XLSX.utils.book_append_sheet(wb, ws, 'Products');
                            if(fmt==='csv') { XLSX.writeFile(wb, 'products.csv', { bookType: 'csv' }); }
                            else { XLSX.writeFile(wb, 'products.xlsx'); }
                            showNotification('تصدير', 'تم تجهيز الملف للتنزيل.', 'success');
                            logActivity('تصدير الأصناف', 'Items');
                        };
                    }
                    break;
                }
                case 'new-expense': {
                    const form = modalContent.querySelector('#form-expense');
                    if(form){
                        form.onsubmit = (e)=>{
                            e.preventDefault();
                            const [descEl, amtEl, dateEl, catEl] = form.querySelectorAll('input, select');
                            const expenses = DataStore.getList('expenses');
                            const id = DataStore.nextId('expenses');
                            expenses.push({ id, date: dateEl.value||new Date().toISOString().slice(0,10), description: descEl.value||'', category: catEl.value||'', amount: Number(amtEl.value||0) });
                            DataStore.setList('expenses', expenses);
                            showNotification('تم الحفظ', 'تم تسجيل المصروف.', 'success');
                            logActivity(`تسجيل مصروف ${Number(amtEl.value||0).toFixed(2)} ر.س`, 'Expenses');
                            closeModal();
                            if(document.getElementById('page-expenses')?.classList.contains('active')) initializeExpenses();
                        };
                    }
                    break;
                }
                case 'new-supplier': {
                    const form = modalContent.querySelector('#form-supplier');
                    if(form){
                        form.onsubmit = (e)=>{
                            e.preventDefault();
                            const [nameEl, phoneEl, addrEl] = form.querySelectorAll('input');
                            const suppliers = DataStore.getList('suppliers');
                            const id = DataStore.nextId('suppliers');
                            suppliers.push({ id, name: nameEl.value||'', phone: phoneEl.value||'', address: addrEl.value||'', balance: 0, totalPurchases: 0 });
                            DataStore.setList('suppliers', suppliers);
                            showNotification('تم الحفظ', 'تمت إضافة المورد.', 'success');
                            logActivity(`إضافة مورد ${nameEl.value||id}`, 'Suppliers');
                            closeModal();
                            if(document.getElementById('page-suppliers')?.classList.contains('active')) initializeSuppliers();
                        };
                    }
                    break;
                }
                case 'new-user': {
                    const form = modalContent.querySelector('#form-user');
                    if(form){
                        form.onsubmit = (e)=>{
                            e.preventDefault();
                            const [nameEl, roleEl, usernameEl, passEl] = form.querySelectorAll('input, select');
                            const users = DataStore.getUsers();
                            const id = (usernameEl.value||'').trim() || `user_${DataStore.nextId('users')}`;
                            users.push({ id, name: nameEl.value||id, role: roleEl.value||'مشرف' });
                            DataStore.setList('users', users);
                            App.populateUserSwitcher();
                            showNotification('تم الحفظ', 'تمت إضافة المستخدم.', 'success');
                            logActivity(`إضافة مستخدم ${id}`, 'Settings');
                            closeModal();
                        };
                    }
                    break;
                }
                case 'restore-backup': {
                    const btn = modalContent.querySelector('.btn.warning');
                    const fileEl = modalContent.querySelector('#restore-file');
                    if(btn && fileEl){
                        btn.onclick = async ()=>{
                            const file = fileEl.files?.[0]; if(!file){ showToast('يرجى اختيار ملف'); return; }
                            const text = await file.text();
                            const data = JSON.parse(text);
                            const keys = ['products','users','customers','suppliers','sales','returns','purchases','expenses','cart','currentUserId','activity','adjustments'];
                            keys.forEach(k=>{ if(data[k]!==undefined) DataStore.save(k, data[k]); });
                            showNotification('استعادة', 'تم استعادة البيانات. سيتم تحديث الصفحة.', 'success');
                            logActivity('استعادة نسخة احتياطية', 'Settings');
                            setTimeout(()=> location.reload(), 700);
                        };
                    }
                    break;
                }
                case 'new-sale-return': {
                    const form = modalContent.querySelector('#form-sale-return');
                    if(form){
                        form.onsubmit = (e)=>{
                            e.preventDefault();
                            const [invoiceEl, dateEl, reasonEl] = form.querySelectorAll('input, textarea');
                            const saleId = String(invoiceEl.value||'');
                            const sales = DataStore.getList('sales');
                            const sale = sales.find(s=> String(s.id)===saleId);
                            if(!sale){ showNotification('خطأ', 'لم يتم العثور على الفاتورة.', 'error'); return; }
                            // reverse stock
                            const products = DataStore.getProducts();
                            (sale.items||[]).forEach(it=>{
                                const idx = products.findIndex(p=> p.id===it.id);
                                if(idx>-1){ products[idx].stock = (products[idx].stock||0) + (it.qty||0); }
                            });
                            DataStore.setList('products', products);
                            const returns = DataStore.getList('returns');
                            const rid = DataStore.nextId('returns');
                            returns.push({ id: rid, saleId: sale.id, date: dateEl.value||new Date().toISOString().slice(0,10), amount: sale.total||0, reason: reasonEl.value||'' });
                            DataStore.setList('returns', returns);
                            showNotification('نجاح', `تم تسجيل المرتجع للفاتورة #${sale.id}.`, 'success');
                            logActivity(`مرتجع بيع للفاتورة #${sale.id}`, 'Returns');
                            closeModal();
                            if(document.getElementById('page-stock')?.classList.contains('active')) initializeStock();
                            if(document.getElementById('page-items')?.classList.contains('active')) initializeItems();
                        };
                    }
                    break;
                }
                case 'new-customer': {
                    // log done on submit above
                    break;
                }
                case 'new-purchase': {
                    const form = modalContent.querySelector('#form-new-purchase');
                    if(form){
                        const [supplierEl] = form.querySelectorAll('input');
                        form.addEventListener('submit', ()=>{ logActivity(`فاتورة شراء لمورد ${supplierEl.value||''}`, 'Purchases'); });
                    }
                    break;
                }
                case 'new-adjustment': {
                    const form = modalContent.querySelector('#form-adjustment');
                    if(form){
                        form.onsubmit = (e)=>{
                            e.preventDefault();
                            const [itemEl, changeEl, typeEl, reasonEl] = form.querySelectorAll('input, select, textarea');
                            const term = (itemEl.value||'').trim();
                            const change = Number(changeEl.value||0);
                            const type = typeEl.value||'increase';
                            const products = DataStore.getProducts();
                            const prod = products.find(p=> p.sku===term || p.name===term);
                            if(!prod){ showNotification('خطأ','لم يتم العثور على الصنف.', 'error'); return; }
                            const delta = type==='increase' ? change : -change;
                            prod.stock = Math.max(0, Number(prod.stock||0) + delta);
                            DataStore.setList('products', products);
                            const adj = DataStore.getList('adjustments');
                            const id = DataStore.nextId('adjustments');
                            adj.push({ id, date: new Date().toISOString().slice(0,10), sku: prod.sku, name: prod.name, change: delta, reason: (reasonEl && reasonEl.value)||'' });
                            DataStore.setList('adjustments', adj);
                            showNotification('تمت التسوية', `تم تحديث رصيد ${prod.sku} بمقدار ${delta}.`, 'success');
                            logActivity(`تسوية مخزون ${prod.sku} (${delta})`, 'Stock');
                            closeModal();
                            if(document.getElementById('page-stock')?.classList.contains('active')) initializeStock();
                            if(document.getElementById('page-items')?.classList.contains('active')) initializeItems();
                        };
                    }
                    break;
                }
            }
        } catch(err){ console.error('Modal bind error', err); }
        modalOverlay.classList.add('active');
    }

    function closeModal() {
        const overlay = document.getElementById('main-modal');
        overlay.classList.remove('active');
        overlay.querySelector('.modal-content').innerHTML = '';
        try { document.removeEventListener('keydown', __modalKeydownTrap, true); } catch {}
        // restore focus
        try { if(window.__lastFocusedElement && typeof window.__lastFocusedElement.focus==='function'){ window.__lastFocusedElement.focus(); } } catch {}
    }

    // Global modal keydown trap for focus and ESC to close
    function __modalKeydownTrap(e){
        const overlay = document.getElementById('main-modal');
        if(!overlay || !overlay.classList.contains('active')) return;
        const content = overlay.querySelector('.modal-content');
        const focusables = content ? Array.from(content.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])')) : [];
        if(e.key === 'Escape'){ e.preventDefault(); closeModal(); return; }
        if(e.key !== 'Tab' || focusables.length===0) return;
        const first = focusables[0];
        const last = focusables[focusables.length-1];
        if(e.shiftKey){
            if(document.activeElement === first){ e.preventDefault(); last.focus(); }
        } else {
            if(document.activeElement === last){ e.preventDefault(); first.focus(); }
        }
    }

    function showQuickStats() {
        openModal('quick-stats');
    }


    // ========== CORE APPLICATION LOGIC (App Object) ==========

    const App = {
        /**
         * Initializes the navigation bar based on the PAGES object.
         */
        initNavigation() {
            const navContainer = document.getElementById('mainNav');
            navContainer.innerHTML = ''; // Clear existing navigation
            
            Object.keys(PAGES).forEach(key => {
                const page = PAGES[key];
                const listItem = document.createElement('li');
                listItem.dataset.page = key;
                listItem.innerHTML = `<span class="nav-icon">${page.icon}</span> ${page.label}`;
                listItem.onclick = () => App.navigateTo(key);
                navContainer.appendChild(listItem);
            });
            
            // Append Logout/Exit button
            const logoutItem = document.createElement('li');
            logoutItem.style.marginTop = '20px';
            logoutItem.style.color = 'var(--danger)';
            logoutItem.innerHTML = `<span class="nav-icon">${ICONS.x}</span> تسجيل الخروج`;
            logoutItem.onclick = () => logout();
            navContainer.appendChild(logoutItem);

            // Populate user switcher
            this.populateUserSwitcher();
        },

        /**
         * Switches the main content area to the specified page.
         * @param {string} pageKey - Key from the PAGES object (e.g., 'dashboard', 'pos').
         */
        navigateTo(pageKey) {
            if (!PAGES[pageKey]) {
                showNotification('خطأ', 'الصفحة المطلوبة غير موجودة.', 'error');
                return;
            }

            const pageContent = document.getElementById('page-content');
            const navItems = document.querySelectorAll('#mainNav li');

            // Deactivate current active page/nav item
            document.querySelectorAll('#page-content > div.active').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('#mainNav li.active').forEach(el => el.classList.remove('active'));

            // Check if page content already exists
            let pageDiv = document.getElementById(`page-${pageKey}`);
            if (!pageDiv) {
                // Create and insert the new page content
                pageDiv = document.createElement('div');
                pageDiv.id = `page-${pageKey}`;
                pageDiv.innerHTML = PAGES[pageKey].content;
                pageContent.appendChild(pageDiv);
            }

            // Activate the new page content and navigation item
            pageDiv.classList.add('active');
            document.querySelector(`#mainNav li[data-page="${pageKey}"]`).classList.add('active');

            // Run the page's initialization function if it exists
            if (PAGES[pageKey].init) {
                PAGES[pageKey].init();
            }
            
            // Close sidebar on navigation (for mobile)
            if (window.innerWidth <= 768) {
                toggleSidebar();
            }
        },
        
        /**
         * Populates the user selection dropdown.
         */
        populateUserSwitcher() {
            const select = document.getElementById('user-select');
            select.innerHTML = '';
            DataStore.getUsers().forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = `${user.name} (${user.role})`;
                if (user.id === DataStore.load('currentUserId')) option.selected = true;
                select.appendChild(option);
            });
            document.getElementById('welcome-user').textContent = currentUser.name;
        },

        /**
         * Simulates switching the current logged-in user.
         * @param {string} userId 
         */
        switchUser(userId) {
            const newCurrentUser = DataStore.getUsers().find(u => u.id === userId);
            if (newCurrentUser) {
                DataStore.setCurrentUser(newCurrentUser.id);
                currentUser = newCurrentUser;
                document.getElementById('welcome-user').textContent = currentUser.name;
                showNotification('تبديل المستخدم', `أهلاً بك، ${currentUser.name}.`, 'info');
                App.navigateTo('dashboard'); // Redirect to dashboard after login/switch
            }
        }
    };
    
    // ========== UI LOGIC (UI Object) ==========

    const UI = {
        /**
         * Toggles between light and dark themes.
         */
        toggleTheme() {
            document.body.classList.toggle('dark-theme');
            // Save preference to localStorage (optional, but good practice)
            const isDark = document.body.classList.contains('dark-theme');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            showToast(isDark ? 'تم تفعيل الوضع الليلي 🌙' : 'تم تفعيل الوضع النهاري ☀️');
        },

        /**
         * Applies the user's saved theme preference on load.
         */
        loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-theme');
            } else if (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                // Default to system preference if no save found
                document.body.classList.add('dark-theme');
            }
        },

    }


    // ========== PAGE INITIALIZATION FUNCTIONS (Placeholders) ==========

    function initializeDashboard() {
        console.log('Dashboard Initialized. Loading charts...');
        // Live stats from DataStore
        const sales = DataStore.getList('sales');
        const todayStr = new Date().toLocaleDateString('ar-SA');
        const salesToday = sales.filter(s=> s.date===todayStr);
        const totalToday = salesToday.reduce((s,x)=> s + Number(x.total||0), 0);
        const products = DataStore.getProducts();
        const stockValue = products.reduce((s,p)=> s + Number(p.price||0)*Number(p.stock||0), 0);
        const exps = DataStore.getList('expenses');
        const ym = new Date().toISOString().slice(0,7);
        const monthExp = exps.filter(e=> (e.date||'').startsWith(ym)).reduce((s,x)=> s + Number(x.amount||0),0);
        const lastExp = exps.length ? exps[exps.length-1].description||'-' : 'لا يوجد';
        const customers = DataStore.getList('customers');
        const newCustMonth = customers.filter(c=> (c.createdAt||'').startsWith(ym)).length;
        // set
        document.getElementById('stat-sales-today').textContent = fmt(totalToday);
        document.getElementById('stat-invoices-today').textContent = `${salesToday.length}`;
        document.getElementById('stat-stock-value').textContent = fmt(stockValue);
        document.getElementById('stat-products-count').textContent = `${products.length}`;
        document.getElementById('stat-expenses-month').textContent = fmt(monthExp);
        document.getElementById('stat-last-expense').textContent = `${lastExp}`;
        document.getElementById('stat-new-customers').textContent = `${newCustMonth}`;
        document.getElementById('stat-total-customers').textContent = `${customers.length}`;
        
        // Render dummy activity log
        const activityList = document.getElementById('recent-activity-list');
        // Show latest 5 from activity
        const latest = DataStore.getList('activity').slice(-5).reverse();
        activityList.innerHTML = latest.length ? latest.map(a=>`<div style="padding:5px 0; border-bottom:1px dashed var(--border);">${ICONS.info_circle} ${a.user} - ${a.action} <span class="muted-small" style="float:left;">${a.datetime}</span></div>`).join('') : `<p class="muted-small text-center">لا يوجد نشاط بعد.</p>`;

        // Chart.js initialization from real sales (last 6 months)
        const salesCtx = document.getElementById('salesChart').getContext('2d');
        const cs = getComputedStyle(document.documentElement);
        const colorAccent = (cs.getPropertyValue('--accent')||'#4F46E5').trim();
        const colorMuted = (cs.getPropertyValue('--muted')||'#6b7280').trim();
        const colorSuccess = (cs.getPropertyValue('--success')||'#10B981').trim();
        const colorWarning = (cs.getPropertyValue('--warning')||'#F59E0B').trim();
        const colorDanger  = (cs.getPropertyValue('--danger') ||'#EF4444').trim();
        const months = [];
        const sums = [];
        const now = new Date();
        for(let i=5;i>=0;i--){
            const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
            const ym = d.toISOString().slice(0,7);
            months.push(d.toLocaleDateString('ar-SA', { month: 'long' }));
            const msum = sales.filter(s=> (s.date||'').startsWith(ym)).reduce((acc,x)=> acc + Number(x.total||0), 0);
            sums.push(msum);
        }
        new Chart(salesCtx, {
            type: 'bar',
            data: {
                labels: months,
                datasets: [{
                    label: 'إجمالي المبيعات',
                    data: sums,
                    backgroundColor: months.map((_,i)=> i===months.length-1 ? colorAccent : colorMuted),
                    borderRadius: 4
                }]
            },
            options: { responsive: true, scales: { y: { beginAtZero: true } }, plugins:{ tooltip:{ callbacks:{ label:(ctx)=> `${fmt(ctx.raw)}` } } } }
        });

        // Stock Chart with real data
        const stockCtx = document.getElementById('stockChart').getContext('2d');
        const safeStock = products.filter(p=> Number(p.stock||0) >= Number(p.reorder||0)).length;
        const lowStock = products.filter(p=> Number(p.stock||0) < Number(p.reorder||0) && Number(p.stock||0) > 0).length;
        const outOfStock = products.filter(p=> Number(p.stock||0) === 0).length;
        new Chart(stockCtx, {
            type: 'doughnut',
            data: {
                labels: ['كمية آمنة', 'اقتراب النفاذ', 'نفاذ المخزون'],
                datasets: [{
                    data: [safeStock, lowStock, outOfStock],
                    backgroundColor: [colorSuccess, colorWarning, colorDanger],
                }]
            },
            options: { responsive: true, cutout: '70%', plugins:{ legend:{ position:'bottom' } } }
        });
        
        // Top 5 Products by sales
        const topProductsEl = document.getElementById('top-products-list');
        if(topProductsEl){
            const productSales = {};
            sales.forEach(s=> {
                (s.items||[]).forEach(it=> {
                    productSales[it.name] = (productSales[it.name]||0) + (it.qty||0);
                });
            });
            const sorted = Object.entries(productSales).sort((a,b)=> b[1]-a[1]).slice(0,5);
            topProductsEl.innerHTML = sorted.length ? sorted.map((p,i)=>`
                <div style="display:flex; justify-content:space-between; padding:8px; background:${i===0?'var(--bg)':'transparent'}; border-radius:6px; margin-bottom:5px;">
                    <span>${i===0?'🥇':i===1?'🥈':i===2?'🥉':'🔹'} ${p[0]}</span>
                    <strong>${p[1]} قطعة</strong>
                </div>
            `).join('') : '<p class="muted-small">لا توجد بيانات بعد</p>';
        }
        
        // Top 5 Customers by total sales
        const topCustomersEl = document.getElementById('top-customers-list');
        if(topCustomersEl){
            const customerSales = {};
            sales.forEach(s=> {
                if(s.customer && s.customer!=='عميل نقدي'){
                    customerSales[s.customer] = (customerSales[s.customer]||0) + Number(s.total||0);
                }
            });
            const sorted = Object.entries(customerSales).sort((a,b)=> b[1]-a[1]).slice(0,5);
            topCustomersEl.innerHTML = sorted.length ? sorted.map((c,i)=>`
                <div style="display:flex; justify-content:space-between; padding:8px; background:${i===0?'var(--bg)':'transparent'}; border-radius:6px; margin-bottom:5px;">
                    <span>${i===0?'🏆':'⭐'} ${c[0]}</span>
                    <strong>${fmt(c[1])}</strong>
                </div>
            `).join('') : '<p class="muted-small">لا توجد بيانات بعد</p>';
        }
        
        // Stock Alerts
        const stockAlertsEl = document.getElementById('stock-alerts-list');
        if(stockAlertsEl){
            const alerts = products.filter(p=> Number(p.stock||0) < Number(p.reorder||0)).slice(0,5);
            stockAlertsEl.innerHTML = alerts.length ? alerts.map(p=>`
                <div style="display:flex; justify-content:space-between; padding:8px; background:var(--bg); border-radius:6px; margin-bottom:5px; border-left:3px solid ${Number(p.stock||0)===0?'var(--danger)':'var(--warning)'};">
                    <span>${Number(p.stock||0)===0?'🛑':'⚠️'} ${p.name}</span>
                    <strong class="${Number(p.stock||0)===0?'danger':'warning'}">${p.stock||0}/${p.reorder||0}</strong>
                </div>
            `).join('') : '<p class="muted-small">جميع المنتجات في مستويات آمنة ✅</p>';
        }
    }

    function initializePOS() {
        console.log('POS Initialized. Loading products...');
        const productsGrid = document.querySelector('#pos-products-list .products-grid');
        productsGrid.innerHTML = ''; // Clear previous products

        // Populate customers into POS select
        const customerSelect = document.getElementById('cart-customer-select');
        if (customerSelect) {
            const customers = [{ id: 'cash', name: 'عميل نقدي' }, ...DataStore.getList('customers')];
            customerSelect.innerHTML = '';
            customers.forEach(c => {
                const opt = document.createElement('option');
                opt.value = String(c.id);
                opt.textContent = c.name;
                customerSelect.appendChild(opt);
            });
        }

        const products = DataStore.getProducts();
        // Build category buttons and render filtered list with search+sort
        const catWrap = document.getElementById('pos-categories');
        const searchEl = document.getElementById('pos-search');
        const sortEl = document.getElementById('pos-sort');
        let currentCat = '';
        let currentSearch = '';
        let currentSort = 'recent';

        const computeList = ()=>{
            let list = products.slice();
            if(currentCat){ list = list.filter(p=> (p.category||'')===currentCat); }
            if(currentSearch){
                const q = currentSearch.toLowerCase();
                list = list.filter(p=> (p.name||'').toLowerCase().includes(q) || String(p.sku||'').toLowerCase().includes(q));
            }
            switch(currentSort){
                case 'price_asc': list.sort((a,b)=> Number(a.price||0)-Number(b.price||0)); break;
                case 'price_desc': list.sort((a,b)=> Number(b.price||0)-Number(a.price||0)); break;
                case 'stock_desc': list.sort((a,b)=> Number(b.stock||0)-Number(a.stock||0)); break;
                case 'name_asc': list.sort((a,b)=> String(a.name||'').localeCompare(String(b.name||''), 'ar')); break;
                case 'name_desc': list.sort((a,b)=> String(b.name||'').localeCompare(String(a.name||''), 'ar')); break;
                default: /* recent: keep as-is */ break;
            }
            return list;
        };

        // Escape for regex highlighting
        const esc = (s)=> String(s||'').replace(/[.*+?^${}()|[\]\\]/g, '\\$&');

        const renderList = ()=>{
            productsGrid.innerHTML = '';
            const list = computeList();
            list.forEach(prod => {
                const prodEl = document.createElement('div');
                prodEl.className = 'prod';
                prodEl.dataset.id = prod.id;
                prodEl.dataset.sku = prod.sku;
                const name = String(prod.name||'');
                const nameHtml = currentSearch ? name.replace(new RegExp(esc(currentSearch), 'gi'), (m)=>`<mark>${m}</mark>`) : name;
                const imgHtml = prod.image ? `<div class="prod-image" style="margin-bottom:8px; height:110px; overflow:hidden; border-radius:10px; background:#f3f4f6;"><img src="${prod.image}" alt="${prod.name}" style="width:100%; height:100%; object-fit:cover;"></div>` : '';
                prodEl.innerHTML = `
                    <div class="prod-stock chip ${prod.stock < prod.reorder ? 'danger' : 'info'}">الكمية: ${prod.stock}</div>
                    ${imgHtml}
                    <div class="prod-title">${nameHtml}</div>
                    <div class="prod-price">${fmt(prod.price)}</div>
                `;
                if(prod.stock < prod.reorder){ prodEl.classList.add('low-stock'); }
                prodEl.setAttribute('tabindex', '0');
                prodEl.setAttribute('role', 'button');
                prodEl.setAttribute('aria-label', `${prod.name} بسعر ${fmt(prod.price)}. اضغط للإضافة إلى السلة`);
                prodEl.onclick = () => addToCart(prod.id);
                prodEl.onkeydown = (e) => {
                    if(e.key==='Enter' || e.key===' '){
                        e.preventDefault();
                        addToCart(prod.id);
                    }
                };
                productsGrid.appendChild(prodEl);
            });
        };
        if(catWrap){
            catWrap.innerHTML='';
            const allBtn = document.createElement('button'); allBtn.className='btn sm ghost'; allBtn.textContent = `الكل (${products.length})`;
            catWrap.appendChild(allBtn);
            const categories = Array.from(new Set(products.map(p=> (p.category||'')).filter(Boolean)));
            categories.forEach(cat=>{
                const count = products.filter(p=> (p.category||'')===cat).length;
                const b=document.createElement('button'); b.className='btn sm ghost'; b.textContent = `${cat} (${count})`; b.dataset.cat=cat; catWrap.appendChild(b);
            });
            // Bind active state and render
            catWrap.querySelectorAll('button').forEach(btn=>{
                btn.onclick = ()=>{
                    catWrap.querySelectorAll('button').forEach(b=> b.classList.remove('active'));
                    btn.classList.add('active');
                    currentCat = btn.dataset.cat||'';
                    renderList();
                };
            });
            // Default to All
            const firstBtn = catWrap.querySelector('button'); if(firstBtn){ firstBtn.classList.add('active'); }
            currentCat = '';
            renderList();
        } else {
            renderList();
        }

        // Bind search & sort
        // Loading state on filter/sort
        const showLoading = ()=>{ productsGrid.innerHTML = '<div class="spinner" aria-hidden="true"></div>'; };
        if(searchEl){ searchEl.oninput = (e)=>{ currentSearch = (e.target.value||''); showLoading(); setTimeout(renderList, 120); }; }
        if(sortEl){ sortEl.onchange = (e)=>{ currentSort = e.target.value||'recent'; showLoading(); setTimeout(renderList, 120); }; }
        
        // Event listener for barcode scanner
        document.getElementById('barcode-input').onkeyup = (e) => {
            if (e.key === 'Enter' && e.target.value) {
                const sku = e.target.value.trim();
                const product = DataStore.getProducts().find(p => p.sku === sku);
                if (product) {
                    addToCart(product.id);
                    e.target.value = ''; // Clear input after successful scan
                } else {
                    showNotification('خطأ', `المنتج ذو الرمز ${sku} غير موجود.`, 'error');
                }
            }
        };

        renderCart();
        // Keyboard shortcuts
        document.onkeydown = (e)=>{
            const pageActive = document.querySelector('#page-content .pos-page');
            if(!pageActive) return;
            if(e.key==='Enter'){ const btn=document.getElementById('btn-process-cash'); if(btn&&!btn.disabled){ btn.click(); e.preventDefault(); } }
            if(e.key==='Escape'){ const btn=document.getElementById('btn-cancel-sale'); if(btn){ btn.click(); e.preventDefault(); } }
            if(e.ctrlKey && (e.key==='h' || e.key==='H')){ const btn=document.getElementById('btn-hold-sale'); if(btn){ btn.click(); e.preventDefault(); } }
            if(e.ctrlKey && (e.key==='k' || e.key==='K')){ const inp=document.getElementById('barcode-input'); if(inp){ inp.focus(); inp.select(); e.preventDefault(); } }
        };
        const holdBtn = document.getElementById('btn-hold-sale');
        if(holdBtn){
            holdBtn.onclick = ()=>{
                if(currentCart.length===0){ showToast('لا توجد عناصر للتعليق'); return; }
                const holds = DataStore.getList('holds');
                const id = Date.now();
                holds.push({ id, datetime: new Date().toLocaleString('ar-SA'), items: currentCart });
                DataStore.setList('holds', holds);
                currentCart = [];
                DataStore.setCart(currentCart);
                showNotification('تم التعليق', `تم تعليق سلة رقم ${id}.`, 'info');
                logActivity(`تعليق سلة #${id}`, 'POS');
                renderCart();
            };
        }
    }

    // ========== SIDEBAR TOGGLE ==========
    function toggleSidebar(){
        const sb = document.getElementById('sidebar');
        if(!sb) return; sb.classList.toggle('active');
    }
    
    // POS Cart Logic (Simplified)
    function addToCart(productId) {
        const product = DataStore.getProducts().find(p => p.id === productId);
        if (!product) return;
        
        const existingItem = currentCart.find(item => item.id === productId);

        if (existingItem) {
            existingItem.qty += 1;
        } else {
            currentCart.push({ 
                id: product.id, 
                name: product.name, 
                price: product.price, 
                qty: 1 
            });
        }
        
        // Animate product card
        try { const card = document.querySelector(`.prod[data-id="${productId}"]`); if(card){ card.classList.add('added-burst'); setTimeout(()=> card.classList.remove('added-burst'), 650); } } catch {}
        lastAddedProductId = productId;
        showToast(`تم إضافة ${product.name} إلى السلة.`);
        DataStore.setCart(currentCart);
        renderCart();
    }

    function updateCartItemQty(id, change) {
        const itemIndex = currentCart.findIndex(item => item.id === id);
        if (itemIndex > -1) {
            currentCart[itemIndex].qty += change;
            if (currentCart[itemIndex].qty <= 0) {
                currentCart.splice(itemIndex, 1); // Remove item if quantity is zero
            }
        }
        DataStore.setCart(currentCart);
        renderCart();
    }

    function renderCart() {
        const cartContainer = document.getElementById('pos-cart-items');
        const totalsContainer = document.getElementById('pos-totals');
        const processButton = document.getElementById('btn-process-cash');
        const cardButton = document.getElementById('btn-process-card');
        const creditButton = document.getElementById('btn-process-credit');
        
        if (currentCart.length === 0) {
            cartContainer.innerHTML = `
                <div class="empty-state p-20" style="padding: 20px 0;">
                    <span class="icon">🛒</span>
                    <h4 style="margin-bottom: 5px;">السلة فارغة</h4>
                    <p class="muted-small">ابدأ بإضافة المنتجات بالمسح أو الضغط عليها</p>
                    <div class="mt-15"><button type="button" class="btn success" onclick="closeModal(); App.navigateTo('pos')">الانتقال إلى نقطة البيع</button></div>
                </div>
            `;
            processButton.disabled = true;
            cardButton.disabled = true;
            if(creditButton) creditButton.disabled = true;
            updateTotals(0, 0, 0); // Reset totals
            return;
        }
        
        processButton.disabled = false;
        cardButton.disabled = false;
        if(creditButton) creditButton.disabled = false;
        
        let cartHtml = '';
        let subtotal = 0;

        currentCart.forEach(item => {
            const lineTotal = item.qty * item.price;
            subtotal += lineTotal;
            cartHtml += `
                <div class="cart-item" data-id="${item.id}">
                    <div>
                        <div class="fw-600">${item.name}</div>
                        <div class="muted-small">${fmt(item.price)} x ${item.qty}</div>
                    </div>
                    <div class="qty-control">
                        <button class="btn xs info" onclick="updateCartItemQty(${item.id}, 1)">${ICONS.plus}</button>
                        <span>${item.qty}</span>
                        <button class="btn xs danger" onclick="updateCartItemQty(${item.id}, -1)">${ICONS.minus}</button>
                    </div>
                    <button class="btn xs icon danger" onclick="updateCartItemQty(${item.id}, -${item.qty})">${ICONS.trash}</button>
                </div>
            `;
        });
        
        cartContainer.innerHTML = `<div class="cart-content">${cartHtml}</div>`;

        // Calculate totals from settings
        const settings = DataStore.load('settings', { taxRate: 0.15, discountFixed: 10 });
        const discount = Number(settings.discountFixed || 0);
        const taxRate = Number(settings.taxRate || 0);
        const subtotalAfterDiscount = subtotal - discount;
        const taxAmount = subtotalAfterDiscount > 0 ? subtotalAfterDiscount * taxRate : 0;
        const finalTotal = subtotalAfterDiscount + taxAmount;
        
        updateTotals(subtotal, discount, finalTotal, taxAmount);

        // Animate last added cart item
        try {
            if(lastAddedProductId!=null){
                const el = cartContainer.querySelector(`.cart-item[data-id="${lastAddedProductId}"]`);
                if(el){ el.classList.add('added-burst'); setTimeout(()=> el.classList.remove('added-burst'), 650); }
            }
        } catch {}

        // Bind payment buttons (simplified action)
        document.getElementById('btn-process-cash').onclick = () => completeSale('cash', finalTotal);
        document.getElementById('btn-process-card').onclick = () => completeSale('card', finalTotal);
        if(creditButton) creditButton.onclick = () => completeSale('credit', finalTotal);
        document.getElementById('btn-cancel-sale').onclick = () => cancelSale();
    }

    function updateTotals(sub, discount, final, tax = 0) {
        document.getElementById('subtotal-amount').textContent = fmt(sub);
        document.getElementById('discount-amount').textContent = fmt(discount);
        document.getElementById('tax-amount').textContent = fmt(tax);
        document.getElementById('final-total-amount').textContent = fmt(final);
    }
    
    function completeSale(paymentMethod, amount) {
        if(currentCart.length===0){ showToast('السلة فارغة'); return; }
        
        // customer from select
        const customerSelect = document.getElementById('cart-customer-select');
        const custId = customerSelect ? customerSelect.value : 'cash';
        
        // Check if credit sale but customer is cash
        if(paymentMethod === 'credit' && (!custId || custId === 'cash')){
            showNotification('خطأ', 'يجب اختيار عميل للبيع الآجل.', 'error');
            return;
        }
        
        const products = DataStore.getProducts();
        const sales = DataStore.getList('sales');
        const saleId = DataStore.nextId('sales');
        const items = currentCart.map(i => ({ id: i.id, name: i.name, price: i.price, qty: i.qty }));
        
        let customerName = 'عميل نقدي';
        let customers = DataStore.getList('customers');
        
        if (custId && custId !== 'cash') {
            const custIndex = customers.findIndex(c => String(c.id) === String(custId));
            if (custIndex > -1) {
                customerName = customers[custIndex].name;
                customers[custIndex].totalSales = Number(customers[custIndex].totalSales||0) + Number(amount||0);
                
                // Update balance for credit sales
                if(paymentMethod === 'credit'){
                    customers[custIndex].balance = Number(customers[custIndex].balance||0) + Number(amount||0);
                }
                
                DataStore.setList('customers', customers);
            }
        }
        
        // update stock
        items.forEach(it => {
            const idx = products.findIndex(p => p.id === it.id);
            if(idx>-1){ products[idx].stock = Math.max(0, (products[idx].stock||0) - it.qty); }
        });
        DataStore.setList('products', products);
        
        // save sale
        const now = new Date();
        let saleStatus = 'مدفوعة';
        let paid = amount;
        let remaining = 0;
        
        if(paymentMethod === 'credit'){
            saleStatus = 'غير مدفوعة';
            paid = 0;
            remaining = amount;
        }
        
        const sale = { 
            id: saleId, 
            customer: customerName, 
            customerId: custId || null, 
            date: now.toLocaleDateString('ar-SA'), 
            dateISO: now.toISOString().slice(0,10), 
            status: saleStatus, 
            total: amount, 
            paid: paid,
            remaining: remaining,
            paymentMethod: paymentMethod === 'credit' ? 'آجل' : paymentMethod,
            items 
        };
        
        sales.push(sale);
        DataStore.setList('sales', sales);
        
        // clear cart
        currentCart = [];
        DataStore.setCart(currentCart);
        
        const methodText = paymentMethod === 'cash' ? 'نقد' : (paymentMethod === 'card' ? 'بطاقة' : 'آجل');
        showNotification('تمت العملية بنجاح', `تمت عملية البيع #${saleId} - ${methodText} بمبلغ ${fmt(amount)}.`, 'success');
        logActivity(`عملية بيع #${saleId} - ${customerName} - ${methodText}`, 'POS');
        renderCart();
    }

    function cancelSale() {
        if(confirm('هل أنت متأكد من إلغاء عملية البيع الحالية؟')) {
            currentCart = [];
            DataStore.setCart(currentCart);
            renderCart();
            showToast('تم إلغاء عملية البيع.');
        }
    }

    function initializeSales() {
        console.log('Sales Page Initialized. Loading sales data...');
        const salesTableBody = document.querySelector('#sales-table tbody');
        salesTableBody.innerHTML = '';
        const salesListFull = DataStore.getList('sales');
        if(salesListFull.length===0){
            salesTableBody.innerHTML = `<tr><td colspan="6" class="text-center muted">لا توجد فواتير بعد.</td></tr>`;
            return;
        }
        // search
        const wrapper = document.querySelector('.sales-page .card');
        const searchInput = wrapper ? wrapper.querySelector('input[type="text"]') : null;
        // restore search
        if(searchInput){ const sv = localStorage.getItem('ultimate_search_sales')||''; if(sv){ searchInput.value = sv; } }
        // attach result counter
        let salesCountEl = null; const attachSalesCounter = ()=>{ if(!searchInput) return; salesCountEl = document.createElement('span'); salesCountEl.className = 'result-count'; searchInput.parentElement?.appendChild(salesCountEl); };
        attachSalesCounter();
        // ensure pager container exists
        let pagerEl = wrapper?.querySelector('.pager');
        if(wrapper && !pagerEl){
            const tbl = wrapper.querySelector('.table-container');
            if(tbl){ tbl.insertAdjacentHTML('beforeend', '<div class="pager"></div>'); }
            pagerEl = wrapper.querySelector('.pager');
        }
        let page = 1; let pageSize = Number(localStorage.getItem('ultimate_pageSize_sales')||20); let current = salesListFull.slice();
        const renderPaged = (list)=>{
            salesTableBody.innerHTML = '';
            const sorted = list.slice().sort((a,b)=> Number(b.id)-Number(a.id));
            const start = (page-1)*pageSize;
            const pageItems = sorted.slice(start, start+pageSize);
            const customers = DataStore.getList('customers');
            pageItems.forEach(sale => {
                const statusChip = sale.status === 'مدفوعة' ? `<span class="chip success">مدفوعة</span>` : `<span class="chip warning">آجل</span>`;
                const displayName = sale.customerId && sale.customerId!=='cash' ? (customers.find(c=> String(c.id)===String(sale.customerId))?.name || sale.customer || 'عميل') : (sale.customer || 'عميل نقدي');
                const delBtn = Permissions.can('delete') ? `<button class="btn xs icon danger" onclick="deleteSale(${sale.id})">${ICONS.trash}</button>` : '';
                salesTableBody.innerHTML += `
                    <tr>
                        <td>#${sale.id}</td>
                        <td>${displayName}</td>
                        <td>${sale.date}</td>
                        <td>${statusChip}</td>
                        <td class="fw-700">${fmt(Number(sale.total))}</td>
                        <td>
                            <button class="btn xs icon info" onclick="openModal('show-invoice', {id: ${sale.id}})">${ICONS.view}</button>
                            ${delBtn}
                        </td>
                    </tr>
                `;
            });
            if(salesCountEl){ salesCountEl.textContent = `(${list.length} نتيجة)`; }
            if(pagerEl){ renderPager(pagerEl, list.length, page, pageSize, (p)=>{ page=p; renderPaged(current); }, (sz)=>{ pageSize=sz; localStorage.setItem('ultimate_pageSize_sales', String(sz)); page=1; renderPaged(current); }); }
        };
        renderPaged(current);
        if(searchInput){
            searchInput.oninput = (e)=>{
                const q = (e.target.value||'').toLowerCase();
                localStorage.setItem('ultimate_search_sales', q);
                current = salesListFull.filter(s=> String(s.id).includes(q) || (s.customer||'').toLowerCase().includes(q) || (s.date||'').includes(q));
                page = 1; renderPaged(current);
            };
        }
    }

    // Export Sales to Excel via XLSX
    function exportSalesToExcel(){
        try {
            const sales = DataStore.getList('sales');
            const header = ['رقم الفاتورة','العميل','تاريخ','الحالة','الإجمالي','طريقة الدفع'];
            const rows = sales.slice().sort((a,b)=> Number(a.id)-Number(b.id)).map(s=>[
                `#${s.id}`,
                s.customer || '',
                s.date || '',
                s.status || '',
                Number(s.total||0),
                s.paymentMethod || ''
            ]);
            const sheetData = [header, ...rows];
            const ws = XLSX.utils.aoa_to_sheet(sheetData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Sales');
            const fname = `sales_${new Date().toISOString().slice(0,10)}.xlsx`;
            XLSX.writeFile(wb, fname);
            showToast('تم تصدير الفواتير إلى ملف Excel');
        } catch (e) {
            console.error('Export failed', e);
            showNotification('خطأ في التصدير','تعذر إنشاء ملف Excel.','error');
        }
    }

    function deleteSale(id){
        const sales = DataStore.getList('sales');
        const sale = sales.find(s=> String(s.id)===String(id));
        if(!sale){ showToast('الفاتورة غير موجودة'); return; }
        if(!confirm(`حذف الفاتورة #${id}؟`)) return;
        // reverse stock
        const products = DataStore.getProducts();
        (sale.items||[]).forEach(it=>{
            const idx = products.findIndex(p=> p.id===it.id);
            if(idx>-1){ products[idx].stock = (products[idx].stock||0) + (it.qty||0); }
        });
        DataStore.setList('products', products);
        // remove sale
        DataStore.setList('sales', sales.filter(s=> String(s.id)!==String(id)));
        showNotification('تم الحذف', `تم حذف الفاتورة #${id}.`, 'success');
        logActivity(`حذف فاتورة #${id}`, 'Sales');
        if(document.getElementById('page-sales')?.classList.contains('active')) initializeSales();
        closeModal();
    }
    
    function initializeReturns() {
        console.log('Returns Page Initialized.');
        const tbody = document.querySelector('#sales-returns-table tbody');
        if(!tbody) return; tbody.innerHTML='';
        const returns = DataStore.getList('returns');
        if(returns.length===0){ tbody.innerHTML = `<tr><td colspan="6" class="text-center muted">لا توجد مرتجعات.</td></tr>`; return; }
        returns.sort((a,b)=> Number(b.id)-Number(a.id));
        returns.forEach(r=>{
            tbody.innerHTML += `
                <tr>
                    <td>#${r.id}</td>
                    <td>#${r.saleId}</td>
                    <td>-</td>
                    <td>${r.date}</td>
                    <td class="fw-700">${Number(r.amount||0).toFixed(2)} ر.س</td>
                    <td><button class="btn xs ghost" onclick="openModal('show-invoice', {id:${r.saleId}})">${ICONS.view}</button></td>
                </tr>
            `;
        });
    }

    function initializePurchases() {
        console.log('Purchases Page Initialized.');
        const tbody = document.querySelector('#purchases-table tbody');
        if(!tbody) return; tbody.innerHTML='';
        const purchases = DataStore.getList('purchases');
        if(purchases.length===0){ tbody.innerHTML = `<tr><td colspan="6" class="text-center muted">لا توجد مشتريات.</td></tr>`; return; }
        purchases.sort((a,b)=> Number(b.id)-Number(a.id));
        const wrapper = document.querySelector('.purchases-page .card');
        let pagerEl = wrapper?.querySelector('.pager');
        if(wrapper && !pagerEl){ const tbl = wrapper.querySelector('.table-container'); if(tbl){ tbl.insertAdjacentHTML('beforeend', '<div class="pager"></div>'); } pagerEl = wrapper.querySelector('.pager'); }
        let page = 1; let pageSize = Number(localStorage.getItem('ultimate_pageSize_purchases')||20); let current = purchases.slice();
        const renderPaged=(list)=>{
            tbody.innerHTML='';
            const sorted = list.slice().sort((a,b)=> Number(b.id)-Number(a.id));
            const start=(page-1)*pageSize; const pageItems = sorted.slice(start, start+pageSize);
            pageItems.forEach(p=>{
                const statusChip = `<span class="chip ${p.status==='مدفوعة'?'success':'info'}">${p.status||'مسجلة'}</span>`;
                tbody.innerHTML += `
                    <tr>
                        <td>#${p.id}</td>
                        <td>${p.supplier||''}</td>
                        <td>${p.date||''}</td>
                        <td>${statusChip}</td>
                        <td class="fw-700">${fmt(Number(p.total||0))}</td>
                        <td><button class="btn xs ghost">تفاصيل</button></td>
                    </tr>
                `;
            });
            if(pagerEl){ renderPager(pagerEl, list.length, page, pageSize, (p)=>{ page=p; renderPaged(current); }, (sz)=>{ pageSize=sz; page=1; renderPaged(current); }); }
        };
        renderPaged(current);
        const searchInput = document.querySelector('.purchases-page .card input[type="text"]');
        if(searchInput){
            searchInput.oninput = (e)=>{
                const q=(e.target.value||'').toLowerCase();
                current = purchases.filter(p=> String(p.id).includes(q) || (p.supplier||'').toLowerCase().includes(q) || (p.date||'').includes(q));
                page = 1; renderPaged(current);
            };
        }
    }

    function initializeItems() {
        console.log('Items Page Initialized. Loading products list...');
        const itemsTableBody = document.querySelector('#items-table tbody');
        itemsTableBody.innerHTML = '';
        const productsFull = DataStore.getProducts();
        const wrapper = document.querySelector('.items-page .card');
        let pagerEl = wrapper?.querySelector('.pager');
        if(wrapper && !pagerEl){
            const tbl = wrapper.querySelector('.table-container');
            if(tbl){ tbl.insertAdjacentHTML('beforeend', '<div class="pager"></div>'); }
            pagerEl = wrapper.querySelector('.pager');
        }
        let page = 1; let pageSize = Number(localStorage.getItem('ultimate_pageSize_items')||20); let current = productsFull.slice();
        const renderPaged = (list)=>{
            itemsTableBody.innerHTML = '';
            const sorted = list.slice();
            const start = (page-1)*pageSize;
            const pageItems = sorted.slice(start, start+pageSize);
            pageItems.forEach(prod => {
                const stockChip = prod.stock < prod.reorder ? `<span class="chip danger">${prod.stock} (قليل)</span>` : `<span class="chip success">${prod.stock}</span>`;
                const editBtn = Permissions.can('edit') ? `<button class="btn xs icon info" onclick="openModal('edit-item', {id: ${prod.id}})">${ICONS.edit}</button>` : '';
                const delBtn = Permissions.can('delete') ? `<button class="btn xs icon danger" onclick="deleteItem(${prod.id})">${ICONS.trash}</button>` : '';
                itemsTableBody.innerHTML += `
                    <tr>
                        <td>${prod.sku}</td>
                        <td>${prod.name}</td>
                        <td>وحدة</td>
                        <td class="fw-700">${fmt(prod.price)}</td>
                        <td>${stockChip}</td>
                        <td>
                            ${editBtn}
                            ${delBtn}
                        </td>
                    </tr>
                `;
            });
            if(pagerEl){ renderPager(pagerEl, list.length, page, pageSize, (p)=>{ page=p; renderPaged(current); }, (sz)=>{ pageSize=sz; page=1; renderPaged(current); }); }
        };
        renderPaged(current);
        // permissions for toolbar actions
        const importBtn = document.querySelector('.items-page .card button.btn.info');
        const exportBtn = document.querySelector('.items-page .card button.btn:not(.info):not(.success)');
        const newBtn = document.querySelector('.items-page .card button.btn.success');
        if(importBtn && !Permissions.can('import')) importBtn.style.display='none';
        if(exportBtn && !Permissions.can('export')) exportBtn.style.display='none';
        if(newBtn && !Permissions.can('edit')) newBtn.style.display='none';
        const searchInput = document.getElementById('item-search');
        if(searchInput){ const sv = localStorage.getItem('ultimate_search_items')||''; if(sv){ searchInput.value = sv; } }
        // attach items result counter
        let itemsCountEl = null; const attachItemsCounter = ()=>{ if(!searchInput) return; itemsCountEl = document.createElement('span'); itemsCountEl.className = 'result-count'; searchInput.parentElement?.appendChild(itemsCountEl); };
        attachItemsCounter();
        if(itemsCountEl){ itemsCountEl.textContent = `(${productsFull.length} نتيجة)`; }
        if(searchInput){
            searchInput.oninput = (e)=>{
                const q = (e.target.value||'').toLowerCase();
                localStorage.setItem('ultimate_search_items', q);
                current = productsFull.filter(p=> (p.sku||'').toLowerCase().includes(q) || (p.name||'').toLowerCase().includes(q));
                page = 1; renderPaged(current);
                if(itemsCountEl){ itemsCountEl.textContent = `(${current.length} نتيجة)`; }
            };
        }
    }

    function deleteItem(id){
        const products = DataStore.getProducts();
        const prod = products.find(p=> p.id===id);
        if(!prod){ showToast('الصنف غير موجود'); return; }
        if(!confirm(`حذف الصنف ${prod.sku}?`)) return;
        DataStore.setList('products', products.filter(p=> p.id!==id));
        showNotification('تم الحذف', `تم حذف الصنف ${prod.sku}.`, 'success');
        logActivity(`حذف صنف ${prod.sku}`, 'Items');
        if(document.getElementById('page-items')?.classList.contains('active')) initializeItems();
        if(document.getElementById('page-stock')?.classList.contains('active')) initializeStock();
    }

    function initializeStock() {
        console.log('Stock Page Initialized.');
        const tbody = document.querySelector('#stock-levels-table tbody');
        if(!tbody) return;
        tbody.innerHTML = '';
        DataStore.getProducts().forEach(prod=>{
            const value = (Number(prod.stock||0) * Number(prod.price||0)).toFixed(2);
            const status = prod.stock <= 0 ? `<span class="chip danger">نفاذ</span>` : (prod.stock < (prod.reorder||0) ? `<span class="chip warning">قليل</span>` : `<span class="chip success">آمن</span>`);
            tbody.innerHTML += `
                <tr>
                    <td>${prod.sku}</td>
                    <td>${prod.name}</td>
                    <td>${prod.stock}</td>
                    <td>${value} ر.س</td>
                    <td>${prod.reorder||0}</td>
                    <td>${status}</td>
                    <td><button class="btn xs info" onclick="openProductBarcodeOptions(${prod.id})">باركود</button></td>
                </tr>
            `;
        });
        // Render adjustments history
        const adjBody = document.querySelector('#adjustment-history-table tbody');
        if(adjBody){
            const adjustments = DataStore.getList('adjustments');
            adjBody.innerHTML = '';
            if(adjustments.length===0){ adjBody.innerHTML = `<tr><td colspan="5" class="text-center muted">لا توجد تسويات.</td></tr>`; }
            adjustments.slice().reverse().forEach(a=>{
                const type = a.change>0? 'زيادة' : 'نقص';
                adjBody.innerHTML += `
                    <tr>
                        <td>#${a.id}</td>
                        <td>${a.date}</td>
                        <td>${type}</td>
                        <td>${a.change}</td>
                        <td>${a.sku} - ${a.name} ${a.reason? '('+a.reason+')':''}</td>
                    </tr>
                `;
            });
        }
    }

    function initializeCustomers() {
        console.log('Customers Page Initialized.');
        const tbody = document.querySelector('#customers-table tbody');
        if(!tbody) return;
        tbody.innerHTML='';
        const customers = DataStore.getList('customers');
        if(customers.length===0){ tbody.innerHTML = `<tr><td colspan="6" class="text-center muted">لا يوجد عملاء.</td></tr>`; return; }
        const searchInput = document.querySelector('.customers-page .card input[type="text"]');
        const wrapper = document.querySelector('.customers-page .card');
        let pagerEl = wrapper?.querySelector('.pager');
        if(wrapper && !pagerEl){
            const tbl = wrapper.querySelector('.table-container');
            if(tbl){ tbl.insertAdjacentHTML('beforeend', '<div class="pager"></div>'); }
            pagerEl = wrapper.querySelector('.pager');
        }
        let page = 1; let pageSize = Number(localStorage.getItem('ultimate_pageSize_customers')||20); let current = customers.slice();
        const renderPaged = (list)=>{
            tbody.innerHTML='';
            const start = (page-1)*pageSize;
            const pageItems = list.slice(start, start+pageSize);
            pageItems.forEach(c=>{
                const delBtn = Permissions.can('delete') ? `<button class=\"btn xs danger\" onclick=\"deleteCustomer(${c.id})\">حذف</button>` : '';
                tbody.innerHTML += `
                    <tr>
                        <td>${c.name||''}</td>
                        <td>${c.phone||''}</td>
                        <td>${Number(c.balance||0).toFixed(2)} ر.س</td>
                        <td>${Number(c.totalSales||0).toFixed(2)} ر.س</td>
                        <td>${c.createdAt||''}</td>
                        <td>
                           <button class="btn xs ghost" onclick="viewCustomerDetails(${c.id})">تفاصيل</button>
                           ${delBtn}
                        </td>
                    </tr>
                `;
            });
            if(pagerEl){ renderPager(pagerEl, list.length, page, pageSize, (p)=>{ page=p; renderPaged(current); }); }
        };
        renderPaged(current);
        if(searchInput){
            searchInput.oninput = (e)=>{
                const q=(e.target.value||'').toLowerCase();
                current = customers.filter(c=> (c.name||'').toLowerCase().includes(q) || (c.phone||'').toLowerCase().includes(q));
                page = 1; renderPaged(current);
            };
        }
    }
    
    // View Customer Details
    function viewCustomerDetails(customerId){
        const customers = DataStore.getList('customers');
        const customer = customers.find(c=> c.id === customerId);
        if(!customer){ showNotification('خطأ', 'العميل غير موجود', 'error'); return; }
        
        // Get customer's sales
        const sales = DataStore.getList('sales').filter(s=> s.customerId === customerId || s.customer === customer.name);
        const totalSales = sales.reduce((sum, s)=> sum + Number(s.total||0), 0);
        const unpaidInvoices = sales.filter(s=> s.status === 'غير مدفوعة' || s.status === 'مدفوعة جزئياً');
        const receipts = JSON.parse(localStorage.getItem('receipts')||'[]').filter(r=> r.customer === customer.name);
        const totalReceipts = receipts.reduce((sum, r)=> sum + Number(r.amount||0), 0);
        
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width:800px;">
                <div class="space-between mb-20">
                    <h3>👤 تفاصيل العميل: ${customer.name}</h3>
                    <button class="btn icon ghost" onclick="this.closest('.modal-overlay').remove()">✕</button>
                </div>
                
                <div class="form-row mb-20">
                    <div class="col-6">
                        <div class="card" style="background:var(--gradient-info); color:white;">
                            <div style="font-size:14px; opacity:0.9;">الرصيد الحالي</div>
                            <div style="font-size:32px; font-weight:800; margin-top:5px;">${fmt(customer.balance||0)}</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card" style="background:var(--gradient-success); color:white;">
                            <div style="font-size:14px; opacity:0.9;">إجمالي المبيعات</div>
                            <div style="font-size:32px; font-weight:800; margin-top:5px;">${fmt(totalSales)}</div>
                        </div>
                    </div>
                </div>
                
                <div class="card mb-15">
                    <h4>📞 معلومات الاتصال</h4>
                    <div class="form-row">
                        <div class="col-6"><strong>الهاتف:</strong> ${customer.phone||'-'}</div>
                        <div class="col-6"><strong>البريد:</strong> ${customer.email||'-'}</div>
                        <div class="col-12"><strong>العنوان:</strong> ${customer.address||'-'}</div>
                        <div class="col-6"><strong>تاريخ التسجيل:</strong> ${customer.createdAt||'-'}</div>
                        <div class="col-6"><strong>عدد الفواتير:</strong> ${sales.length}</div>
                    </div>
                </div>
                
                <div class="card mb-15">
                    <h4>🏷️ بطاقة العميل والباركود</h4>
                    <div class="form-row">
                        <div class="col-6"><strong>المعرف:</strong> ${customer.id}</div>
                        <div class="col-6"><strong>الهاتف:</strong> ${customer.phone||'-'}</div>
                    </div>
                    <div class="barcode-display" style="margin-top:10px;">
                        <svg id="cust-barcode-${customerId}"></svg>
                        <div class="muted-small">الرمز: ${(customer.phone||String(customer.id)||'')}</div>
                    </div>
                </div>
                
                ${unpaidInvoices.length > 0 ? `
                <div class="card mb-15">
                    <h4>⚠️ فواتير غير مدفوعة (${unpaidInvoices.length})</h4>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>رقم</th><th>التاريخ</th><th>الإجمالي</th><th>المدفوع</th><th>المتبقي</th></tr></thead>
                            <tbody>
                                ${unpaidInvoices.map(inv=>`<tr>
                                    <td>#${inv.id}</td>
                                    <td>${inv.date||''}</td>
                                    <td>${fmt(inv.total||0)}</td>
                                    <td>${fmt(inv.paid||0)}</td>
                                    <td class="danger">${fmt(inv.remaining||0)}</td>
                                </tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                ` : ''}
                
                ${receipts.length > 0 ? `
                <div class="card">
                    <h4>💵 آخر عمليات القبض (${receipts.length})</h4>
                    <div class="table-container" style="max-height:200px; overflow-y:auto;">
                        <table>
                            <thead><tr><th>التاريخ</th><th>المبلغ</th><th>الطريقة</th></tr></thead>
                            <tbody>
                                ${receipts.slice(-5).reverse().map(r=>`<tr>
                                    <td>${r.dateISO||''} ${r.time||''}</td>
                                    <td>${fmt(r.amount||0)}</td>
                                    <td>${r.paymentMethod==='card'?'بطاقة':'نقد'}</td>
                                </tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                ` : ''}
                
                <div class="text-center mt-20" style="display:flex; gap:10px; justify-content:center;">
                    <button class="btn success" onclick="App.navigateTo('vouchers'); this.closest('.modal-overlay').remove();">💵 تسجيل قبض</button>
                    <button class="btn info" onclick="printCustomerBarcode(${customerId})">🖨️ طباعة الباركود</button>
                    <button class="btn ghost" onclick="this.closest('.modal-overlay').remove()">إغلاق</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        modal.classList.add('active');
        try{
            const svg = modal.querySelector(`#cust-barcode-${customerId}`);
            if(svg && window.JsBarcode){
                JsBarcode(svg, (customer.phone||String(customer.id)||''), { format:'CODE128', displayValue:true, font:'Cairo', fontSize:14, text: customer.name });
            }
        }catch(err){ console.error('Barcode render error', err); }
        modal.onclick = (e)=> { if(e.target === modal) modal.remove(); };
    }
    
    function printCustomerBarcode(customerId){
        try{
            const customers = DataStore.getList('customers');
            const customer = customers.find(c=> c.id === customerId);
            if(!customer){ showNotification('خطأ','تعذر العثور على العميل.','error'); return; }
            const settings = DataStore.load('settings', { companyName: 'متجري' });
            const area = document.getElementById('invoice-print-area');
            area.innerHTML = `
                <div style="direction:rtl; font-family:'Cairo',sans-serif; padding:16px; max-width:80mm; margin:0 auto;">
                    <div style="text-align:center; font-weight:800;">${settings.companyName||'المتجر'}</div>
                    <div style="text-align:center; font-size:13px; margin:6px 0;">بطاقة عميل</div>
                    <div style="font-size:13px; margin-bottom:6px;"><strong>الاسم:</strong> ${customer.name||''}</div>
                    <div style="font-size:12px; margin-bottom:6px;"><strong>الهاتف:</strong> ${customer.phone||'-'}</div>
                    <div class="barcode-display" style="text-align:center;">
                        <svg id="print-cust-bc"></svg>
                        <div class="muted-small">${customer.phone||String(customer.id)||''}</div>
                    </div>
                </div>
            `;
            try{ if(window.JsBarcode){ JsBarcode('#print-cust-bc', (customer.phone||String(customer.id)||''), { format:'CODE128', displayValue:true, font:'Cairo', fontSize:14, text: customer.name }); } }catch(e){}
            setTimeout(()=> window.print(), 120);
        }catch(e){ console.error(e); showNotification('خطأ','تعذر طباعة الباركود.','error'); }
    }
    
    function initializeSuppliers() {
        console.log('Suppliers Page Initialized.');
        const tbody = document.querySelector('#suppliers-table tbody');
        if(!tbody) return; tbody.innerHTML='';
        const suppliers = DataStore.getList('suppliers');
        if(suppliers.length===0){ tbody.innerHTML = `<tr><td colspan="5" class="text-center muted">لا يوجد موردون.</td></tr>`; return; }
        const searchInput = document.querySelector('.suppliers-page .card input[type="text"]');
        const wrapper = document.querySelector('.suppliers-page .card');
        let pagerEl = wrapper?.querySelector('.pager');
        if(wrapper && !pagerEl){
            const tbl = wrapper.querySelector('.table-container');
            if(tbl){ tbl.insertAdjacentHTML('beforeend', '<div class="pager"></div>'); }
            pagerEl = wrapper.querySelector('.pager');
        }
        let page = 1; let pageSize = Number(localStorage.getItem('ultimate_pageSize_suppliers')||20); let current = suppliers.slice();
        const renderPaged = (list)=>{
            tbody.innerHTML='';
            const start = (page-1)*pageSize;
            const pageItems = list.slice(start, start+pageSize);
            pageItems.forEach(s=>{
                const delBtn = Permissions.can('delete') ? `<button class=\"btn xs danger\" onclick=\"deleteSupplier(${s.id})\">حذف</button>` : '';
                tbody.innerHTML += `
                    <tr>
                        <td>${s.name||''}</td>
                        <td>${s.phone||''}</td>
                        <td>${Number(s.balance||0).toFixed(2)} ر.س</td>
                        <td>${Number(s.totalPurchases||0).toFixed(2)} ر.س</td>
                        <td>
                            <button class="btn xs ghost">تفاصيل</button>
                            ${delBtn}
                        </td>
                    </tr>
                `;
            });
            if(pagerEl){ renderPager(pagerEl, list.length, page, pageSize, (p)=>{ page=p; renderPaged(current); }); }
        };
        renderPaged(current);
        if(searchInput){
            searchInput.oninput = (e)=>{
                const q=(e.target.value||'').toLowerCase();
                current = suppliers.filter(s=> (s.name||'').toLowerCase().includes(q) || (s.phone||'').toLowerCase().includes(q));
                page = 1; renderPaged(current);
            };
        }
    }

    function initializeExpenses() {
        console.log('Expenses Page Initialized.');
        const tbody = document.querySelector('#expenses-table tbody');
        if(!tbody) return; tbody.innerHTML='';
        const exps = DataStore.getList('expenses');
        if(exps.length===0){ tbody.innerHTML = `<tr><td colspan="6" class="text-center muted">لا توجد مصروفات.</td></tr>`; return; }
        exps.sort((a,b)=> Number(b.id)-Number(a.id));
        const searchInput = document.querySelector('.expenses-page .card input[type="text"]');
        const wrapper = document.querySelector('.expenses-page .card');
        let pagerEl = wrapper?.querySelector('.pager');
        if(wrapper && !pagerEl){
            const tbl = wrapper.querySelector('.table-container');
            if(tbl){ tbl.insertAdjacentHTML('beforeend', '<div class="pager"></div>'); }
            pagerEl = wrapper.querySelector('.pager');
        }
        let page = 1; let pageSize = Number(localStorage.getItem('ultimate_pageSize_expenses')||20); let current = exps.slice();
        const renderPaged=(list)=>{
            tbody.innerHTML='';
            const start = (page-1)*pageSize;
            const pageItems = list.slice(start, start+pageSize);
            pageItems.forEach(x=>{
                const delBtn = Permissions.can('delete') ? `<button class=\"btn xs danger\" onclick=\"deleteExpense(${x.id})\">حذف</button>` : '';
                tbody.innerHTML += `
                    <tr>
                        <td>${x.date||''}</td>
                        <td>${x.description||''}</td>
                        <td>${x.category||''}</td>
                        <td class="fw-700">${fmt(Number(x.amount||0))}</td>
                        <td>-</td>
                        <td>
                            <button class="btn xs ghost">سند</button>
                            ${delBtn}
                        </td>
                    </tr>
                `;
            });
            if(pagerEl){ renderPager(pagerEl, list.length, page, pageSize, (p)=>{ page=p; renderPaged(current); }, (sz)=>{ pageSize=sz; page=1; renderPaged(current); }); }
        };
        renderPaged(current);
        if(searchInput){
            searchInput.oninput = (e)=>{
                const q=(e.target.value||'').toLowerCase();
                current = exps.filter(x=> (x.description||'').toLowerCase().includes(q) || (x.date||'').includes(q) || (x.category||'').toLowerCase().includes(q));
                page = 1; renderPaged(current);
            };
        }
    }

    function deleteCustomer(id){
        const customers = DataStore.getList('customers');
        const c = customers.find(x=> String(x.id)===String(id));
        if(!c){ showToast('العميل غير موجود'); return; }
        if(!confirm(`حذف العميل ${c.name}?`)) return;
        DataStore.setList('customers', customers.filter(x=> String(x.id)!==String(id)));
        showNotification('تم الحذف', `تم حذف العميل ${c.name}.`, 'success');
        logActivity(`حذف عميل ${c.name}`, 'Customers');
        initializeCustomers();
    }

    function deleteSupplier(id){
        const suppliers = DataStore.getList('suppliers');
        const s = suppliers.find(x=> String(x.id)===String(id));
        if(!s){ showToast('المورد غير موجود'); return; }
        if(!confirm(`حذف المورد ${s.name}?`)) return;
        DataStore.setList('suppliers', suppliers.filter(x=> String(x.id)!==String(id)));
        showNotification('تم الحذف', `تم حذف المورد ${s.name}.`, 'success');
        logActivity(`حذف مورد ${s.name}`, 'Suppliers');
        initializeSuppliers();
    }

    function deleteExpense(id){
        const exps = DataStore.getList('expenses');
        const x = exps.find(e=> String(e.id)===String(id));
        if(!x){ showToast('المصروف غير موجود'); return; }
        if(!confirm(`حذف المصروف: ${x.description}?`)) return;
        DataStore.setList('expenses', exps.filter(e=> String(e.id)!==String(id)));
        showNotification('تم الحذف', `تم حذف المصروف.`, 'success');
        logActivity(`حذف مصروف ${Number(x.amount||0).toFixed(2)} ر.س`, 'Expenses');
        initializeExpenses();
    }

    function initializeReports() {
        console.log('Reports Page Initialized.');
        const fromEl = document.getElementById('rpt-from');
        const toEl = document.getElementById('rpt-to');
        const grpEl = document.getElementById('rpt-group');
        const typeEl = document.getElementById('rpt-type');
        const applyBtn = document.getElementById('rpt-apply');
        const tblBody = document.querySelector('#rpt-table tbody');
        const tblHead = document.querySelector('#rpt-table thead');
        const tblTitle = document.getElementById('rpt-table-title');
        const sales = DataStore.getList('sales');
        const returnsList = DataStore.getList('returns');
        const expenses = DataStore.getList('expenses');
        const purchases = DataStore.getList('purchases');

        // defaults: current month
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        if(fromEl && !fromEl.value) fromEl.value = firstDay.toISOString().slice(0,10);
        if(toEl && !toEl.value) toEl.value = today.toISOString().slice(0,10);
        if(grpEl && !grpEl.value) grpEl.value = 'day';

        // Safe date parsing for mixed formats (ISO yyyy-mm-dd or dd/mm/yyyy from ar-SA with Arabic-Indic digits)
        const parseDate = (d)=>{
            if(!d) return new Date();
            if(d instanceof Date) return d;
            if(typeof d === 'string'){
                // normalize Arabic-Indic digits and strip RTL marks
                const mapDigits = (str)=> str
                    .replace(/[\u0660-\u0669]/g, (ch)=> String(ch.charCodeAt(0)-0x0660))
                    .replace(/[\u06F0-\u06F9]/g, (ch)=> String(ch.charCodeAt(0)-0x06F0))
                    .replace(/[\u200E\u200F\u061C]/g, '');
                const s0 = mapDigits(d.trim());
                if(/\d{4}-\d{2}-\d{2}/.test(s0)) return new Date(s0);
                const m = s0.match(/(\d{1,2})[\.\/\-](\d{1,2})[\.\/\-](\d{2,4})/);
                if(m){
                    const dd = parseInt(m[1],10), mm = parseInt(m[2],10)-1, yy = parseInt(m[3].length===2?('20'+m[3]):m[3],10);
                    return new Date(yy, mm, dd);
                }
            }
            return new Date();
        };
        const fmtKey = (d, g)=> g==='month' ? d.toISOString().slice(0,7) : d.toISOString().slice(0,10);

        const render = ()=>{
            if(!tblBody) return;
            const from = parseDate(fromEl?.value||firstDay.toISOString().slice(0,10));
            const to = new Date(parseDate(toEl?.value||today.toISOString().slice(0,10)).getTime()+24*60*60*1000-1);
            const g = grpEl?.value||'day';
            const t = (typeof typeEl!=='undefined' && typeEl) ? (typeEl.value||'summary') : 'summary';

            // aggregate maps
            const agg = new Map();
            const add = (dateInput, field, val)=>{
                const d = parseDate(dateInput);
                if(!(d>=from && d<=to)) return;
                const key = fmtKey(d, g);
                if(!agg.has(key)) agg.set(key, { sales:0, returns:0, expenses:0, purchases:0, salesCount:0, returnsCount:0, purchasesCount:0 });
                agg.get(key)[field] += Number(val||0);
            };

            sales.forEach(s=> { const d=parseDate(s.dateISO||s.date||today); add(d, 'sales', s.total||0); const k=fmtKey(d,g); if(agg.has(k)) agg.get(k).salesCount += 1; });
            returnsList.forEach(r=> { const d=parseDate(r.dateISO||r.date||today); add(d, 'returns', r.amount||0); const k=fmtKey(d,g); if(agg.has(k)) agg.get(k).returnsCount += 1; });
            expenses.forEach(e=> { const d=parseDate(e.dateISO||e.date||today); add(d, 'expenses', e.amount||0); });
            const purchases = DataStore.getList('purchases');
            purchases.forEach(p=> { const d=parseDate(p.dateISO||p.date||today); add(d, 'purchases', p.total||0); const k=fmtKey(d,g); if(agg.has(k)) agg.get(k).purchasesCount += 1; });

            const keys = Array.from(agg.keys()).sort();
            tblBody.innerHTML = '';
            let totalSales=0, totalReturns=0, totalExpenses=0, totalPurchases=0;
            const chartLabels = []; const chartValues=[]; let chartLabel='الصافي';

            // dynamic header/title
            if(typeof tblHead!=='undefined' && tblHead){
                if(t==='summary'){
                    tblHead.innerHTML = '<tr><th>الفترة</th><th>المبيعات</th><th>المرتجعات</th><th>المصروفات</th><th>الصافي</th></tr>';
                    if(tblTitle) tblTitle.textContent = 'تفصيل حسب النوع';
                } else if(t==='sales'){
                    tblHead.innerHTML = '<tr><th>الفترة</th><th>المبيعات</th><th>عدد الفواتير</th></tr>';
                    if(tblTitle) tblTitle.textContent = 'تفصيل المبيعات'; chartLabel='المبيعات';
                } else if(t==='returns'){
                    tblHead.innerHTML = '<tr><th>الفترة</th><th>المرتجعات</th><th>عدد المرتجعات</th></tr>';
                    if(tblTitle) tblTitle.textContent = 'تفصيل المرتجعات'; chartLabel='المرتجعات';
                } else if(t==='purchases'){
                    tblHead.innerHTML = '<tr><th>الفترة</th><th>المشتريات</th><th>عدد الفواتير</th></tr>';
                    if(tblTitle) tblTitle.textContent = 'تفصيل المشتريات'; chartLabel='المشتريات';
                } else if(t==='expenses'){
                    tblHead.innerHTML = '<tr><th>الفترة</th><th>المصروفات</th><th>عدد العمليات</th></tr>';
                    if(tblTitle) tblTitle.textContent = 'تفصيل المصروفات'; chartLabel='المصروفات';
                } else if(t==='profit'){
                    tblHead.innerHTML = '<tr><th>الفترة</th><th>المبيعات</th><th>المرتجعات</th><th>المشتريات</th><th>المصروفات</th><th>الربح الصافي</th></tr>';
                    if(tblTitle) tblTitle.textContent = 'تقرير الربح والخسارة'; chartLabel='الربح الصافي';
                } else if(t==='inventory'){
                    tblHead.innerHTML = '<tr><th>الوصف</th><th>القيمة</th></tr>';
                    if(tblTitle) tblTitle.textContent = 'تقرير المخزون (قيمة حالية)'; chartLabel='قيمة المخزون';
                } else if(t==='payments'){
                    tblHead.innerHTML = '<tr><th>الفترة</th><th>نقد</th><th>بطاقة</th><th>أخرى</th><th>الإجمالي</th></tr>';
                    if(tblTitle) tblTitle.textContent = 'تفصيل طرق الدفع'; chartLabel='إجمالي المبيعات';
                } else if(t==='credit-sales'){
                    tblHead.innerHTML = '<tr><th>الفترة</th><th>مبيعات أجل</th><th>عدد الفواتير</th></tr>';
                    if(tblTitle) tblTitle.textContent = 'بيع أجل'; chartLabel='أجل المبيعات';
                } else if(t==='receivables'){
                    tblHead.innerHTML = '<tr><th>العميل</th><th>إجمالي مستحق</th><th>عدد فواتير</th></tr>';
                    if(tblTitle) tblTitle.textContent = 'ذمم العملاء'; chartLabel='الذمم';
                } else if(t==='credit-purchases'){
                    tblHead.innerHTML = '<tr><th>الفترة</th><th>مشتريات أجل</th><th>عدد الفواتير</th></tr>';
                    if(tblTitle) tblTitle.textContent = 'مشتريات أجل'; chartLabel='أجل المشتريات';
                } else if(t==='payables'){
                    tblHead.innerHTML = '<tr><th>المورد</th><th>إجمالي مستحق</th><th>عدد فواتير</th></tr>';
                    if(tblTitle) tblTitle.textContent = 'ذمم الموردين'; chartLabel='الذمم';
                } else if(t==='transactions'){
                    tblHead.innerHTML = '<tr><th>التاريخ</th><th>النوع</th><th>الطرف</th><th>طريقة الدفع</th><th>الحالة</th><th>الإجمالي</th></tr>';
                    if(tblTitle) tblTitle.textContent = 'تفاصيل المعاملات'; chartLabel='الإجمالي';
                }
            }

            if(t==='inventory'){
                const products = DataStore.getProducts();
                const stockValue = products.reduce((s,p)=> s + Number(p.stock||0)*Number(p.price||0), 0);
                tblBody.innerHTML = `<tr><td>القيمة الحالية للمخزون</td><td class="fw-700">${fmt(stockValue)}</td></tr>`;
                chartLabels.push('الآن'); chartValues.push(stockValue);
            } else if(t==='receivables'){
                // ذمم العملاء ضمن الفترة
                const isCredit = (pm='', st='')=> /أجل|credit/i.test(String(pm||'')) || /غير مدفوعة|unpaid/i.test(String(st||''));
                const byCust = new Map();
                sales.forEach(s=>{
                    const d=parseDate(s.dateISO||s.date||today); if(!(d>=from && d<=to)) return;
                    if(isCredit(s.paymentMethod, s.status)){
                        const cust = s.customer || 'عميل';
                        if(!byCust.has(cust)) byCust.set(cust,{amount:0,count:0});
                        const rec = byCust.get(cust); rec.amount += Number(s.total||0); rec.count += 1; byCust.set(cust, rec);
                    }
                });
                tblBody.innerHTML='';
                Array.from(byCust.entries()).forEach(([cust, rec])=>{
                    tblBody.innerHTML += `<tr><td>${cust}</td><td class=\"fw-700\">${fmt(rec.amount)}</td><td>${rec.count}</td></tr>`;
                    chartLabels.push(cust); chartValues.push(rec.amount);
                });
            } else if(t==='payables'){
                // ذمم الموردين ضمن الفترة
                const isCredit = (pm='', st='')=> /أجل|credit/i.test(String(pm||'')) || /غير مدفوعة|unpaid/i.test(String(st||''));
                const bySup = new Map();
                (purchases||[]).forEach(p=>{
                    const d=parseDate(p.dateISO||p.date||today); if(!(d>=from && d<=to)) return;
                    if(isCredit(p.paymentMethod, p.status)){
                        const sup = p.supplier || 'مورد';
                        if(!bySup.has(sup)) bySup.set(sup,{amount:0,count:0});
                        const rec = bySup.get(sup); rec.amount += Number(p.total||p.amount||0); rec.count += 1; bySup.set(sup, rec);
                    }
                });
                tblBody.innerHTML='';
                Array.from(bySup.entries()).forEach(([sup, rec])=>{
                    tblBody.innerHTML += `<tr><td>${sup}</td><td class=\"fw-700\">${fmt(rec.amount)}</td><td>${rec.count}</td></tr>`;
                    chartLabels.push(sup); chartValues.push(rec.amount);
                });
            } else if(t==='transactions'){
                // تفاصيل المعاملات (بيع/شراء/مصروف/مرتجع) ضمن الفترة
                const tx = [];
                // المبيعات
                sales.forEach(s=>{
                    const d=parseDate(s.dateISO||s.date||today); if(!(d>=from && d<=to)) return;
                    tx.push({ d, dateStr: (s.dateISO && String(s.dateISO).slice(0,10)) || s.date || new Date().toLocaleDateString('ar-SA'), kind:'بيع', party:(s.customer||'عميل'), pm:(s.paymentMethod||'-'), st:(s.status||'-'), amt:Number(s.total||0) });
                });
                // المشتريات
                (purchases||[]).forEach(p=>{
                    const d=parseDate(p.dateISO||p.date||today); if(!(d>=from && d<=to)) return;
                    tx.push({ d, dateStr: (p.dateISO && String(p.dateISO).slice(0,10)) || p.date || new Date().toLocaleDateString('ar-SA'), kind:'شراء', party:(p.supplier||'مورد'), pm:(p.paymentMethod||'-'), st:(p.status||'-'), amt:Number(p.total||p.amount||0) });
                });
                // المصروفات
                (expensesList||expenses||[]).forEach(e=>{
                    const d=parseDate(e.dateISO||e.date||today); if(!(d>=from && d<=to)) return;
                    tx.push({ d, dateStr: (e.dateISO && String(e.dateISO).slice(0,10)) || e.date || new Date().toLocaleDateString('ar-SA'), kind:'مصروف', party:(e.category||'مصروف'), pm:'-', st:'-', amt:Number(e.amount||0) });
                });
                // المرتجعات (قيمة سالبة)
                (returns||returnsList||[]).forEach(r=>{
                    const d=parseDate(r.dateISO||r.date||today); if(!(d>=from && d<=to)) return;
                    tx.push({ d, dateStr: (r.dateISO && String(r.dateISO).slice(0,10)) || r.date || new Date().toLocaleDateString('ar-SA'), kind:'مرتجع', party:(r.customer||'عميل'), pm:(r.paymentMethod||'-'), st:(r.status||'-'), amt:-Math.abs(Number(r.amount||0)) });
                });
                tx.sort((a,b)=> a.d - b.d);
                tblBody.innerHTML='';
                tx.forEach(ti=>{
                    tblBody.innerHTML += `<tr><td>${ti.dateStr}</td><td>${ti.kind}</td><td>${ti.party}</td><td>${ti.pm}</td><td>${ti.st}</td><td class=\"fw-700\">${fmt(ti.amt)}</td></tr>`;
                    chartLabels.push(ti.dateStr); chartValues.push(ti.amt);
                });
            } else {
                keys.forEach(k=>{
                    const row = agg.get(k);
                    const net = Number(row.sales) - Number(row.returns) - Number(row.expenses);
                    totalSales += row.sales; totalReturns += row.returns; totalExpenses += row.expenses; totalPurchases += row.purchases;
                    if(t==='summary'){
                        tblBody.innerHTML += `<tr><td>${k}</td><td class="fw-700">${fmt(row.sales)}</td><td>${fmt(row.returns)}</td><td>${fmt(row.expenses)}</td><td class="fw-700">${fmt(net)}</td></tr>`;
                        chartLabels.push(k); chartValues.push(net);
                    } else if(t==='sales'){
                        tblBody.innerHTML += `<tr><td>${k}</td><td class="fw-700">${fmt(row.sales)}</td><td>${row.salesCount||0}</td></tr>`;
                        chartLabels.push(k); chartValues.push(Number(row.sales||0));
                    } else if(t==='returns'){
                        tblBody.innerHTML += `<tr><td>${k}</td><td class="fw-700">${fmt(row.returns)}</td><td>${row.returnsCount||0}</td></tr>`;
                        chartLabels.push(k); chartValues.push(Number(row.returns||0));
                    } else if(t==='purchases'){
                        tblBody.innerHTML += `<tr><td>${k}</td><td class="fw-700">${fmt(row.purchases)}</td><td>${row.purchasesCount||0}</td></tr>`;
                        chartLabels.push(k); chartValues.push(Number(row.purchases||0));
                    } else if(t==='expenses'){
                        const count = row.expenses>0 ? 1 : 0;
                        tblBody.innerHTML += `<tr><td>${k}</td><td class="fw-700">${fmt(row.expenses)}</td><td>${count}</td></tr>`;
                        chartLabels.push(k); chartValues.push(Number(row.expenses||0));
                    } else if(t==='profit'){
                        const netProfitRow = Number(row.sales) - Number(row.returns) - Number(row.purchases) - Number(row.expenses);
                        tblBody.innerHTML += `<tr><td>${k}</td><td>${fmt(row.sales)}</td><td>${fmt(row.returns)}</td><td>${fmt(row.purchases)}</td><td>${fmt(row.expenses)}</td><td class="fw-700">${fmt(netProfitRow)}</td></tr>`;
                        chartLabels.push(k); chartValues.push(netProfitRow);
                    } else if(t==='payments'){
                        const groupSales = sales.filter(s=>{ const d=parseDate(s.dateISO||s.date||today); return d>=from && d<=to && fmtKey(d,g)===k; });
                        const isCard = (pm='')=> /card|visa|mada|credit|بطاق|مدى|فيزا|ماستر/i.test(String(pm||''));
                        const isCash = (pm='')=> /cash|نقد/i.test(String(pm||''));
                        const sum = (arr)=> arr.reduce((a,x)=> a + Number(x.total||0), 0);
                        const cash = sum(groupSales.filter(s=> isCash(s.paymentMethod)));
                        const card = sum(groupSales.filter(s=> isCard(s.paymentMethod)));
                        const other = Math.max(0, sum(groupSales) - cash - card);
                        const total = cash + card + other;
                        tblBody.innerHTML += `<tr><td>${k}</td><td>${fmt(cash)}</td><td>${fmt(card)}</td><td>${fmt(other)}</td><td class=\"fw-700\">${fmt(total)}</td></tr>`;
                        chartLabels.push(k); chartValues.push(total);
                    } else if(t==='credit-sales'){
                        const groupSales = sales.filter(s=>{ const d=parseDate(s.dateISO||s.date||today); return d>=from && d<=to && fmtKey(d,g)===k; });
                        const isCredit = (pm='', st='')=> /أجل|credit/i.test(String(pm||'')) || /غير مدفوعة|unpaid/i.test(String(st||''));
                        const creditList = groupSales.filter(s=> isCredit(s.paymentMethod, s.status));
                        const totalCredit = creditList.reduce((a,x)=> a + Number(x.total||0), 0);
                        tblBody.innerHTML += `<tr><td>${k}</td><td class=\"fw-700\">${fmt(totalCredit)}</td><td>${creditList.length}</td></tr>`;
                        chartLabels.push(k); chartValues.push(totalCredit);
                    } else if(t==='credit-purchases'){
                        const groupPurch = (purchases||[]).filter(p=>{ const d=parseDate(p.dateISO||p.date||today); return d>=from && d<=to && fmtKey(d,g)===k; });
                        const isCredit = (pm='', st='')=> /أجل|credit/i.test(String(pm||'')) || /غير مدفوعة|unpaid/i.test(String(st||''));
                        const creditList = groupPurch.filter(p=> isCredit(p.paymentMethod, p.status));
                        const totalCredit = creditList.reduce((a,x)=> a + Number(x.total||x.amount||0), 0);
                        tblBody.innerHTML += `<tr><td>${k}</td><td class=\"fw-700\">${fmt(totalCredit)}</td><td>${creditList.length}</td></tr>`;
                        chartLabels.push(k); chartValues.push(totalCredit);
                    }
                });
            }

            // KPIs
            const netProfit = totalSales - totalReturns - totalExpenses;
            const setTxt = (id, v)=>{ const el=document.getElementById(id); if(el) el.textContent = fmt(v); };
            // Always update totals; for أنواع فردية سيُستخدم KPI المناسب بصريًا
            setTxt('rpt-total-sales', totalSales);
            setTxt('rpt-total-returns', totalReturns);
            setTxt('rpt-total-expenses', totalExpenses);
            setTxt('rpt-net-profit', netProfit);

            // Chart
            try {
                const cs = getComputedStyle(document.documentElement);
                const colorAccent = (cs.getPropertyValue('--accent')||'#4F46E5').trim();
                const ctx = document.getElementById('rptSalesChart').getContext('2d');
                if(window.__rptChart){ window.__rptChart.destroy(); }
                window.__rptChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels: chartLabels, datasets: [{ label: chartLabel, data: chartValues, borderColor: colorAccent, backgroundColor: colorAccent, fill: false, tension: .25 }]},
                    options: { responsive: true, plugins:{ tooltip:{ callbacks:{ label:(c)=> `${fmt(c.raw)}` } } }, scales:{ y:{ beginAtZero:true } } }
                });
            } catch {}
        };

        render();
        if(applyBtn){ applyBtn.onclick = ()=> render(); }
        if(typeEl){ typeEl.onchange = ()=> render(); }
        if(grpEl){ grpEl.onchange = ()=> render(); }
    }

    function exportReportsToExcel(){
        try{
            const tbody = document.querySelector('#rpt-table tbody');
            const rows = Array.from(tbody?.querySelectorAll('tr')||[]).map(tr=> Array.from(tr.children).map(td=> td.textContent.trim()));
            const thead = document.querySelector('#rpt-table thead');
            const header = thead ? Array.from(thead.querySelectorAll('th')).map(th=> th.textContent.trim()) : ['الفترة','القيمة'];
            const ws = XLSX.utils.aoa_to_sheet([header, ...rows]);
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Reports');
            XLSX.writeFile(wb, `reports_${new Date().toISOString().slice(0,10)}.xlsx`);
            showToast('تم تصدير التقارير إلى Excel');
        }catch(e){ console.error(e); showNotification('خطأ في التصدير','تعذر تصدير التقارير.','error'); }
    }

    function printReports(){
        try{
            const area = document.getElementById('invoice-print-area');
            const tableHtml = document.getElementById('rpt-table').outerHTML;
            const kpi = `
                <div style="display:flex; gap:10px; margin-bottom:8px;">
                    <div><strong>المبيعات:</strong> <span>${document.getElementById('rpt-total-sales')?.textContent||'0'}</span></div>
                    <div><strong>المرتجعات:</strong> <span>${document.getElementById('rpt-total-returns')?.textContent||'0'}</span></div>
                    <div><strong>المصروفات:</strong> <span>${document.getElementById('rpt-total-expenses')?.textContent||'0'}</span></div>
                    <div><strong>الصافي:</strong> <span>${document.getElementById('rpt-net-profit')?.textContent||'0'}</span></div>
                </div>`;
            const title = document.getElementById('rpt-table-title')?.textContent || 'تقرير ملخص الفترة';
            area.innerHTML = `<div style="direction:rtl; font-family:'Cairo',sans-serif;">
                <h3>${title}</h3>${kpi}${tableHtml}
            </div>`;
            setTimeout(()=> window.print(), 50);
        }catch(e){ console.error(e); showNotification('خطأ','تعذر الطباعة.','error'); }
    }

    // ====== Vouchers Page (Unified Receive/Make Payment) ======
    function switchVoucherTab(type, btn){
        document.querySelectorAll('.vouchers-page .tab').forEach(t=> t.classList.remove('active'));
        document.querySelectorAll('.vouchers-page .tab-content').forEach(c=> c.style.display='none');
        btn.classList.add('active');
        if(type==='receive'){ document.getElementById('receive-tab').style.display='block'; }
        else if(type==='pay'){ document.getElementById('pay-tab').style.display='block'; }
    }

    // ====== Vouchers History Page ======
    function switchHistoryTab(type, btn){
        document.querySelectorAll('.vouchers-history-page .tabs .tab').forEach(t=> t.classList.remove('active'));
        document.querySelectorAll('.vouchers-history-page .tab-content').forEach(c=> c.style.display='none');
        btn.classList.add('active');
        if(type==='receipts'){ document.getElementById('receipts-history-tab').style.display='block'; }
        else if(type==='payments'){ document.getElementById('payments-history-tab').style.display='block'; }
        else if(type==='report'){ document.getElementById('report-history-tab').style.display='block'; }
    }

    function initializeVouchersHistory(){
        try{
            const receipts = JSON.parse(localStorage.getItem('receipts')||'[]')||[];
            const payments = JSON.parse(localStorage.getItem('supplier_payments')||'[]')||[];
            
            const renderReceipts = (filter={})=>{
                const tbody = document.querySelector('#receipts-history-table tbody');
                if(!tbody) return;
                let data = [...receipts].reverse();
                if(filter.search){
                    const q = filter.search.toLowerCase();
                    data = data.filter(r=> String(r.id).includes(q) || (r.customer||'').toLowerCase().includes(q));
                }
                if(filter.from) data = data.filter(r=> (r.dateISO||'') >= filter.from);
                if(filter.to) data = data.filter(r=> (r.dateISO||'') <= filter.to);
                
                if(data.length===0){
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center muted">لا توجد سجلات</td></tr>';
                    return;
                }
                tbody.innerHTML = data.map(r=>{
                    const allocs = Array.isArray(r.allocations) && r.allocations.length ? r.allocations.map(a=>`#${a.invoiceId}: ${fmt(a.allocated)}`).join('<br>') : '-';
                    return `<tr>
                        <td>#${r.id}</td>
                        <td>${r.dateISO||''} ${r.time||''}</td>
                        <td>${r.customer||''}</td>
                        <td>${fmt(r.amount||0)}</td>
                        <td>${r.paymentMethod==='card'?'بطاقة':'نقد'}</td>
                        <td style="font-size:11px;">${allocs}</td>
                        <td>
                            <button class="btn sm info" onclick='reprintReceipt(${JSON.stringify(r).replace(/'/g,"&#39;")})'>طباعة</button>
                        </td>
                    </tr>`;
                }).join('');
            };
            
            const renderPayments = (filter={})=>{
                const tbody = document.querySelector('#payments-history-table tbody');
                if(!tbody) return;
                let data = [...payments].reverse();
                if(filter.search){
                    const q = filter.search.toLowerCase();
                    data = data.filter(p=> String(p.id).includes(q) || (p.supplier||'').toLowerCase().includes(q));
                }
                if(filter.from) data = data.filter(p=> (p.dateISO||'') >= filter.from);
                if(filter.to) data = data.filter(p=> (p.dateISO||'') <= filter.to);
                
                if(data.length===0){
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center muted">لا توجد سجلات</td></tr>';
                    return;
                }
                tbody.innerHTML = data.map(p=>{
                    const allocs = Array.isArray(p.allocations) && p.allocations.length ? p.allocations.map(a=>`#${a.invoiceId}: ${fmt(a.allocated)}`).join('<br>') : '-';
                    return `<tr>
                        <td>#${p.id}</td>
                        <td>${p.dateISO||''} ${p.time||''}</td>
                        <td>${p.supplier||''}</td>
                        <td>${fmt(p.amount||0)}</td>
                        <td>${p.paymentMethod==='card'?'بطاقة':'نقد'}</td>
                        <td style="font-size:11px;">${allocs}</td>
                        <td>
                            <button class="btn sm danger" onclick='reprintSupplierPayment(${JSON.stringify(p).replace(/'/g,"&#39;")})'>طباعة</button>
                        </td>
                    </tr>`;
                }).join('');
            };
            
            renderReceipts();
            renderPayments();
            
            const searchReceipts = document.getElementById('search-receipts');
            const filterReceiptsFrom = document.getElementById('filter-receipts-from');
            const filterReceiptsTo = document.getElementById('filter-receipts-to');
            if(searchReceipts) searchReceipts.oninput = ()=> renderReceipts({search:searchReceipts.value, from:filterReceiptsFrom.value, to:filterReceiptsTo.value});
            if(filterReceiptsFrom) filterReceiptsFrom.onchange = ()=> renderReceipts({search:searchReceipts.value, from:filterReceiptsFrom.value, to:filterReceiptsTo.value});
            if(filterReceiptsTo) filterReceiptsTo.onchange = ()=> renderReceipts({search:searchReceipts.value, from:filterReceiptsFrom.value, to:filterReceiptsTo.value});
            
            const searchPayments = document.getElementById('search-payments');
            const filterPaymentsFrom = document.getElementById('filter-payments-from');
            const filterPaymentsTo = document.getElementById('filter-payments-to');
            if(searchPayments) searchPayments.oninput = ()=> renderPayments({search:searchPayments.value, from:filterPaymentsFrom.value, to:filterPaymentsTo.value});
            if(filterPaymentsFrom) filterPaymentsFrom.onchange = ()=> renderPayments({search:searchPayments.value, from:filterPaymentsFrom.value, to:filterPaymentsTo.value});
            if(filterPaymentsTo) filterPaymentsTo.onchange = ()=> renderPayments({search:searchPayments.value, from:filterPaymentsFrom.value, to:filterPaymentsTo.value});
            
            window.clearReceiptsFilter = ()=>{
                if(searchReceipts) searchReceipts.value='';
                if(filterReceiptsFrom) filterReceiptsFrom.value='';
                if(filterReceiptsTo) filterReceiptsTo.value='';
                renderReceipts();
            };
            window.clearPaymentsFilter = ()=>{
                if(searchPayments) searchPayments.value='';
                if(filterPaymentsFrom) filterPaymentsFrom.value='';
                if(filterPaymentsTo) filterPaymentsTo.value='';
                renderPayments();
            };
            window.reprintReceipt = (rec)=> printReceipt(rec);
            window.reprintSupplierPayment = (v)=> printSupplierPayment(v);
            
        }catch(e){ console.error(e); }
    }

    function generateVouchersReport(){
        try{
            const from = document.getElementById('report-from')?.value || '';
            const to = document.getElementById('report-to')?.value || '';
            const receipts = JSON.parse(localStorage.getItem('receipts')||'[]')||[];
            const payments = JSON.parse(localStorage.getItem('supplier_payments')||'[]')||[];
            
            const filteredReceipts = receipts.filter(r=> (!from || (r.dateISO||'')>=from) && (!to || (r.dateISO||'')<=to));
            const filteredPayments = payments.filter(p=> (!from || (p.dateISO||'')>=from) && (!to || (p.dateISO||'')<=to));
            
            const totalReceived = filteredReceipts.reduce((sum,r)=> sum+Number(r.amount||0), 0);
            const totalPaid = filteredPayments.reduce((sum,p)=> sum+Number(p.amount||0), 0);
            const netFlow = totalReceived - totalPaid;
            
            const area = document.getElementById('vouchers-report-area');
            if(!area) return;
            
            area.innerHTML = `
                <div class="card">
                    <h3 class="mb-20">ملخص الفترة من ${from||'البداية'} إلى ${to||'النهاية'}</h3>
                    <div class="form-row mb-20">
                        <div class="col-4 text-center">
                            <div class="kpi-card" style="background:var(--success); color:#fff; padding:20px; border-radius:8px;">
                                <div style="font-size:14px; opacity:0.9;">إجمالي القبض</div>
                                <div style="font-size:28px; font-weight:800; margin-top:5px;">${fmt(totalReceived)}</div>
                                <div style="font-size:12px; margin-top:5px;">${filteredReceipts.length} عملية</div>
                            </div>
                        </div>
                        <div class="col-4 text-center">
                            <div class="kpi-card" style="background:var(--danger); color:#fff; padding:20px; border-radius:8px;">
                                <div style="font-size:14px; opacity:0.9;">إجمالي الدفع</div>
                                <div style="font-size:28px; font-weight:800; margin-top:5px;">${fmt(totalPaid)}</div>
                                <div style="font-size:12px; margin-top:5px;">${filteredPayments.length} عملية</div>
                            </div>
                        </div>
                        <div class="col-4 text-center">
                            <div class="kpi-card" style="background:var(--info); color:#fff; padding:20px; border-radius:8px;">
                                <div style="font-size:14px; opacity:0.9;">صافي التدفق</div>
                                <div style="font-size:28px; font-weight:800; margin-top:5px;">${fmt(netFlow)}</div>
                                <div style="font-size:12px; margin-top:5px;">${netFlow>=0?'موجب':'سالب'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="col-6">
                            <h4 class="mb-10">تفاصيل القبض (${filteredReceipts.length})</h4>
                            <div class="table-container" style="max-height:400px; overflow-y:auto;">
                                <table>
                                    <thead><tr><th>التاريخ</th><th>العميل</th><th>المبلغ</th></tr></thead>
                                    <tbody>
                                        ${filteredReceipts.length===0 ? '<tr><td colspan="3" class="text-center muted">لا توجد عمليات</td></tr>' : filteredReceipts.map(r=>`<tr><td>${r.dateISO||''}</td><td>${r.customer||''}</td><td>${fmt(r.amount||0)}</td></tr>`).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="col-6">
                            <h4 class="mb-10">تفاصيل الدفع (${filteredPayments.length})</h4>
                            <div class="table-container" style="max-height:400px; overflow-y:auto;">
                                <table>
                                    <thead><tr><th>التاريخ</th><th>المورد</th><th>المبلغ</th></tr></thead>
                                    <tbody>
                                        ${filteredPayments.length===0 ? '<tr><td colspan="3" class="text-center muted">لا توجد عمليات</td></tr>' : filteredPayments.map(p=>`<tr><td>${p.dateISO||''}</td><td>${p.supplier||''}</td><td>${fmt(p.amount||0)}</td></tr>`).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center mt-20">
                        <button class="btn info" onclick="printVouchersReport()">طباعة التقرير</button>
                    </div>
                </div>
            `;
        }catch(e){ console.error(e); showNotification('خطأ','تعذر إنشاء التقرير.','error'); }
    }

    function printVouchersReport(){
        try{
            const area = document.getElementById('vouchers-report-area');
            if(!area) return;
            const printArea = document.getElementById('invoice-print-area');
            printArea.innerHTML = `<div style="direction:rtl; font-family:'Cairo',sans-serif; padding:20px;">${area.innerHTML}</div>`;
            setTimeout(()=> window.print(), 100);
        }catch(e){ console.error(e); }
    }

    function initializeVouchersPage(){
        try{
            // === Receive Payment Tab ===
            const custSel = document.getElementById('rp-customer');
            const balEl = document.getElementById('rp-balance');
            const amtEl = document.getElementById('rp-amount');
            const tbody = document.querySelector('#rp-invoices tbody');
            const form = document.getElementById('rp-form');
            const customers = DataStore.getList('customers');
            custSel.innerHTML = customers.map(c=> `<option value="${(c.name||'').replace(/"/g,'&quot;')}">${c.name}</option>`).join('');
            const isCredit = (pm='', st='')=> /أجل|credit/i.test(String(pm||'')) || /غير مدفوعة|unpaid|جزئياً/i.test(String(st||''));
            const ensureAmounts = (inv)=>{ inv.paid = Number(inv.paid||0); inv.remaining = ('remaining' in inv)? Number(inv.remaining||0) : Math.max(0, Number(inv.total||0) - inv.paid); if(!inv.status){ inv.status = inv.remaining===0 ? 'مدفوعة' : (inv.paid>0? 'مدفوعة جزئياً' : 'غير مدفوعة'); } };
            const renderInvoices = ()=>{
                const name = custSel.value||'';
                const sales = DataStore.getList('sales').filter(s=> (s.customer||'')===name && isCredit(s.paymentMethod,s.status));
                sales.forEach(ensureAmounts);
                const unpaid = sales.filter(s=> Number(s.remaining||0) > 0).sort((a,b)=> new Date(a.dateISO||a.date||0) - new Date(b.dateISO||b.date||0));
                const totalToAlloc = Number(amtEl.value||0); let left = totalToAlloc; tbody.innerHTML='';
                unpaid.forEach(inv=>{ const can=Math.min(left,Number(inv.remaining||0)); const alloc= totalToAlloc? can:0; left-=alloc; tbody.innerHTML += `<tr><td>${inv.id}</td><td>${(inv.dateISO||inv.date||'').toString().slice(0,10)}</td><td>${fmt(inv.total||0)}</td><td>${fmt(inv.paid||0)}</td><td>${fmt(inv.remaining||0)}</td><td><input type="number" step="0.01" min="0" max="${Number(inv.remaining||0)}" value="${alloc}" data-invoice="${inv.id}" style="width:110px"></td></tr>`; });
                const cust = customers.find(c=> (c.name||'')===name); if(balEl) balEl.textContent = `الرصيد الحالي: ${fmt(cust?.balance||0)}`;
                tbody.querySelectorAll('input[data-invoice]').forEach(inp=>{ inp.oninput = ()=>{ const max=Number(inp.getAttribute('max')||0); let v=Number(inp.value||0); if(v<0)v=0; if(v>max)v=max; inp.value=v.toFixed(2); const sum = Array.from(tbody.querySelectorAll('input[data-invoice]')).reduce((a,x)=> a+Number(x.value||0),0); if(sum>Number(amtEl.value||0)){ const over=sum-Number(amtEl.value||0); inp.value=Math.max(0,v-over).toFixed(2);} }; });
            };
            custSel.onchange = renderInvoices; amtEl.oninput = renderInvoices; if(customers.length){ custSel.value = customers[0].name||''; } renderInvoices();
            form.onsubmit = (e)=>{ e.preventDefault(); try{
                const name=custSel.value||'عميل'; const amt=Number(amtEl.value||0); const pm=document.getElementById('rp-method').value||'cash'; const dt=document.getElementById('rp-date').value||new Date().toISOString().slice(0,10); const note=document.getElementById('rp-note').value||'';
                const allocRows = Array.from(document.querySelectorAll('#rp-invoices tbody input[data-invoice]')||[]);
                const salesList = DataStore.getList('sales'); const allocations=[]; allocRows.forEach(inp=>{ const id=inp.getAttribute('data-invoice'); const al=Number(inp.value||0); if(al>0){ allocations.push({invoiceId:id, allocated:al}); const inv=salesList.find(s=> String(s.id)===String(id)); if(inv){ inv.paid=Number(inv.paid||0)+al; inv.remaining=Math.max(0, Number(inv.total||0)-Number(inv.paid||0)); inv.status=inv.remaining===0?'مدفوعة':'مدفوعة جزئياً'; } } }); DataStore.setList('sales', salesList);
                const customersList = DataStore.getList('customers'); const idx = customersList.findIndex(c=> (c.name||'')===name); let prev=0; if(idx>-1){ prev=Number(customersList[idx].balance||0); customersList[idx].balance = Math.max(0, prev-amt); DataStore.setList('customers', customersList);} const rec={id:Date.now(), time:new Date().toLocaleTimeString('ar-SA'), customer:name, amount:amt, paymentMethod:pm, dateISO:dt, note, prevBalance:prev, newBalance:(idx>-1?customersList[idx].balance:undefined), allocations}; const arr=JSON.parse(localStorage.getItem('receipts')||'[]')||[]; arr.push(rec); localStorage.setItem('receipts', JSON.stringify(arr)); showNotification('تم الحفظ','تم تسجيل عملية قبض.','success'); printReceipt(rec);
            }catch(err){ console.error(err); showNotification('خطأ','تعذر حفظ القبض.','error'); } };

            // === Make Payment Tab ===
            const supSel = document.getElementById('mp-supplier');
            const balEl2 = document.getElementById('mp-balance');
            const amtEl2 = document.getElementById('mp-amount');
            const tbody2 = document.querySelector('#mp-invoices tbody');
            const form2 = document.getElementById('mp-form');
            const suppliers = DataStore.getList('suppliers');
            supSel.innerHTML = suppliers.map(s=> `<option value="${(s.name||'').replace(/"/g,'&quot;')}">${s.name}</option>`).join('');
            const ensureAmounts2 = (inv)=>{ inv.paid = Number(inv.paid||0); inv.remaining = ('remaining' in inv)? Number(inv.remaining||0) : Math.max(0, Number(inv.total||inv.amount||0) - inv.paid); if(!inv.status){ inv.status = inv.remaining===0 ? 'مدفوعة' : (inv.paid>0? 'مدفوعة جزئياً' : 'غير مدفوعة'); } };
            const renderInvoices2 = ()=>{
                const name = supSel.value||'';
                const purchases = DataStore.getList('purchases').filter(p=> (p.supplier||'')===name && isCredit(p.paymentMethod,p.status));
                purchases.forEach(ensureAmounts2);
                const unpaid = purchases.filter(p=> Number(p.remaining||0) > 0).sort((a,b)=> new Date(a.dateISO||a.date||0) - new Date(b.dateISO||b.date||0));
                const totalToAlloc = Number(amtEl2.value||0); let left = totalToAlloc; tbody2.innerHTML='';
                unpaid.forEach(inv=>{ const can=Math.min(left,Number(inv.remaining||0)); const alloc= totalToAlloc? can:0; left-=alloc; tbody2.innerHTML += `<tr><td>${inv.id}</td><td>${(inv.dateISO||inv.date||'').toString().slice(0,10)}</td><td>${fmt(inv.total||inv.amount||0)}</td><td>${fmt(inv.paid||0)}</td><td>${fmt(inv.remaining||0)}</td><td><input type="number" step="0.01" min="0" max="${Number(inv.remaining||0)}" value="${alloc}" data-invoice="${inv.id}" style="width:110px"></td></tr>`; });
                const sup = suppliers.find(s=> (s.name||'')===name); if(balEl2) balEl2.textContent = `الرصيد الحالي: ${fmt(sup?.balance||0)}`;
                tbody2.querySelectorAll('input[data-invoice]').forEach(inp=>{ inp.oninput = ()=>{ const max=Number(inp.getAttribute('max')||0); let v=Number(inp.value||0); if(v<0)v=0; if(v>max)v=max; inp.value=v.toFixed(2); const sum = Array.from(tbody2.querySelectorAll('input[data-invoice]')).reduce((a,x)=> a+Number(x.value||0),0); if(sum>Number(amtEl2.value||0)){ const over=sum-Number(amtEl2.value||0); inp.value=Math.max(0,v-over).toFixed(2);} }; });
            };
            supSel.onchange = renderInvoices2; amtEl2.oninput = renderInvoices2; if(suppliers.length){ supSel.value = suppliers[0].name||''; } renderInvoices2();
            form2.onsubmit = (e)=>{ e.preventDefault(); try{
                const name=supSel.value||'مورد'; const amt=Number(amtEl2.value||0); const pm=document.getElementById('mp-method').value||'cash'; const dt=document.getElementById('mp-date').value||new Date().toISOString().slice(0,10); const note=document.getElementById('mp-note').value||'';
                const allocRows = Array.from(document.querySelectorAll('#mp-invoices tbody input[data-invoice]')||[]);
                const purchasesList = DataStore.getList('purchases'); const allocations=[]; allocRows.forEach(inp=>{ const id=inp.getAttribute('data-invoice'); const al=Number(inp.value||0); if(al>0){ allocations.push({invoiceId:id, allocated:al}); const inv=purchasesList.find(p=> String(p.id)===String(id)); if(inv){ inv.paid=Number(inv.paid||0)+al; inv.remaining=Math.max(0, Number(inv.total||inv.amount||0)-Number(inv.paid||0)); inv.status=inv.remaining===0?'مدفوعة':'مدفوعة جزئياً'; } } }); DataStore.setList('purchases', purchasesList);
                const suppliersList = DataStore.getList('suppliers'); const idx = suppliersList.findIndex(s=> (s.name||'')===name); let prev=0; if(idx>-1){ prev=Number(suppliersList[idx].balance||0); suppliersList[idx].balance = Math.max(0, prev-amt); DataStore.setList('suppliers', suppliersList);} const v={id:Date.now(), time:new Date().toLocaleTimeString('ar-SA'), supplier:name, amount:amt, paymentMethod:pm, dateISO:dt, note, prevBalance:prev, newBalance:(idx>-1?suppliersList[idx].balance:undefined), allocations}; const arr=JSON.parse(localStorage.getItem('supplier_payments')||'[]')||[]; arr.push(v); localStorage.setItem('supplier_payments', JSON.stringify(arr)); showNotification('تم الحفظ','تم تسجيل عملية دفع.','success'); printSupplierPayment(v);
            }catch(err){ console.error(err); showNotification('خطأ','تعذر حفظ الدفع.','error'); } };
        }catch(e){ console.error(e); }
    }

    function initializeActivity() {
        console.log('Activity Page Initialized.');
        const tbody = document.querySelector('#activity-log-table tbody');
        if(!tbody) return; tbody.innerHTML='';
        const acts = DataStore.getList('activity');
        if(acts.length===0){ tbody.innerHTML = `<tr><td colspan="4" class="text-center muted">لا يوجد نشاط.</td></tr>`; return; }
        const wrapper = document.querySelector('.activity-page .card');
        let pagerEl = wrapper?.querySelector('.pager');
        if(wrapper && !pagerEl){ const tbl = wrapper.querySelector('.table-container'); if(tbl){ tbl.insertAdjacentHTML('beforeend', '<div class="pager"></div>'); } pagerEl = wrapper.querySelector('.pager'); }
        let page = 1; let pageSize = Number(localStorage.getItem('ultimate_pageSize_activity')||20); let current = acts.slice();
        const renderPaged = (list)=>{
            tbody.innerHTML='';
            const sorted = list.slice().reverse();
            const start=(page-1)*pageSize; const pageItems = sorted.slice(start, start+pageSize);
            pageItems.forEach(a=>{
                tbody.innerHTML += `
                    <tr>
                        <td>${a.datetime}</td>
                        <td>${a.user}</td>
                        <td>${a.action}</td>
                        <td>${a.page}</td>
                    </tr>
                `;
            });
            if(pagerEl){ renderPager(pagerEl, list.length, page, pageSize, (p)=>{ page=p; renderPaged(current); }, (sz)=>{ pageSize=sz; page=1; renderPaged(current); }); }
        };
        renderPaged(current);
        const searchInput = document.querySelector('.activity-page .card input[type="text"]');
        if(searchInput){
            searchInput.oninput = (e)=>{
                const q=(e.target.value||'').toLowerCase();
                current = acts.filter(a=> (a.user||'').toLowerCase().includes(q) || (a.action||'').toLowerCase().includes(q) || (a.page||'').toLowerCase().includes(q) || (a.datetime||'').includes(q));
                page = 1; renderPaged(current);
            };
        }
    }

    function loadMoreActivity(){
        const tbody = document.querySelector('#activity-log-table tbody');
        if(!tbody) return;
        window.__activityShown = (window.__activityShown||20) + 20;
        initializeActivity();
    }

    function clearActivityLog(){
        if(!confirm('مسح سجل النشاط بالكامل؟')) return;
        DataStore.setList('activity', []);
        initializeActivity();
        showToast('تم مسح سجل النشاط');
    }

    function logActivity(action, page){
        try{
            const acts = DataStore.getList('activity');
            acts.push({ datetime: new Date().toLocaleString('ar-SA'), user: currentUser?.name || '-', action, page });
            DataStore.setList('activity', acts);
        }catch(e){ console.warn('logActivity failed', e); }
    }

    function initializeSettings() {
        console.log('Settings Page Initialized.');
        const settings = DataStore.load('settings', { taxRate: 0.15, discountFixed: 10, companyName: 'المتجر', address: '', phone: '', vatNumber: '', currency: 'SAR', logo: '', printType: 'thermal', invoiceFooter: 'شكراً لزيارتكم، نتطلع لرؤيتكم مجدداً!' });
        const taxEl = document.getElementById('setting-tax-rate');
        const discEl = document.getElementById('setting-discount-fixed');
        const nameEl = document.getElementById('setting-company-name');
        const addrEl = document.getElementById('setting-address');
        const phoneEl = document.getElementById('setting-phone');
        const vatEl = document.getElementById('setting-vat');
        const currEl = document.getElementById('setting-currency');
        const logoEl = document.getElementById('setting-logo');
        const printTypeEl = document.getElementById('setting-print-type');
        const footerEl = document.getElementById('setting-invoice-footer');
        if(taxEl) taxEl.value = settings.taxRate;
        if(discEl) discEl.value = settings.discountFixed;
        if(nameEl) nameEl.value = settings.companyName||'';
        if(addrEl) addrEl.value = settings.address||'';
        if(phoneEl) phoneEl.value = settings.phone||'';
        if(vatEl) vatEl.value = settings.vatNumber||'';
        if(currEl) currEl.value = settings.currency||'SAR';
        if(logoEl) logoEl.value = settings.logo||'';
        if(printTypeEl) printTypeEl.value = settings.printType||'thermal';
        if(footerEl) footerEl.value = settings.invoiceFooter||'';
        const btn = document.getElementById('btn-save-settings');
        if(btn){
            btn.onclick = ()=>{
                const newSettings = {
                    taxRate: Number((document.getElementById('setting-tax-rate')?.value)||settings.taxRate||0),
                    discountFixed: Number((document.getElementById('setting-discount-fixed')?.value)||settings.discountFixed||0),
                    companyName: (document.getElementById('setting-company-name')?.value)||settings.companyName||'المتجر',
                    address: (document.getElementById('setting-address')?.value)||settings.address||'',
                    phone: (document.getElementById('setting-phone')?.value)||settings.phone||'',
                    vatNumber: (document.getElementById('setting-vat')?.value)||settings.vatNumber||'',
                    currency: (document.getElementById('setting-currency')?.value)||settings.currency||'SAR',
                    logo: (document.getElementById('setting-logo')?.value)||settings.logo||'',
                    printType: (document.getElementById('setting-print-type')?.value)||settings.printType||'thermal',
                    invoiceFooter: (document.getElementById('setting-invoice-footer')?.value)||settings.invoiceFooter||''
                };
                DataStore.save('settings', newSettings);
                showNotification('تم الحفظ', 'تم حفظ إعدادات المتجر والضرائب والخصم.', 'success');
                if(document.getElementById('page-pos')?.classList.contains('active')) renderCart();
            };
        }
        const btnPrint = document.getElementById('btn-save-print-settings');
        if(btnPrint){
            btnPrint.onclick = ()=>{
                const s = DataStore.load('settings', {});
                s.printType = document.getElementById('setting-print-type')?.value || s.printType || 'thermal';
                s.invoiceFooter = document.getElementById('setting-invoice-footer')?.value || s.invoiceFooter || '';
                DataStore.save('settings', s);
                showNotification('تم الحفظ', 'تم حفظ إعدادات الطباعة.', 'success');
            };
        }
    }
    
    function printInvoice(invoiceId) {
        const printArea = document.getElementById('invoice-print-area');
        const settings = DataStore.load('settings', { taxRate: 0.15, discountFixed: 10, companyName: 'متجري', invoiceFooter: '' });
        const sale = DataStore.getList('sales').find(s=> String(s.id)===String(invoiceId));
        const items = sale?.items||[];
        const subtotal = items.reduce((a,it)=> a + Number(it.price||0)*Number(it.qty||0), 0);
        const discount = Number(settings.discountFixed||0);
        const taxable = Math.max(0, subtotal - discount);
        const tax = taxable * Number(settings.taxRate||0);
        const total = taxable + tax;
        const rows = items.map(it=>`<tr><td>${it.name}</td><td>${it.qty}</td><td>${fmt(it.price)}</td><td>${fmt(Number(it.price)*Number(it.qty))}</td></tr>`).join('');
        const details = rows || `<tr><td colspan="4" class="text-center muted">لا توجد بنود</td></tr>`;
        // Prepare content for thermal printer simulation
        printArea.innerHTML = `
            <div style="direction: rtl; font-family: 'Cairo', sans-serif; padding: 10px; max-width: 80mm; margin: 0 auto; line-height: 1.4;">
                <h3 style="text-align: center; margin-bottom: 5px;">${settings.companyName || 'المتجر'}</h3>
                <p style="text-align: center; font-size: 0.8rem; margin-bottom: 10px;">فاتورة مبسطة</p>
                <div style="border-top: 1px dashed black; padding-top: 5px; margin-bottom: 5px;">
                    <div style="display: flex; justify-content: space-between; font-size: 0.9rem;">
                        <strong>رقم الفاتورة:</strong> <span>#${invoiceId}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 0.9rem;">
                        <strong>التاريخ:</strong> <span>${new Date().toLocaleDateString('ar-SA')}</span>
                    </div>
                </div>
                <table style="width:100%; font-size:0.85rem;">
                    <thead><tr><th>المنتج</th><th>الكمية</th><th>السعر</th><th>الإجمالي</th></tr></thead>
                    <tbody>${details}</tbody>
                </table>
                <div style="border-top: 1px dashed black; margin-top:6px; padding-top:6px; font-size:0.9rem;">
                    <div style="display:flex; justify-content:space-between; "><span>الإجمالي الفرعي</span><strong>${fmt(subtotal)}</strong></div>
                    <div style="display:flex; justify-content:space-between; "><span>الخصم</span><strong>${fmt(discount)}</strong></div>
                    <div style="display:flex; justify-content:space-between; "><span>الضريبة (${Number(settings.taxRate||0)*100}%)</span><strong>${fmt(tax)}</strong></div>
                    <div style="display:flex; justify-content:space-between; font-weight:800; "><span>الإجمالي النهائي</span><strong>${fmt(total)}</strong></div>
                </div>
                <div style="text-align:center; font-size:0.8rem; margin-top:10px;">${settings.invoiceFooter||'شكراً لتعاملكم معنا'}</div>
            </div>
        `;
        // Allow DOM to paint before invoking print to avoid blank pages
        setTimeout(()=> { window.print(); setTimeout(closeModal, 300); }, 100);
    }

    // Print Invoice formatted for A4 paper
    function printInvoiceA4(invoiceId){
        const printArea = document.getElementById('invoice-print-area');
        const settings = DataStore.load('settings', { taxRate: 0.15, discountFixed: 10, companyName: 'متجري', invoiceFooter: '' });
        const sale = DataStore.getList('sales').find(s=> String(s.id)===String(invoiceId));
        const items = sale?.items||[];
        const subtotal = items.reduce((a,it)=> a + Number(it.price||0)*Number(it.qty||0), 0);
        const discount = Number(settings.discountFixed||0);
        const taxable = Math.max(0, subtotal - discount);
        const tax = taxable * Number(settings.taxRate||0);
        const total = taxable + tax;
        const rows = items.map(it=>`<tr><td>${it.name}</td><td style="text-align:center;">${it.qty}</td><td style="text-align:left;">${fmt(it.price)}</td><td style="text-align:left;">${fmt(Number(it.price)*Number(it.qty))}</td></tr>`).join('');
        const details = rows || `<tr><td colspan="4" class="text-center muted">لا توجد بنود</td></tr>`;
        printArea.innerHTML = `
            <div style="direction: rtl; font-family: 'Cairo', sans-serif; padding: 12mm; max-width: 210mm; margin: 0 auto; color:#000;">
                <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:10px;">
                    <div>
                        <h3 style="margin:0 0 6px 0; font-size:20px;">${settings.companyName || 'المتجر'}</h3>
                        <div style="font-size:12px; color:#444;">فاتورة ضريبية مبسطة</div>
                    </div>
                    <div style="text-align:left; font-size:12px;">
                        <div><strong>رقم الفاتورة:</strong> #${invoiceId}</div>
                        <div><strong>التاريخ:</strong> ${new Date().toLocaleDateString('ar-SA')}</div>
                    </div>
                </div>
                <table style="width:100%; border-collapse:collapse; margin-top:8px;">
                    <thead>
                        <tr>
                            <th style="text-align:right;">المنتج</th>
                            <th style="text-align:center; width:80px;">الكمية</th>
                            <th style="text-align:left; width:120px;">السعر</th>
                            <th style="text-align:left; width:140px;">الإجمالي</th>
                        </tr>
                    </thead>
                    <tbody>${details}</tbody>
                </table>
                <div style="display:flex; justify-content:flex-end; margin-top:10px;">
                    <table style="min-width:260px; border-collapse:collapse;">
                        <tr><td>الإجمالي الفرعي</td><td style="text-align:left;"><strong>${fmt(subtotal)}</strong></td></tr>
                        <tr><td>الخصم</td><td style="text-align:left;"><strong>${fmt(discount)}</strong></td></tr>
                        <tr><td>الضريبة (${Number(settings.taxRate||0)*100}%)</td><td style="text-align:left;"><strong>${fmt(tax)}</strong></td></tr>
                        <tr><td style="font-weight:800;">الإجمالي النهائي</td><td style="text-align:left; font-weight:800;">${fmt(total)}</td></tr>
                    </table>
                </div>
                <div style="text-align:center; font-size:12px; margin-top:12px;">${settings.invoiceFooter||'شكراً لتعاملكم معنا'}</div>
            </div>
        `;
        // Allow DOM to paint before invoking print to avoid blank pages
        setTimeout(()=> { window.print(); setTimeout(closeModal, 300); }, 100);
    }


    // ========== NEW FEATURES: KEYBOARD SHORTCUTS ==========
    function toggleShortcuts(){
        const overlay = document.getElementById('shortcuts-overlay');
        if(overlay) overlay.style.display = overlay.style.display==='none' ? 'block' : 'none';
    }

    function toggleQuickStats(){
        const overlay = document.getElementById('quick-stats-overlay');
        const content = document.getElementById('quick-stats-content');
        if(overlay.style.display==='none'){
            // Generate quick stats
            const sales = DataStore.getList('sales');
            const products = DataStore.getProducts();
            const customers = DataStore.getList('customers');
            const receipts = JSON.parse(localStorage.getItem('receipts')||'[]')||[];
            const payments = JSON.parse(localStorage.getItem('supplier_payments')||'[]')||[];
            
            const today = new Date().toISOString().slice(0,10);
            const todaySales = sales.filter(s=> s.dateISO===today);
            const totalToday = todaySales.reduce((sum,s)=> sum+Number(s.total||0), 0);
            const totalReceipts = receipts.reduce((sum,r)=> sum+Number(r.amount||0), 0);
            const totalPayments = payments.reduce((sum,p)=> sum+Number(p.amount||0), 0);
            const lowStock = products.filter(p=> Number(p.stock||0) < Number(p.reorder||0));
            const totalBalance = customers.reduce((sum,c)=> sum+Number(c.balance||0), 0);
            
            content.innerHTML = `
                <div class="form-row mb-20">
                    <div class="col-3 text-center">
                        <div style="background:var(--gradient-success); color:#fff; padding:20px; border-radius:12px; box-shadow:var(--shadow-lg);">
                            <div style="font-size:14px; opacity:0.9;">مبيعات اليوم</div>
                            <div style="font-size:32px; font-weight:800; margin-top:8px;">${fmt(totalToday)}</div>
                            <div style="font-size:12px; margin-top:5px;">${todaySales.length} عملية</div>
                        </div>
                    </div>
                    <div class="col-3 text-center">
                        <div style="background:var(--gradient-info); color:#fff; padding:20px; border-radius:12px; box-shadow:var(--shadow-lg);">
                            <div style="font-size:14px; opacity:0.9;">إجمالي القبض</div>
                            <div style="font-size:32px; font-weight:800; margin-top:8px;">${fmt(totalReceipts)}</div>
                            <div style="font-size:12px; margin-top:5px;">${receipts.length} عملية</div>
                        </div>
                    </div>
                    <div class="col-3 text-center">
                        <div style="background:var(--gradient-danger); color:#fff; padding:20px; border-radius:12px; box-shadow:var(--shadow-lg);">
                            <div style="font-size:14px; opacity:0.9;">إجمالي الدفع</div>
                            <div style="font-size:32px; font-weight:800; margin-top:8px;">${fmt(totalPayments)}</div>
                            <div style="font-size:12px; margin-top:5px;">${payments.length} عملية</div>
                        </div>
                    </div>
                    <div class="col-3 text-center">
                        <div style="background:var(--gradient-warning); color:#fff; padding:20px; border-radius:12px; box-shadow:var(--shadow-lg);">
                            <div style="font-size:14px; opacity:0.9;">أرصدة العملاء</div>
                            <div style="font-size:32px; font-weight:800; margin-top:8px;">${fmt(totalBalance)}</div>
                            <div style="font-size:12px; margin-top:5px;">${customers.length} عميل</div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h4>⚠️ منتجات أقل من حد إعادة الطلب (${lowStock.length})</h4>
                    ${lowStock.length===0 ? '<p class="muted">جميع المنتجات في مستويات آمنة ✅</p>' : `
                        <div class="table-container">
                            <table>
                                <thead><tr><th>المنتج</th><th>الكمية</th><th>حد الطلب</th></tr></thead>
                                <tbody>
                                    ${lowStock.map(p=>`<tr><td>${p.name}</td><td><span class="chip danger">${p.stock||0}</span></td><td>${p.reorder||0}</td></tr>`).join('')}
                                </tbody>
                            </table>
                        </div>
                    `}
                </div>
            `;
            overlay.style.display = 'block';
        } else {
            overlay.style.display = 'none';
        }
    }

    // ========== EXPORT/IMPORT & BACKUP ==========
    function exportAllData(){
        try{
            const data = {
                products: DataStore.getList('products'),
                categories: DataStore.getList('categories'),
                customers: DataStore.getList('customers'),
                suppliers: DataStore.getList('suppliers'),
                sales: DataStore.getList('sales'),
                purchases: DataStore.getList('purchases'),
                receipts: JSON.parse(localStorage.getItem('receipts')||'[]'),
                supplier_payments: JSON.parse(localStorage.getItem('supplier_payments')||'[]'),
                settings: DataStore.load('settings', {}),
                exportDate: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showNotification('تم التصدير', 'تم تصدير جميع البيانات بنجاح.', 'success');
        }catch(e){ console.error(e); showNotification('خطأ', 'تعذر التصدير.', 'error'); }
    }

    function importData(){
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = (e)=>{
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (ev)=>{
                try{
                    const data = JSON.parse(ev.target.result);
                    if(confirm('هل أنت متأكد من استيراد البيانات؟ سيتم استبدال البيانات الحالية.')){
                        if(data.products) DataStore.setList('products', data.products);
                        if(data.categories) DataStore.setList('categories', data.categories);
                        if(data.customers) DataStore.setList('customers', data.customers);
                        if(data.suppliers) DataStore.setList('suppliers', data.suppliers);
                        if(data.sales) DataStore.setList('sales', data.sales);
                        if(data.purchases) DataStore.setList('purchases', data.purchases);
                        if(data.receipts) localStorage.setItem('receipts', JSON.stringify(data.receipts));
                        if(data.supplier_payments) localStorage.setItem('supplier_payments', JSON.stringify(data.supplier_payments));
                        if(data.settings) DataStore.save('settings', data.settings);
                        showNotification('تم الاستيراد', 'تم استيراد البيانات بنجاح. سيتم إعادة تحميل الصفحة.', 'success');
                        setTimeout(()=> location.reload(), 2000);
                    }
                }catch(e){ console.error(e); showNotification('خطأ', 'ملف غير صالح.', 'error'); }
            };
            reader.readAsText(file);
        };
        input.click();
    }

    // ========== ENHANCED CONFIRMATION DIALOG ==========
    function confirmDialog(message, onConfirm, onCancel){
        if(confirm(message)){
            if(onConfirm) onConfirm();
        } else {
            if(onCancel) onCancel();
        }
    }

    // ========== GLOBAL KEYBOARD SHORTCUTS ==========
    document.addEventListener('keydown', (e)=>{
        // Show shortcuts: ?
        if(e.key==='?' && !e.ctrlKey && !e.shiftKey){
            e.preventDefault();
            toggleShortcuts();
        }
        // Quick stats: Ctrl+Shift+S
        if(e.ctrlKey && e.shiftKey && e.key==='S'){
            e.preventDefault();
            toggleQuickStats();
        }
        // Export: Ctrl+Shift+E
        if(e.ctrlKey && e.shiftKey && e.key==='E'){
            e.preventDefault();
            exportAllData();
        }
        // Import: Ctrl+Shift+I
        if(e.ctrlKey && e.shiftKey && e.key==='I'){
            e.preventDefault();
            importData();
        }
    });

    // ========== INITIALIZE APP ON LOAD ==========

    document.addEventListener('DOMContentLoaded', () => {
        UI.loadTheme();
        App.initNavigation();
        App.navigateTo('dashboard'); // Start on the dashboard page
        // Show welcome notification
        setTimeout(() => {
            showNotification('مرحباً بعودتك', `لقد سجلت الدخول بصلاحية: ${currentUser.role}`, 'info');
        }, 1500);
        // Register Service Worker for PWA/offline support (HTTPS or localhost only)
        try {
            if ('serviceWorker' in navigator) {
                const isLocal = location.hostname === 'localhost' || location.hostname === '127.0.0.1' || location.protocol === 'http:';
                if (window.isSecureContext || isLocal) {
                    navigator.serviceWorker.register('sw.js');
                }
            }
        } catch (e) {}
    });

  </script>

</body>

</html>